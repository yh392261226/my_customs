### Package Desc: Gitç‰ˆæœ¬æ§åˆ¶å·¥å…·ç›¸å…³


function check_is_git() {                                                               # Desc: function: check_is_git:éªŒè¯æ˜¯å¦æ˜¯gitç‰ˆæœ¬åº“
    git rev-parse HEAD > /dev/null 2>&1
}
alias isgit="check_is_git"                                                              # Desc: alias: isgit: check_is_gitå‘½ä»¤çš„åˆ«å,éªŒè¯æ˜¯å¦æ˜¯gitç‰ˆæœ¬åº“

function auto_create_git_respository() {                                                # Desc: function: auto_create_git_respository: è‡ªåŠ¨åˆ›å»ºç‰ˆæœ¬åº“
	local ACTIONPATH="${1:-$PWD}"
    mkdir $ACTIONPATH
	cd $ACTIONPATH
	git init
	touch README.md
	git add README.md
	git commit -m 'è‡ªåŠ¨åˆ›å»ºç‰ˆæœ¬åº“'
    local GITPATHNAME=$(echo $ACTIONPATH | sed 's,/,_,g')
	git remote add origin git@github.com:yh392261226/$GITPATHNAME.git
	git push origin master
}
alias acgr="auto_create_git_respository"                                                # Desc: alias: acgr: auto_create_git_respositoryå‘½ä»¤çš„åˆ«å,è‡ªåŠ¨åˆ›å»ºç‰ˆæœ¬åº“

function fzf_git_checkout_branch() {                                                    # Desc: function: fzf_git_checkout_branch:checkout git branch
    local branches branch
    branches=$(git branch --all | grep -v HEAD) &&
        branch=$(echo "$branches" |
    fzf $FZF_CUSTOM_PARAMS --preview='$MYRUNTIME/customs/bin/_previewer {}' --header="$(_buildFzfHeader '' 'fzf_git_checkout_branch')" -d $(( 2 + $(wc -l <<< "$branches") )) +m) &&
        git checkout $(echo "$branch" | sed "s/.* //" | sed "s#remotes/[^/]*/##")
}
alias fcb="fzf_git_checkout_branch"                                                     # Desc: alias: fcb:fzf_git_checkout_branchå‘½ä»¤çš„åˆ«å,checkout git branch

function fzf_git_checkout_commit() {                                                    # Desc: function: fzf_git_checkout_commit:checkout git commit
    local commits commit
    commits=$(git log --pretty=oneline --abbrev-commit --reverse) &&
    commit=$(echo "$commits" | fzf --tac +s +m -e $FZF_CUSTOM_PARAMS \
--preview " echo {2} " \
--bind 'focus:transform-preview-label:echo -n "[ {1} ]";' \
--bind 'f12:execute-silent(echo -n {1}| pbcopy)+abort' \
--header="$(_buildFzfHeader '' 'fzf_git_checkout_commit')" \
) &&
    git checkout $(echo "$commit" | sed "s/ .*//")
}
alias fgcc="fzf_git_checkout_commit"                                                    # Desc: alias: fgcc:fzf_git_checkout_commitå‘½ä»¤çš„åˆ«å,checkout git commit

function fzf_git_checkout_preview() {                                                   # Desc: function: fzf_git_checkout_preview:checkout git branch/tag, with a preview showing the commits between the tag/branch and HEAD
    local tags branches target
    tags=$(
    git tag | awk '{print "\x1b[31;1mtag\x1b[m\t" $1}') || return
    branches=$(
    git branch --all | grep -v HEAD |
    sed "s/.* //" | sed "s#remotes/[^/]*/##" |
    sort -u | awk '{print "\x1b[34;1mbranch\x1b[m\t" $1}') || return
    target=$(
    (echo "$tags"; echo "$branches") |
    fzf --no-hscroll --no-multi --delimiter="\t" -n 2 --ansi $FZF_CUSTOM_PARAMS \
--preview-window right:70%:rounded:hidden:wrap \
--preview="git log -200 --pretty=format:%s $(echo {+2..} |  sed 's/$/../' )" \
--bind 'focus:transform-preview-label:echo -n "[ {2} ]";' \
--bind 'f12:execute-silent(echo -n {2}| pbcopy)+abort' \
--header="$(_buildFzfHeader '' 'fzf_git_checkout_preview')" \
        ) || return
    git checkout $(echo "$target" | awk '{print $2}')
}
alias fgcp="fzf_git_checkout_preview"                                                   # Desc: alias: fgcp:fzf_git_checkout_previewå‘½ä»¤çš„åˆ«å,checkout git branch/tag, with a preview showing the commits between the tag/branch and HEAD

function fzf_git_commit_sha() {                                                         # Desc: function: fzf_git_commit_sha:get git commit sha. example usage: git rebase -i `fcs`
    local commits commit
    commits=$(git log --color=always --pretty=oneline --abbrev-commit --reverse) &&
    commit=$(echo "$commits" | fzf --tac +s +m -e --ansi $FZF_CUSTOM_PARAMS --preview " echo {2} " --bind 'focus:transform-preview-label:echo -n "[ {1} ]";' --bind 'f12:execute-silent(echo -n {1}| pbcopy)+abort' --header="$(_buildFzfHeader '' 'fzf_git_commit_sha')") &&
    echo -n $(echo "$commit" | sed "s/ .*//")
}
alias fgcs="fzf_git_commit_sha"                                                         # Desc: alias: fgcs:fzf_git_commit_shaå‘½ä»¤çš„åˆ«å,get git commit sha. example usage: git rebase -i `fcs`

function fzf_git_checkout() {                                                           # Desc: function: fzf_git_checkout:checkout git branch/tag
    local tags branches target
    tags=$(
    git tag | awk '{print "\x1b[31;1mtag\x1b[m\t" $1}') || return
    branches=$(
    git branch --all | grep -v HEAD             |
    sed "s/.* //"    | sed "s#remotes/[^/]*/##" |
    sort -u          | awk '{print "\x1b[34;1mbranch\x1b[m\t" $1}') || return
    target=$(
    (echo "$tags"; echo "$branches") |
    fzf $FZF_CUSTOM_PARAMS --preview='$MYRUNTIME/customs/bin/_previewer {}' --header="$(_buildFzfHeader '' 'fzf_git_checkout')" -l30 -- --no-hscroll --ansi +m -d "\t" -n 2) || return
    git checkout $(echo "$target" | awk '{print $2}')
}
alias fgc="fzf_git_checkout"                                                            # Desc: alias: fgc:fzf_git_checkoutå‘½ä»¤çš„åˆ«å,checkout git branch/tag

function fzf_git_checkout2() {                                                          # Desc: function: fzf_git_checkout2:checkout git branch
    if git rev-parse --git-dir > /dev/null 2>&1; then
        if [[ "$#" -eq 0 ]]; then
            local branches branch
            branches=$(git branch -a) &&
            branch=$(echo "$branches" |
            fzf $FZF_CUSTOM_PARAMS --preview='$MYRUNTIME/customs/bin/_previewer {}' --header="$(_buildFzfHeader '' 'fzf_git_checkout2')" -d $(( 2 + $(wc -l <<< "$branches") )) +m) &&
            git checkout $(echo "$branch" | sed "s/.* //" | sed "s#remotes/[^/]*/##")
        elif [ `git rev-parse --verify --quiet $*` ] || \
             [ `git branch --remotes | grep  --extended-regexp "^[[:space:]]+origin/${*}$"` ]; then
            echo "Checking out to existing branch"
            git checkout "$*"
        else
            echo "Creating new branch"
            git checkout -b "$*"
        fi
    else
        echo "Can't check out or create branch. Not in a git repo"
    fi
}
alias fgc2="fzf_git_checkout2"                                                          # Desc: alias: fgc2:fzf_git_checkout2å‘½ä»¤çš„åˆ«å,checkout git branch

function fzf_git_branch_with_remote() {                                                 # Desc: function: fzf_git_branch_with_remote: checkout git branch (including remote branches), sorted by most recent commit, limit 30 last branches
  local branches branch
  branches=$(git for-each-ref --count=30 --sort=-committerdate refs/heads/ --format="%(refname:short)") &&
  branch=$(echo "$branches" |
           fzf-tmux -d $(( 2 + $(wc -l <<< "$branches") )) +m) &&
  git checkout $(echo "$branch" | sed "s/.* //" | sed "s#remotes/[^/]*/##")
}
alias fbr="fzf_git_branch_with_remote"                                                  # Desc: alias: fbr:fzf_git_branch_with_remoteå‘½ä»¤çš„åˆ«å,checkout git branch (including remote branches), sorted by most recent commit, limit 30 last branches

function fzf_git_stash() {                                                              # Desc: function: fzf_git_stash:Easier way to deal with stashes. type fstash to get a list of your stashes. enter shows you the contents of the stash. ctrl-d shows a diff of the stash against your current HEAD. ctrl-b checks the stash out as a branch, for easier merging
    local out q k sha
    while out=$(
    git stash list --pretty="%C(yellow)%h %>(14)%Cgreen%cr %C(blue)%gs" |
    fzf $FZF_CUSTOM_PARAMS \
    --ansi \
    --no-sort \
    --query="$q" \
    --print-query \
    --expect=ctrl-d,ctrl-b \
    --header="$(_buildFzfHeader '' 'fzf_git_stash')" \
        );
    do
    mapfile -t out <<< "$out"
    q="${out[0]}"
    k="${out[1]}"
    sha="${out[-1]}"
    sha="${sha%% *}"
    [[ -z "$sha" ]] && continue
    if [[ "$k" == 'ctrl-d' ]]; then
        git diff $sha
    elif [[ "$k" == 'ctrl-b' ]]; then
        git stash branch "stash-$sha" $sha
        break;
    else
        git stash show -p $sha
    fi
    done
}
alias fgsh="fzf_git_stash"                                                              # Desc: alias: fgsh:fzf_git_stashå‘½ä»¤çš„åˆ«å,Easier way to deal with stashes. type fgsh to get a list of your stashes. enter shows you the contents of the stash. ctrl-d shows a diff of the stash against your current HEAD. ctrl-b checks the stash out as a branch, for easier merging

function fzf_git_status() {                                                             # Desc: function: fzf_git_status: æ˜¾ç¤ºå½“å‰gitçš„çŠ¶æ€,å¹¶ç”¨ç¼–è¾‘æ‰“å¼€é€‰æ‹©çš„æ–‡ä»¶
  git rev-parse --git-dir > /dev/null 2>&1 || {
    echo "You are not in a git repository" && return
  }
  local selected
  selected=$(git -c color.status=always status --short |
      fzf "$@" --border -m --ansi --nth 2..,.. $FZF_CUSTOM_PARAMS \
--preview-window right:70%:rounded:hidden:wrap \
--preview '(git diff --color=always -- {-1} | sed 1,4d; cat {-1}) | head -500' \
--bind 'focus:transform-preview-label:echo -n "[ {1} ]";' \
--bind 'f12:execute-silent(echo -n {-1}| pbcopy)+abort' \
--header="$(_buildFzfHeader '' 'fzf_git_status')" \
      | cut -c4- | sed 's/.* -> //')
    if [[ $selected ]]; then
        for prog in $(echo $selected); do
		$EDITOR $prog; 
	done;
    fi
}
alias fgs="fzf_git_status"                                                              # Desc: alias: fgs:fzf_git_statusçš„åˆ«å,æ˜¾ç¤ºå½“å‰gitçš„çŠ¶æ€,å¹¶ç”¨ç¼–è¾‘æ‰“å¼€é€‰æ‹©çš„æ–‡ä»¶

function fzf_git_untracked() {                                                          # Desc: function: fzf_git_untracked:æ˜¾ç¤ºå½“å‰gitç‰ˆæœ¬åº“ä¸­æœªæ·»åŠ è¿›ç‰ˆæœ¬çš„ä¿®æ”¹æˆ–æ–°å¢æ–‡ä»¶åˆ—è¡¨
    check_is_git || return

    local cmd="${FZF_CTRL_T_COMMAND:-"command git status -s"}"

    eval "$cmd" | FZF_DEFAULT_OPTS="--height ${FZF_TMUX_HEIGHT:-60%} \
    --reverse $FZF_DEFAULT_OPTS $FZF_CTRL_T_OPTS" \
    fzf -m "$@" $FZF_CUSTOM_PARAMS \
--preview " echo {2} " \
--bind 'focus:transform-preview-label:echo -n "[ {1} ]";' \
--bind 'f12:execute-silent(echo -n {2}| pbcopy)+abort' \
--header="$(_buildFzfHeader '' 'fzf_git_untracked')" \
    | while read -r item; do
    echo "$item" | awk '{print $2}'
    done
    echo
}
alias fgu="fzf_git_untracked"                                                           # Desc: alias: fgu:fzf_git_untrackedå‘½ä»¤çš„åˆ«å,æ˜¾ç¤ºå½“å‰gitç‰ˆæœ¬åº“ä¸­æœªæ·»åŠ è¿›ç‰ˆæœ¬çš„ä¿®æ”¹æˆ–æ–°å¢æ–‡ä»¶åˆ—è¡¨

function fzf_git_commit_browser() {                                                     # Desc: function: fzf_git_commit_browser:git commit browser
git log --graph --color=always \
    --format="%C(auto)%h%d %s %C(black)%C(bold)%cr" "$@" | fzf --ansi \
--no-sort $FZF_CUSTOM_PARAMS \
--tiebreak=index \
--bind 'focus:transform-preview-label:echo -n "[ {2} ]";' \
--bind 'f12:execute-silent(echo -n {2}| pbcopy)+abort' \
--bind "ctrl-m:execute:(grep -o '[a-f0-9]\{7\}' | head -1 | xargs -I % sh -c 'git show --color=always % | delta') << 'FZF-EOF'
{}" \
--header="$(_buildFzfHeader '' 'fzf_git_commit_browser')"
}
alias fgcb="fzf_git_commit_browser"                                                     # Desc: alias: fgcb: fzf_git_commit_browserå‘½ä»¤çš„åˆ«å,git commit browser

function fzf_gitlog_multi() {                                                           # Desc: function: fzf_gitlog_multi: åˆ©ç”¨fzfåˆ—å‡ºgit log,é€‰ä¸­åç›´æ¥æ˜¾ç¤º
  local git_cmd
  local fzf_cmd

  git_cmd='git log \
    --all \
    --graph \
    --date-order \
    --format=format:"%C(auto)%s %d %h %C(cyan)%cd %C(bold black)%an %C(auto)" \
    --date=short \
    --color=always'

  fzf_cmd='fzf $FZF_CUSTOM_PARAMS \
    --height 100% \
    --multi \
    --ansi \
    --reverse \
    --no-sort \
    --tiebreak=index \
    --header="$(_buildFzfHeader \"\" \"fzf_gitlog_multi\")" \
    --preview="echo {} | grep -o \"[a-f0-9]\{7\}\" | xargs -I % sh -c \"git show % --color\"" \
    --bind=ctrl-x:toggle-sort'

  eval "$git_cmd | $fzf_cmd" \
    | grep -o '[a-f0-9]\{7\}' \
    | xargs -I % sh -c 'git show % --color' \
    | delta
}
alias fgm='fzf_gitlog_multi'                                                            # Desc: alias: fgm: fzf_gitlog_multiå‘½ä»¤çš„åˆ«å,åˆ©ç”¨fzfåˆ—å‡ºgit log,é€‰ä¸­åç›´æ¥æ˜¾ç¤º

function git_diff_branches() {                                                          # Desc: function: git_diff_branches:Gitæ¯”å¯¹ä¸¤ä¸ªåˆ†æ”¯
    if [ $# -ne 2 ]; then
        echo two branch names required
        return
    fi
    git log --graph \
        --pretty=format:'%Cred%h%Creset -%C(yellow)%d%Creset %s %Cgreen(%cr)%Creset' \
        --abbrev-commit --date=relative $1..$2
}
alias gd2b="git_diff_branches"                                                          # Desc: alias: gd2b:git_diff_brancheså‘½ä»¤çš„åˆ«å,Gitæ¯”å¯¹ä¸¤ä¸ªåˆ†æ”¯

function update_git_files_and_modules() {                                               # Desc: function: update_git_files_and_modules:æ›´æ–°gitçš„ç›®å½•åŠgit moduleçš„ç›®å½•
    local filepath="${1:-$MYRUNTIME}"

    for f in $(/bin/ls $filepath/); do
        if [ -d $filepath/$f/.git ] || [ -f $filepath/$f/.git ]; then
            echo $filepath/$f
            customcd $filepath/$f/ && /usr/bin/git pull
        fi
        if [ -f $filepath/$f/.gitmodules ]; then
            echo $filepath/$f
            customcd $filepath/$f/ && /usr/bin/git submodule update --init --recursive && git submodule update --recursive --remote
            if [ "$(git status --porcelain)" != "" ]; then
                git add .
                git commit -m "Update submodules"
                git push
            fi
        fi
    done
    customcd ~
}
alias upgitfiles="update_git_files_and_modules"                                         # Desc: alias: upgitfiles:update_git_files_and_moduleså‘½ä»¤çš„åˆ«å,æ›´æ–°gitçš„ç›®å½•åŠgit moduleçš„ç›®å½•

function fzf_git_vim_to_line() {                                                        # Desc: function:fzf_git_vim_to_line: Gitç‰ˆæœ¬ä¸­å…¨éƒ¨æ–‡ä»¶å†…å®¹å±•ç¤º,å¹¶åˆ©ç”¨fzfé€‰æ‹©åç”±vimæ‰“å¼€å¹¶å®šä½åˆ°è¡Œ
    git grep --line-number . | fzf --delimiter ':' --nth 3.. $FZF_CUSTOM_PARAMS \
--preview 'bat --color=always {1} --highlight-line {2}' \
--bind 'focus:transform-preview-label:echo -n "[ {1} ]";' \
--bind 'enter:become(vim {1} +{2})' \
--bind 'ctrl-r:execute(vim +{2} {1} < /dev/tty)' \
--bind 'f12:execute-silent(echo -n {1}| pbcopy)+abort' \
--preview-window 'right,70%,rounded,+{2}+3/3,~3' \
--header="$(_buildFzfHeader '' 'fzf_git_vim_to_line')"
}
alias fgitv2l="fzf_git_vim_to_line"                                                     # Desc: alias: fgitv2l: fzf_git_vim_to_lineå‘½ä»¤çš„åˆ«å,Gitç‰ˆæœ¬ä¸­å…¨éƒ¨æ–‡ä»¶å†…å®¹å±•ç¤º,å¹¶åˆ©ç”¨fzfé€‰æ‹©åç”±vimæ‰“å¼€å¹¶å®šä½åˆ°è¡Œ

function fzf_git_modified_diff() {                                                      # Desc: function:fzf_git_modified_diff: åˆ©ç”¨fzfåˆ—å‡ºå½“å‰Gitç‰ˆæœ¬æ–‡ä»¶ä¸­ä¿®æ”¹çš„æ–‡ä»¶å¹¶diff
    git status -s | fzf $FZF_CUSTOM_PARAMS \
    --no-sort \
    --preview 'git diff --color=always {+2} | diff-so-fancy' \
    --bind=ctrl-j:preview-down \
    --bind=ctrl-k:preview-up \
    --preview-window 'right,70%,rounded,+{2}+3/3,~3' \
    --header="$(_buildFzfHeader '' 'fzf_git_modified_diff')"
}
alias fgd='fzf_git_modified_diff'                                                       # Desc: alias: fgd: fzf_git_modified_diffå‘½ä»¤çš„åˆ«å,åˆ©ç”¨fzfåˆ—å‡ºå½“å‰Gitç‰ˆæœ¬æ–‡ä»¶ä¸­ä¿®æ”¹çš„æ–‡ä»¶å¹¶diff

function git_submodule_add() {                                                          # Desc: function:git_submodule_add: Gitç‰ˆæœ¬æ–‡ä»¶ä¸­å¢åŠ å­æ¨¡å—
    check_is_git || return
    if [ $# -ne 2 ]; then
        echo "Usage: git_submodule_add <submodule_name> <git_url>"
        return
    fi
    git submodule add $2 $1
    git commit -m "Add $1 submodule"
    git push
}
alias gsa="git_submodule_add"                                                           # Desc: alias: gsa: git_submodule_addå‘½ä»¤çš„åˆ«å,æ·»åŠ gitå­æ¨¡å—

function git_submodule_remove() {                                                       # Desc: function:git_submodule_remove: Gitç‰ˆæœ¬æ–‡ä»¶ä¸­åˆ é™¤å­æ¨¡å—
    check_is_git || return
    if [ $# -ne 1 ]; then
        echo "Usage: git_submodule_remove <submodule_name>"
        return
    fi
    git submodule deinit $1
    git rm $1
    git commit -m "Remove $1 submodule"
    git push
}
alias gsr="git_submodule_remove"                                                        # Desc: alias: gsr: git_submodule_removeå‘½ä»¤çš„åˆ«å,åˆ é™¤gitå­æ¨¡å—

function git_submodule_remove2() {                                                      # Desc: function:git_submodule_remove2: Gitç‰ˆæœ¬æ–‡ä»¶ä¸­åˆ é™¤å­æ¨¡å—,åŒæ—¶åˆ é™¤æœ¬åœ°æ–‡ä»¶
    check_is_git || return
    if [ $# -ne 1 ]; then
        echo "Usage: git_submodule_remove2 <submodule_name>"
        return
    fi
    git rm --cached -f $1
    rm -rf .git/modules/$1
    git commit -m "Remove $1 submodule"
    rm -rf $1
}
alias gsr2="git_submodule_remove2"                                                      # Desc: alias: gsr2: git_submodule_remove2å‘½ä»¤çš„åˆ«å,åˆ é™¤gitå­æ¨¡å—,åŒæ—¶åˆ é™¤æœ¬åœ°æ–‡ä»¶

function fzf_version_manager() {
    local options=(
        "Git"
        "Svn"
        "Hg"
        "ğŸ”™ è¿”å›"
    )
    $USE_GUM && custom_gum_show2hide_header "ç‰ˆæœ¬ç®¡ç†" || echo -e "ç‰ˆæœ¬ç®¡ç†"
    while true; do
        local selection=$(printf '%s\n' "${options[@]}" | fzf \
            --height=30% \
            --reverse \
            --prompt="â¤ ç‰ˆæœ¬ç®¡ç† > "
        )
        
        case "$selection" in
            "Git")
                git_manager
                ;;
            "Svn")
                svn_manager
                ;;
            "Hg")
                hg_manager
                ;;
            "ğŸ”™ è¿”å›"|*)
                break
                ;;
        esac
    done
}

# ======================================================
# Git ç®¡ç†ä¸»å‡½æ•°
# ======================================================

# ä¸»Gitç®¡ç†å™¨
git_manager() {
#    if ! git rev-parse --is-inside-work-tree >/dev/null 2>&1; then
#        $USE_GUM && gum style --foreground 196 "å½“å‰ç›®å½•ä¸æ˜¯ Git ä»“åº“!" || echo -e "\033[31må½“å‰ç›®å½•ä¸æ˜¯ Git ä»“åº“!\033[0m"
#        sleep 2
#        return
#    fi

    local options=(
        "ä»“åº“ç®¡ç†"
        "å¿«ç…§ç®¡ç†"
        "æäº¤å†å²"
        "åˆ†æ”¯ç®¡ç†"
        "è¿œç¨‹åä½œ"
        "åˆå¹¶ä¸é‡å†™å†å²"
        "ä¸´æ—¶å­˜å‚¨"
        "æ ‡ç­¾ç®¡ç†"
        "é«˜çº§æ“ä½œ"
        "è¯Šæ–­ä¸ç»´æŠ¤"
        "é…ç½®å·¥å…·"
        "åº•å±‚å‘½ä»¤ (Plumbing)"
        "è¾…åŠ©å·¥å…·"
        "â†©ï¸ è¿”å›"
    )

    while true; do
        local repo_name=$(basename "$(git rev-parse --show-toplevel)")
        local current_branch=$(git branch --show-current)
        
        if $USE_GUM; then
            custom_gum_show2hide_header "Git ç®¡ç†å™¨: $(gum style --foreground 212 "$repo_name")"
            custom_gum_show2hide_header "å½“å‰åˆ†æ”¯: $(gum style --foreground 99 "$current_branch")"
        else
            echo -e "Git ç®¡ç†å™¨: $repo_name"
            echo -e "å½“å‰åˆ†æ”¯: \033[1;35m$current_branch\033[0m"
        fi

        local selection=$(printf '%s\n' "${options[@]}" | fzf \
            --height=30% \
            --reverse \
            --prompt="â¤ Git ç®¡ç†å™¨ > "
        )

        case "$selection" in
        *ä»“åº“ç®¡ç†*)
            git_repository_manager
            ;;
        *å¿«ç…§ç®¡ç†*)
            git_snapshot_manager
            ;;
        *æäº¤å†å²*)
            git_commit_history_manager
            ;;
        *åˆ†æ”¯ç®¡ç†*)
            git_branch_manager
            ;;
        *è¿œç¨‹åä½œ*)
            git_remote_manager
            ;;
        *åˆå¹¶ä¸é‡å†™å†å²*)
            git_merge_rebase_manager
            ;;
        *ä¸´æ—¶å­˜å‚¨*)
            git_stash_manager
            ;;
        *æ ‡ç­¾ç®¡ç†*)
            git_tag_manager
            ;;
        *é«˜çº§æ“ä½œ*)
            git_advanced_manager
            ;;
        *è¯Šæ–­ä¸ç»´æŠ¤*)
            git_maintenance_manager
            ;;
        *é…ç½®å·¥å…·*)
            git_config_manager
            ;;
        *åº•å±‚å‘½ä»¤*)
            git_plumbing_manager
            ;;
        *è¾…åŠ©å·¥å…·*)
            git_helper_tools_manager
            ;;
        "â†©ï¸ è¿”å›"|*)
            break
            ;;
        esac
    done
}

# ======================================================
# ä»“åº“ç®¡ç†åŠŸèƒ½
# ======================================================

# ä»“åº“ç®¡ç†
git_repository_manager() {
    local options=(
        "åˆå§‹åŒ–æ–°ä»“åº“(init)"
        "å…‹éš†è¿œç¨‹ä»“åº“(clone)"
        "å¤šå·¥ä½œåŒºç®¡ç†"
        "â†©ï¸ è¿”å›"
    )

    while true; do
        local repo_name=$(basename "$(git rev-parse --show-toplevel)")
        local current_branch=$(git branch --show-current)
        
        if $USE_GUM; then
            custom_gum_show2hide_header "Git ä»“åº“ç®¡ç†: $(gum style --foreground 212 "$repo_name")"
        else
            echo -e "Git ä»“åº“ç®¡ç†: $repo_name"
            echo -e "å½“å‰åˆ†æ”¯: \033[1;35m$current_branch\033[0m"
        fi

        local selection=$(printf '%s\n' "${options[@]}" | fzf \
            --height=30% \
            --reverse \
            --prompt="â¤ Git ä»“åº“ç®¡ç† > "
        )

        case "$selection" in
        *åˆå§‹åŒ–æ–°ä»“åº“*)
            git_init
            ;;
        *å…‹éš†è¿œç¨‹ä»“åº“*)
            git_clone
            ;;
        *å¤šå·¥ä½œåŒºç®¡ç†*)
            git_worktree_manager
            ;;
        "â†©ï¸ è¿”å›"|*)
            break
            ;;
        esac
    done
}

# åˆå§‹åŒ–ä»“åº“
git_init() {
    $USE_GUM && custom_gum_show2hide_header "åˆå§‹åŒ–æ–° Git ä»“åº“" || echo -e "åˆå§‹åŒ–æ–° Git ä»“åº“"
    
    local repo_path=$(user_input "è¯·è¾“å…¥ä»“åº“è·¯å¾„ï¼ˆé»˜è®¤ä¸ºå½“å‰ç›®å½•ï¼‰: " ".")
    
    if [ ! -d "$repo_path" ]; then
        mkdir -p "$repo_path" || {
            $USE_GUM && gum style --foreground 196 "åˆ›å»ºç›®å½•å¤±è´¥!" || echo -e "\033[31måˆ›å»ºç›®å½•å¤±è´¥!\033[0m"
            sleep 2
            return
        }
    fi
    
    if git -C "$repo_path" init; then
        $USE_GUM && gum style --foreground 46 "ä»“åº“åˆå§‹åŒ–æˆåŠŸ!" || echo -e "\033[32mä»“åº“åˆå§‹åŒ–æˆåŠŸ!\033[0m"
    else
        $USE_GUM && gum style --foreground 196 "ä»“åº“åˆå§‹åŒ–å¤±è´¥!" || echo -e "\033[31mä»“åº“åˆå§‹åŒ–å¤±è´¥!\033[0m"
    fi
    sleep 2
}

# å…‹éš†ä»“åº“
git_clone() {
    $USE_GUM && custom_gum_show2hide_header "å…‹éš†è¿œç¨‹ Git ä»“åº“" || echo -e "å…‹éš†è¿œç¨‹ Git ä»“åº“"
    
    local repo_url=$(user_input "è¯·è¾“å…¥è¿œç¨‹ä»“åº“URL: " "")
    if [ -z "$repo_url" ]; then
        $USE_GUM && gum style --foreground 196 "URL ä¸èƒ½ä¸ºç©º!" || echo -e "\033[31mURL ä¸èƒ½ä¸ºç©º!\033[0m"
        sleep 2
        return
    fi
    
    local local_dir=$(user_input "è¯·è¾“å…¥æœ¬åœ°ç›®å½•ï¼ˆé»˜è®¤ä¸ºå½“å‰ç›®å½•ï¼‰: " ".")
    
    if git clone "$repo_url" "$local_dir"; then
        $USE_GUM && gum style --foreground 46 "ä»“åº“å…‹éš†æˆåŠŸ!" || echo -e "\033[32mä»“åº“å…‹éš†æˆåŠŸ!\033[0m"
    else
        $USE_GUM && gum style --foreground 196 "ä»“åº“å…‹éš†å¤±è´¥!" || echo -e "\033[31mä»“åº“å…‹éš†å¤±è´¥!\033[0m"
    fi
    sleep 2
}

# å·¥ä½œåŒºç®¡ç†
git_worktree_manager() {
    local options=(
        "æ·»åŠ å·¥ä½œæ ‘(add <path> <branch>)"
        "åˆ—å‡ºå·¥ä½œæ ‘(list)"
        "ç§»é™¤å·¥ä½œæ ‘(remove)"
        "â†©ï¸ è¿”å›"
    )

    while true; do
        
        local repo_name=$(basename "$(git rev-parse --show-toplevel)")
        
        if $USE_GUM; then
            custom_gum_show2hide_header "Git å¤šå·¥ä½œåŒºç®¡ç†: $(gum style --foreground 212 "$repo_name")"
        else
            echo -e "Git å¤šå·¥ä½œåŒºç®¡ç†: $repo_name"
        fi

        local selection=$(printf '%s\n' "${options[@]}" | fzf \
            --height=30% \
            --reverse \
            --prompt="â¤ Git å·¥ä½œåŒºç®¡ç† > "
        )

        case "$selection" in
        *æ·»åŠ å·¥ä½œæ ‘*)
            local path=$(user_input "è¯·è¾“å…¥å·¥ä½œæ ‘è·¯å¾„: " "")
            local branch=$(user_input "è¯·è¾“å…¥åˆ†æ”¯å: " "")
            
            if [ -n "$path" ] && [ -n "$branch" ]; then
                git worktree add "$path" "$branch"
            else
                $USE_GUM && gum style --foreground 196 "è·¯å¾„å’Œåˆ†æ”¯åä¸èƒ½ä¸ºç©º!" || echo -e "\033[31mè·¯å¾„å’Œåˆ†æ”¯åä¸èƒ½ä¸ºç©º!\033[0m"
            fi
            wait_for_key
            ;;
        *åˆ—å‡ºå·¥ä½œæ ‘*)
            clear
            git worktree list
            wait_for_key
            ;;
        *ç§»é™¤å·¥ä½œæ ‘*)
            local worktrees=$(git worktree list | awk '{print $1}')
            local selected
            
            if $USE_GUM; then
                selected=$(echo "$worktrees" | gum choose --height 10 --cursor.foreground 212 --item.foreground 99 --selected.foreground 212 --prompt "é€‰æ‹©è¦ç§»é™¤çš„å·¥ä½œæ ‘: ")
            else
                selected=$(echo "$worktrees" | fzf --ansi --prompt="é€‰æ‹©è¦ç§»é™¤çš„å·¥ä½œæ ‘> ")
            fi
            
            if [ -n "$selected" ]; then
                git worktree remove "$selected"
            fi
            wait_for_key
            ;;
        "â†©ï¸ è¿”å›"|*)
            break
            ;;
        esac
    done
}

# ======================================================
# å¿«ç…§ç®¡ç†åŠŸèƒ½
# ======================================================

# å¿«ç…§ç®¡ç†
git_snapshot_manager() {
    local options=(
        "æ·»åŠ æ–‡ä»¶åˆ°æš‚å­˜åŒº(add)"
        "äº¤äº’å¼æ·»åŠ (-p)"
        "é‡ç½®å½“å‰çŠ¶æ€(reset)"
        "æ¢å¤æ–‡ä»¶(restore)"
        "åˆ é™¤æ–‡ä»¶(rm)"
        "ç§»åŠ¨/é‡å‘½åæ–‡ä»¶(mv)"
        "æŸ¥çœ‹çŠ¶æ€(status)"
        "â†©ï¸ è¿”å›"
    )

    while true; do
        local repo_name=$(basename "$(git rev-parse --show-toplevel)")
        local current_branch=$(git branch --show-current)
        
        if $USE_GUM; then
            custom_gum_show2hide_header "Git å¿«ç…§ç®¡ç†: $(gum style --foreground 212 "$repo_name")"
            custom_gum_show2hide_header "å½“å‰åˆ†æ”¯: $(gum style --foreground 99 "$current_branch")"
        else
            echo -e "Git å¿«ç…§ç®¡ç†: $repo_name"
            echo -e "å½“å‰åˆ†æ”¯: \033[1;35m$current_branch\033[0m"
        fi

        local selection=$(printf '%s\n' "${options[@]}" | fzf \
            --height=30% \
            --reverse \
            --prompt="â¤ Git å¿«ç…§ç®¡ç† > "
        )

        case "$selection" in
        *æ·»åŠ æ–‡ä»¶*)
            local files
            if $USE_GUM; then
                files=$(git status -s | awk '{print $2}' | gum choose --no-limit --height 10 --cursor.foreground 212 --item.foreground 99 --selected.foreground 212 --prompt "é€‰æ‹©è¦æ·»åŠ çš„æ–‡ä»¶: ")
            else
                files=$(git status -s | awk '{print $2}' | fzf -m --ansi --prompt="é€‰æ‹©è¦æ·»åŠ çš„æ–‡ä»¶> ")
            fi
            
            if [ -n "$files" ]; then
                echo "$files" | xargs git add
            fi
            ;;
        *äº¤äº’å¼æ·»åŠ *)
            git add -p
            ;;
        *é‡ç½®å½“å‰çŠ¶æ€*)
            git_reset_manager
            ;;
        *æ¢å¤æ–‡ä»¶*)
            git_restore_manager
            ;;
        *åˆ é™¤æ–‡ä»¶*)
            local files
            if $USE_GUM; then
                files=$(git ls-files | gum choose --no-limit --height 10 --cursor.foreground 212 --item.foreground 99 --selected.foreground 212 --prompt "é€‰æ‹©è¦åˆ é™¤çš„æ–‡ä»¶: ")
            else
                files=$(git ls-files | fzf -m --ansi --prompt="é€‰æ‹©è¦åˆ é™¤çš„æ–‡ä»¶> ")
            fi
            
            if [ -n "$files" ]; then
                echo "$files" | xargs git rm
            fi
            ;;
        *ç§»åŠ¨/é‡å‘½å*)
            local files
            if $USE_GUM; then
                files=$(git ls-files | gum choose --height 10 --cursor.foreground 212 --item.foreground 99 --selected.foreground 212 --prompt "é€‰æ‹©è¦ç§»åŠ¨çš„æ–‡ä»¶: ")
            else
                files=$(git ls-files | fzf -m --ansi --prompt="é€‰æ‹©è¦ç§»åŠ¨çš„æ–‡ä»¶> ")
            fi
            
            if [ -n "$files" ]; then
                local new_path=$(user_input "è¯·è¾“å…¥æ–°è·¯å¾„: " "")
                git mv "$files" "$new_path"
            fi
            ;;
        *æŸ¥çœ‹çŠ¶æ€*)
            clear
            git -c color.status=always status
            wait_for_key
            ;;
        "â†©ï¸ è¿”å›"|*)
            break
            ;;
        esac
    done
}

# é‡ç½®ç®¡ç†å™¨
git_reset_manager() {
    local options=(
        "åªæ”¹commitä¿¡æ¯(commit --amend)"
        "è½¯é‡ç½®(--soft HEAD^|uncommit)"
        "æ··åˆé‡ç½®(--mixed)"
        "ç¡¬é‡ç½®(--hard)"
        "é‡ç½®ç‰¹å®šæ–‡ä»¶"
        "â†©ï¸ è¿”å›"
    )

    while true; do
        local repo_name=$(basename "$(git rev-parse --show-toplevel)")
        
        if $USE_GUM; then
            custom_gum_show2hide_header "Git é‡ç½®ç®¡ç†: $(gum style --foreground 212 "$repo_name")"
        else
            echo -e "Git é‡ç½®ç®¡ç†: $repo_name"
        fi

        local selection=$(printf '%s\n' "${options[@]}" | fzf \
            --height=30% \
            --reverse \
            --prompt="â¤ Git é‡ç½®ç®¡ç† > "
        )

        case "$selection" in
        *åªæ”¹commitä¿¡æ¯*)
            git commit --amend
            ;;
        *è½¯é‡ç½®*)
            git reset --soft HEAD^
            $USE_GUM && gum style --foreground 46 "è½¯é‡ç½®å®Œæˆ!" || echo -e "\033[32mè½¯é‡ç½®å®Œæˆ!\033[0m"
            sleep 1
            ;;
        *æ··åˆé‡ç½®*)
            git reset --mixed HEAD
            $USE_GUM && gum style --foreground 46 "æ··åˆé‡ç½®å®Œæˆ!" || echo -e "\033[32mæ··åˆé‡ç½®å®Œæˆ!\033[0m"
            sleep 1
            ;;
        *ç¡¬é‡ç½®*)
            if confirm_action "è­¦å‘Š: ç¡¬é‡ç½®å°†ä¸¢å¼ƒæ‰€æœ‰æœªæäº¤çš„æ›´æ”¹! ç¡®å®šæ‰§è¡Œç¡¬é‡ç½®å—?"; then
                git reset --hard HEAD
                $USE_GUM && gum style --foreground 46 "ç¡¬é‡ç½®å®Œæˆ!" || echo -e "\033[32mç¡¬é‡ç½®å®Œæˆ!\033[0m"
            fi
            sleep 1
            ;;
        *é‡ç½®ç‰¹å®šæ–‡ä»¶*)
            local files
            if $USE_GUM; then
                files=$(git diff --name-only --cached | gum choose --no-limit --height 10 --cursor.foreground 212 --item.foreground 99 --selected.foreground 212 --prompt "é€‰æ‹©è¦é‡ç½®çš„æ–‡ä»¶: ")
            else
                files=$(git diff --name-only --cached | fzf -m --ansi --prompt="é€‰æ‹©è¦é‡ç½®çš„æ–‡ä»¶> ")
            fi
            
            if [ -n "$files" ]; then
                git reset HEAD -- $files
            fi
            ;;
        "â†©ï¸ è¿”å›"|*)
            break
            ;;
        esac
    done
}

# æ¢å¤ç®¡ç†å™¨
git_restore_manager() {
    local options=(
        "æ¢å¤å·¥ä½œåŒºæ–‡ä»¶"
        "æ¢å¤æš‚å­˜åŒºæ–‡ä»¶(--staged)"
        "ä»æŒ‡å®šæäº¤æ¢å¤(--source)"
        "â†©ï¸ è¿”å›"
    )

    while true; do
        local repo_name=$(basename "$(git rev-parse --show-toplevel)")
        
        if $USE_GUM; then
            custom_gum_show2hide_header "Git æ¢å¤ç®¡ç†: $(gum style --foreground 212 "$repo_name")"
        else
            echo -e "Git æ¢å¤ç®¡ç†: $repo_name"
        fi

        local selection=$(printf '%s\n' "${options[@]}" | fzf \
            --height=30% \
            --reverse \
            --prompt="â¤ Git æ¢å¤ç®¡ç† > "
        )

        case "$selection" in
        *æ¢å¤å·¥ä½œåŒºæ–‡ä»¶*)
            local files
            if $USE_GUM; then
                files=$(git status -s | awk '/^ M/{print $2}' | gum choose --no-limit --height 10 --cursor.foreground 212 --item.foreground 99 --selected.foreground 212 --prompt "é€‰æ‹©è¦æ¢å¤çš„æ–‡ä»¶: ")
            else
                files=$(git status -s | awk '/^ M/{print $2}' | fzf -m --ansi --prompt="é€‰æ‹©è¦æ¢å¤çš„æ–‡ä»¶> ")
            fi
            
            if [ -n "$files" ]; then
                git restore $files
            fi
            ;;
        *æ¢å¤æš‚å­˜åŒºæ–‡ä»¶*)
            local files
            if $USE_GUM; then
                files=$(git status -s | awk '/^M |^A /{print $2}' | gum choose --no-limit --height 10 --cursor.foreground 212 --item.foreground 99 --selected.foreground 212 --prompt "é€‰æ‹©è¦å–æ¶ˆæš‚å­˜çš„æ–‡ä»¶: ")
            else
                files=$(git status -s | awk '/^M |^A /{print $2}' | fzf -m --ansi --prompt="é€‰æ‹©è¦å–æ¶ˆæš‚å­˜çš„æ–‡ä»¶> ")
            fi
            
            if [ -n "$files" ]; then
                git restore --staged $files
            fi
            ;;
        *ä»æŒ‡å®šæäº¤æ¢å¤*)
            local commit
            if $USE_GUM; then
                commit=$(git log --oneline -n 50 | gum choose --height 15 --cursor.foreground 212 --item.foreground 99 --selected.foreground 212 --prompt "é€‰æ‹©æäº¤: " | awk '{print $1}')
            else
                commit=$(git log --oneline -n 50 | fzf --ansi --prompt="é€‰æ‹©æäº¤> " | awk '{print $1}')
            fi
            
            if [ -n "$commit" ]; then
                local files
                if $USE_GUM; then
                    files=$(git diff --name-only "$commit" | gum choose --no-limit --height 10 --cursor.foreground 212 --item.foreground 99 --selected.foreground 212 --prompt "é€‰æ‹©è¦æ¢å¤çš„æ–‡ä»¶: ")
                else
                    files=$(git diff --name-only "$commit" | fzf -m --ansi --prompt="é€‰æ‹©è¦æ¢å¤çš„æ–‡ä»¶> ")
                fi
                
                if [ -n "$files" ]; then
                    git restore --source="$commit" $files
                fi
            fi
            ;;
        "â†©ï¸ è¿”å›"|*)
            break
            ;;
        esac
    done
}

# ======================================================
# åˆ†æ”¯ç®¡ç†åŠŸèƒ½
# ======================================================

git_branch_manager() {
    local options=(
        "æŸ¥çœ‹æœ¬åœ°åˆ†æ”¯"
        "æŸ¥çœ‹è¿œç¨‹åˆ†æ”¯(-r)"
        "æŸ¥çœ‹æ‰€æœ‰åˆ†æ”¯(-a)"
        "åˆ›å»ºæ–°åˆ†æ”¯"
        "åˆ‡æ¢åˆ†æ”¯"
        "åˆ é™¤æœ¬åœ°åˆ†æ”¯(-d)"
        "å¼ºåˆ¶åˆ é™¤åˆ†æ”¯(-D)"
        "é‡å‘½ååˆ†æ”¯(-m)"
        "è®¾ç½®ä¸Šæ¸¸åˆ†æ”¯(--set-upstream-to)"
        "â†©ï¸ è¿”å›"
    )

    while true; do
        local repo_name=$(basename "$(git rev-parse --show-toplevel)")
        local current_branch=$(git branch --show-current)
        
        if $USE_GUM; then
            custom_gum_show2hide_header "Git åˆ†æ”¯ç®¡ç†: $(gum style --foreground 212 "$repo_name")"
            custom_gum_show2hide_header "å½“å‰åˆ†æ”¯: $(gum style --foreground 99 "$current_branch")"
        else
            echo -e "Git åˆ†æ”¯ç®¡ç†: $repo_name"
            echo -e "å½“å‰åˆ†æ”¯: \033[1;35m$current_branch\033[0m"
        fi
        
        local selection=$(printf '%s\n' "${options[@]}" | fzf \
            --height=30% \
            --reverse \
            --prompt="â¤ Git åˆ†æ”¯ç®¡ç† > "
        )

        case "$selection" in
        *æŸ¥çœ‹æœ¬åœ°åˆ†æ”¯*)
            clear
            git branch -vv
            wait_for_key
            ;;
        *æŸ¥çœ‹è¿œç¨‹åˆ†æ”¯*)
            clear
            git branch -rv
            wait_for_key
            ;;
        *æŸ¥çœ‹æ‰€æœ‰åˆ†æ”¯*)
            clear
            git branch -avv
            wait_for_key
            ;;
        *åˆ›å»ºæ–°åˆ†æ”¯*)
            local branch_name=$(user_input "è¯·è¾“å…¥æ–°åˆ†æ”¯å: " "")
            if [ -n "$branch_name" ]; then
                git branch "$branch_name"
            fi
            ;;
        *åˆ‡æ¢åˆ†æ”¯*)
            local branches=$(git branch | sed 's/^* //' | sort)
            local selected
            
            if $USE_GUM; then
                selected=$(echo "$branches" | gum choose --height 15 --cursor.foreground 212 --item.foreground 99 --selected.foreground 212 --prompt "é€‰æ‹©è¦åˆ‡æ¢çš„åˆ†æ”¯: ")
            else
                selected=$(echo "$branches" | fzf --ansi --prompt="é€‰æ‹©è¦åˆ‡æ¢çš„åˆ†æ”¯> ")
            fi
            
            if [ -n "$selected" ]; then
                git checkout "$selected"
            fi
            ;;
        *åˆ é™¤æœ¬åœ°åˆ†æ”¯*)
            local branches=$(git branch | sed 's/^* //' | sort)
            local selected
            
            if $USE_GUM; then
                selected=$(echo "$branches" | gum choose --no-limit --height 15 --cursor.foreground 212 --item.foreground 99 --selected.foreground 212 --prompt "é€‰æ‹©è¦åˆ é™¤çš„åˆ†æ”¯: ")
            else
                selected=$(echo "$branches" | fzf -m --ansi --prompt="é€‰æ‹©è¦åˆ é™¤çš„åˆ†æ”¯> ")
            fi
            
            if [ -n "$selected" ]; then
                echo "$selected" | xargs git branch -d
            fi
            ;;
        *å¼ºåˆ¶åˆ é™¤åˆ†æ”¯*)
            local branches=$(git branch | sed 's/^* //' | sort)
            local selected
            
            if $USE_GUM; then
                selected=$(echo "$branches" | gum choose --no-limit --height 15 --cursor.foreground 212 --item.foreground 99 --selected.foreground 212 --prompt "é€‰æ‹©è¦å¼ºåˆ¶åˆ é™¤çš„åˆ†æ”¯: ")
            else
                selected=$(echo "$branches" | fzf -m --ansi --prompt="é€‰æ‹©è¦å¼ºåˆ¶åˆ é™¤çš„åˆ†æ”¯> ")
            fi
            
            if [ -n "$selected" ]; then
                echo "$selected" | xargs git branch -D
            fi
            ;;
        *é‡å‘½ååˆ†æ”¯*)
            local current_branch=$(git branch --show-current)
            local new_name=$(user_input "è¯·è¾“å…¥æ–°åˆ†æ”¯å (å½“å‰: $current_branch): " "$current_branch")
            if [ -n "$new_name" ]; then
                git branch -m "$new_name"
            fi
            ;;
        *è®¾ç½®ä¸Šæ¸¸åˆ†æ”¯*)
            local remote_branches=$(git branch -r | sed 's/^ *//')
            local selected
            
            if $USE_GUM; then
                selected=$(echo "$remote_branches" | gum choose --height 15 --cursor.foreground 212 --item.foreground 99 --selected.foreground 212 --prompt "é€‰æ‹©ä¸Šæ¸¸åˆ†æ”¯: ")
            else
                selected=$(echo "$remote_branches" | fzf --ansi --prompt="é€‰æ‹©ä¸Šæ¸¸åˆ†æ”¯> ")
            fi
            
            if [ -n "$selected" ]; then
                git branch --set-upstream-to="$selected"
            fi
            ;;
        "â†©ï¸ è¿”å›"|*)
            break
            ;;
        esac
    done
}

# ======================================================
# æäº¤å†å²ç®¡ç†åŠŸèƒ½
# ======================================================

git_commit_history_manager() {
    local options=(
        "æŸ¥çœ‹æäº¤æ—¥å¿—(log)"
        "ç®€æ´æ¨¡å¼(--oneline)"
        "å›¾å½¢åŒ–æ¨¡å¼(--graph)"
        "æ–‡ä»¶å˜æ›´å†å²(--follow)"
        "æŒ‰å†…å®¹æœç´¢(-S)"
        "å¼•ç”¨æ—¥å¿—(reflog)"
        "å·®å¼‚æ¯”è¾ƒ(diff)"
        "â†©ï¸ è¿”å›"
    )

    while true; do
        local repo_name=$(basename "$(git rev-parse --show-toplevel)")
        local current_branch=$(git branch --show-current)
        
        if $USE_GUM; then
            custom_gum_show2hide_header "Git æäº¤å†å²ç®¡ç†: $(gum style --foreground 212 "$repo_name")"
            custom_gum_show2hide_header "å½“å‰åˆ†æ”¯: $(gum style --foreground 99 "$current_branch")"
        else
            echo -e "Git æäº¤å†å²ç®¡ç†: $repo_name"
            echo -e "å½“å‰åˆ†æ”¯: \033[1;35m$current_branch\033[0m"
        fi

        local selection=$(printf '%s\n' "${options[@]}" | fzf \
            --height=30% \
            --reverse \
            --prompt="â¤ Git æäº¤å†å² > "
        )

        case "$selection" in
        *æŸ¥çœ‹æäº¤æ—¥å¿—*)
            clear
            git -c color.ui=always log
            wait_for_key
            ;;
        *ç®€æ´æ¨¡å¼*)
            clear
            git log --oneline
            wait_for_key
            ;;
        *å›¾å½¢åŒ–æ¨¡å¼*)
            clear
            git log --graph --oneline --all
            wait_for_key
            ;;
        *æ–‡ä»¶å˜æ›´å†å²*)
            local file
            if $USE_GUM; then
                file=$(git ls-files | gum choose --height 15 --cursor.foreground 212 --item.foreground 99 --selected.foreground 212 --prompt "é€‰æ‹©æ–‡ä»¶: ")
            else
                file=$(git ls-files | fzf --ansi --prompt="é€‰æ‹©æ–‡ä»¶> ")
            fi
            
            if [ -n "$file" ]; then
                clear
                git log --follow -- "$file"
                wait_for_key
            fi
            ;;
        *æŒ‰å†…å®¹æœç´¢*)
            local search_string=$(user_input "è¯·è¾“å…¥æœç´¢å†…å®¹: " "")
            if [ -n "$search_string" ]; then
                clear
                git log -S"$search_string"
                wait_for_key
            fi
            ;;
        *å¼•ç”¨æ—¥å¿—*)
            clear
            git reflog
            wait_for_key
            ;;
        *å·®å¼‚æ¯”è¾ƒ*)
            git_diff_manager
            ;;
        "â†©ï¸ è¿”å›"|*)
            break
            ;;
        esac
    done
}

# ======================================================
# å·®å¼‚æ¯”è¾ƒç®¡ç†åŠŸèƒ½
# ======================================================

git_diff_manager() {
    local options=(
        "å·¥ä½œåŒºå·®å¼‚"
        "æš‚å­˜åŒºå·®å¼‚(--cached)"
        "å•è¯çº§å·®å¼‚(--word-diff)"
        "æ¯”è¾ƒä¸¤ä¸ªæäº¤"
        "â†©ï¸ è¿”å›"
    )

    while true; do
        local repo_name=$(basename "$(git rev-parse --show-toplevel)")
        
        if $USE_GUM; then
            custom_gum_show2hide_header "Git å·®å¼‚æ¯”è¾ƒ: $(gum style --foreground 212 "$repo_name")"
        else
            echo -e "Git å·®å¼‚æ¯”è¾ƒ: $repo_name"
        fi

        local selection=$(printf '%s\n' "${options[@]}" | fzf \
            --height=30% \
            --reverse \
            --prompt="â¤ Git å·®å¼‚æ¯”è¾ƒ > "
        )

        case "$selection" in
        *å·¥ä½œåŒºå·®å¼‚*)
            clear
            git diff
            wait_for_key
            ;;
        *æš‚å­˜åŒºå·®å¼‚*)
            clear
            git diff --cached
            wait_for_key
            ;;
        *å•è¯çº§å·®å¼‚*)
            clear
            git diff --word-diff
            wait_for_key
            ;;
        *æ¯”è¾ƒä¸¤ä¸ªæäº¤*)
            local commits
            if $USE_GUM; then
                commits=$(git log --oneline -n 50 | gum choose --no-limit --height 15 --cursor.foreground 212 --item.foreground 99 --selected.foreground 212 --prompt "é€‰æ‹©ä¸¤ä¸ªæäº¤ (ç”¨Tabé”®å¤šé€‰): " | awk '{print $1}')
            else
                commits=$(git log --oneline -n 50 | fzf -m --ansi --prompt="é€‰æ‹©ä¸¤ä¸ªæäº¤ (ç”¨Tabé”®å¤šé€‰)> " | awk '{print $1}')
            fi
            
            if [ $(echo "$commits" | wc -l) -eq 2 ]; then
                clear
                local commit1=$(echo "$commits" | head -n1)
                local commit2=$(echo "$commits" | tail -n1)
                git diff "$commit1" "$commit2"
                wait_for_key
            else
                $USE_GUM && gum style --foreground 196 "è¯·é€‰æ‹©ä¸¤ä¸ªæäº¤è¿›è¡Œæ¯”è¾ƒ!" || echo -e "\033[31mè¯·é€‰æ‹©ä¸¤ä¸ªæäº¤è¿›è¡Œæ¯”è¾ƒ!\033[0m"
                sleep 1
            fi
            ;;
        "â†©ï¸ è¿”å›"|*)
            break
            ;;
        esac
    done
}

# ======================================================
# è¿œç¨‹åä½œç®¡ç†åŠŸèƒ½
# ======================================================

git_remote_manager() {
    local options=(
        "æŸ¥çœ‹è¿œç¨‹ä»“åº“(-v)"
        "æ·»åŠ è¿œç¨‹ä»“åº“(add)"
        "ä¿®æ”¹è¿œç¨‹URL(set-url)"
        "é‡å‘½åè¿œç¨‹ä»“åº“(rename)"
        "åˆ é™¤è¿œç¨‹ä»“åº“(remove)"
        "è·å–è¿œç¨‹å˜æ›´(fetch)"
        "æ‹‰å–è¿œç¨‹å˜æ›´(pull)"
        "æ¨é€æœ¬åœ°å˜æ›´(push)"
        "â†©ï¸ è¿”å›"
    )

    while true; do
        local repo_name=$(basename "$(git rev-parse --show-toplevel)")
        local current_branch=$(git branch --show-current)
        
        if $USE_GUM; then
            custom_gum_show2hide_header "Git è¿œç¨‹åä½œ: $(gum style --foreground 212 "$repo_name")"
            custom_gum_show2hide_header "å½“å‰åˆ†æ”¯: $(gum style --foreground 99 "$current_branch")"
        else
            echo -e "Git è¿œç¨‹åä½œ: $repo_name"
            echo -e "å½“å‰åˆ†æ”¯: \033[1;35m$current_branch\033[0m"
        fi

        local selection=$(printf '%s\n' "${options[@]}" | fzf \
            --height=30% \
            --reverse \
            --prompt="â¤ Git è¿œç¨‹åä½œ > "
        )

        case "$selection" in
        *æŸ¥çœ‹è¿œç¨‹ä»“åº“*)
            clear
            git remote -v
            wait_for_key
            ;;
        *æ·»åŠ è¿œç¨‹ä»“åº“*)
            local remote_name=$(user_input "è¯·è¾“å…¥è¿œç¨‹åç§°: " "")
            local remote_url=$(user_input "è¯·è¾“å…¥è¿œç¨‹URL: " "")
            if [ -n "$remote_name" ] && [ -n "$remote_url" ]; then
                git remote add "$remote_name" "$remote_url"
            fi
            ;;
        *ä¿®æ”¹è¿œç¨‹URL*)
            local remotes=$(git remote)
            local selected
            
            if $USE_GUM; then
                selected=$(echo "$remotes" | gum choose --height 10 --cursor.foreground 212 --item.foreground 99 --selected.foreground 212 --prompt "é€‰æ‹©è¦ä¿®æ”¹çš„è¿œç¨‹: ")
            else
                selected=$(echo "$remotes" | fzf --ansi --prompt="é€‰æ‹©è¦ä¿®æ”¹çš„è¿œç¨‹> ")
            fi
            
            if [ -n "$selected" ]; then
                local new_url=$(user_input "è¯·è¾“å…¥æ–°URL: " "")
                git remote set-url "$selected" "$new_url"
            fi
            ;;
        *é‡å‘½åè¿œç¨‹ä»“åº“*)
            local remotes=$(git remote)
            local selected
            
            if $USE_GUM; then
                selected=$(echo "$remotes" | gum choose --height 10 --cursor.foreground 212 --item.foreground 99 --selected.foreground 212 --prompt "é€‰æ‹©è¦é‡å‘½åçš„è¿œç¨‹: ")
            else
                selected=$(echo "$remotes" | fzf --ansi --prompt="é€‰æ‹©è¦é‡å‘½åçš„è¿œç¨‹> ")
            fi
            
            if [ -n "$selected" ]; then
                local new_name=$(user_input "è¯·è¾“å…¥æ–°åç§°: " "")
                git remote rename "$selected" "$new_name"
            fi
            ;;
        *åˆ é™¤è¿œç¨‹ä»“åº“*)
            local remotes=$(git remote)
            local selected
            
            if $USE_GUM; then
                selected=$(echo "$remotes" | gum choose --height 10 --cursor.foreground 212 --item.foreground 99 --selected.foreground 212 --prompt "é€‰æ‹©è¦åˆ é™¤çš„è¿œç¨‹: ")
            else
                selected=$(echo "$remotes" | fzf --ansi --prompt="é€‰æ‹©è¦åˆ é™¤çš„è¿œç¨‹> ")
            fi
            
            if [ -n "$selected" ]; then
                git remote remove "$selected"
            fi
            ;;
        *è·å–è¿œç¨‹å˜æ›´*)
            local remotes=$(git remote)
            local selected
            
            if $USE_GUM; then
                selected=$(echo "$remotes" | gum choose --height 10 --cursor.foreground 212 --item.foreground 99 --selected.foreground 212 --prompt "é€‰æ‹©è¦è·å–çš„è¿œç¨‹: ")
            else
                selected=$(echo "$remotes" | fzf --ansi --prompt="é€‰æ‹©è¦è·å–çš„è¿œç¨‹> ")
            fi
            
            if [ -n "$selected" ]; then
                git fetch "$selected"
            fi
            ;;
        *æ‹‰å–è¿œç¨‹å˜æ›´*)
            local remotes=$(git remote)
            local selected
            
            if $USE_GUM; then
                selected=$(echo "$remotes" | gum choose --height 10 --cursor.foreground 212 --item.foreground 99 --selected.foreground 212 --prompt "é€‰æ‹©è¦æ‹‰å–çš„è¿œç¨‹: ")
            else
                selected=$(echo "$remotes" | fzf --ansi --prompt="é€‰æ‹©è¦æ‹‰å–çš„è¿œç¨‹> ")
            fi
            
            if [ -n "$selected" ]; then
                git pull "$selected" "$current_branch"
            fi
            ;;
        *æ¨é€æœ¬åœ°å˜æ›´*)
            local remotes=$(git remote)
            local selected
            
            if $USE_GUM; then
                selected=$(echo "$remotes" | gum choose --height 10 --cursor.foreground 212 --item.foreground 99 --selected.foreground 212 --prompt "é€‰æ‹©è¦æ¨é€çš„è¿œç¨‹: ")
            else
                selected=$(echo "$remotes" | fzf --ansi --prompt="é€‰æ‹©è¦æ¨é€çš„è¿œç¨‹> ")
            fi
            
            if [ -n "$selected" ]; then
                git push "$selected" "$current_branch"
            fi
            ;;
        "â†©ï¸ è¿”å›"|*)
            break
            ;;
        esac
    done
}

# ======================================================
# åˆå¹¶ä¸é‡å†™å†å²ç®¡ç†åŠŸèƒ½
# ======================================================

git_merge_rebase_manager() {
    local options=(
        "åˆå¹¶åˆ†æ”¯(merge)"
        "ç¦ç”¨å¿«è¿›åˆå¹¶(--no-ff)"
        "å‹ç¼©åˆå¹¶(--squash)"
        "å˜åŸºæ“ä½œ(rebase)"
        "äº¤äº’å¼å˜åŸº(-i)"
        "æ‹£é€‰æäº¤(cherry-pick)"
        "åè½¬æäº¤(revert)"
        "â†©ï¸ è¿”å›"
    )

    while true; do
        local repo_name=$(basename "$(git rev-parse --show-toplevel)")
        local current_branch=$(git branch --show-current)
        
        if $USE_GUM; then
            custom_gum_show2hide_header "Git åˆå¹¶ä¸é‡å†™å†å²: $(gum style --foreground 212 "$repo_name")"
            custom_gum_show2hide_header "å½“å‰åˆ†æ”¯: $(gum style --foreground 99 "$current_branch")"
        else
            echo -e "Git åˆå¹¶ä¸é‡å†™å†å²: $repo_name"
            echo -e "å½“å‰åˆ†æ”¯: \033[1;35m$current_branch\033[0m"
        fi

        local selection=$(printf '%s\n' "${options[@]}" | fzf \
            --height=30% \
            --reverse \
            --prompt="â¤ Git åˆå¹¶/é‡å†™ > "
        )

        case "$selection" in
        *åˆå¹¶åˆ†æ”¯*)
            local branches=$(git branch | sed 's/^* //' | sort)
            local selected
            
            if $USE_GUM; then
                selected=$(echo "$branches" | gum choose --height 15 --cursor.foreground 212 --item.foreground 99 --selected.foreground 212 --prompt "é€‰æ‹©è¦åˆå¹¶çš„åˆ†æ”¯: ")
            else
                selected=$(echo "$branches" | fzf --ansi --prompt="é€‰æ‹©è¦åˆå¹¶çš„åˆ†æ”¯> ")
            fi
            
            if [ -n "$selected" ]; then
                git merge "$selected"
            fi
            ;;
        *ç¦ç”¨å¿«è¿›åˆå¹¶*)
            local branches=$(git branch | sed 's/^* //' | sort)
            local selected
            
            if $USE_GUM; then
                selected=$(echo "$branches" | gum choose --height 15 --cursor.foreground 212 --item.foreground 99 --selected.foreground 212 --prompt "é€‰æ‹©è¦åˆå¹¶çš„åˆ†æ”¯: ")
            else
                selected=$(echo "$branches" | fzf --ansi --prompt="é€‰æ‹©è¦åˆå¹¶çš„åˆ†æ”¯> ")
            fi
            
            if [ -n "$selected" ]; then
                git merge --no-ff "$selected"
            fi
            ;;
        *å‹ç¼©åˆå¹¶*)
            local branches=$(git branch | sed 's/^* //' | sort)
            local selected
            
            if $USE_GUM; then
                selected=$(echo "$branches" | gum choose --height 15 --cursor.foreground 212 --item.foreground 99 --selected.foreground 212 --prompt "é€‰æ‹©è¦å‹ç¼©åˆå¹¶çš„åˆ†æ”¯: ")
            else
                selected=$(echo "$branches" | fzf --ansi --prompt="é€‰æ‹©è¦å‹ç¼©åˆå¹¶çš„åˆ†æ”¯> ")
            fi
            
            if [ -n "$selected" ]; then
                git merge --squash "$selected"
            fi
            ;;
        *å˜åŸºæ“ä½œ*)
            local branches=$(git branch | sed 's/^* //' | sort)
            local selected
            
            if $USE_GUM; then
                selected=$(echo "$branches" | gum choose --height 15 --cursor.foreground 212 --item.foreground 99 --selected.foreground 212 --prompt "é€‰æ‹©åŸºå‡†åˆ†æ”¯: ")
            else
                selected=$(echo "$branches" | fzf --ansi --prompt="é€‰æ‹©åŸºå‡†åˆ†æ”¯> ")
            fi
            
            if [ -n "$selected" ]; then
                git rebase "$selected"
            fi
            ;;
        *äº¤äº’å¼å˜åŸº*)
            local commit_count=$(user_input "è¯·è¾“å…¥è¦å˜åŸºçš„æäº¤æ•°é‡: " "5")
            if [[ "$commit_count" =~ ^[0-9]+$ ]]; then
                git rebase -i HEAD~"$commit_count"
            fi
            ;;
        *æ‹£é€‰æäº¤*)
            local commit
            if $USE_GUM; then
                commit=$(git log --oneline -n 50 | gum choose --height 15 --cursor.foreground 212 --item.foreground 99 --selected.foreground 212 --prompt "é€‰æ‹©è¦æ‹£é€‰çš„æäº¤: " | awk '{print $1}')
            else
                commit=$(git log --oneline -n 50 | fzf --ansi --prompt="é€‰æ‹©è¦æ‹£é€‰çš„æäº¤> " | awk '{print $1}')
            fi
            
            if [ -n "$commit" ]; then
                git cherry-pick "$commit"
            fi
            ;;
        *åè½¬æäº¤*)
            local commit
            if $USE_GUM; then
                commit=$(git log --oneline -n 50 | gum choose --height 15 --cursor.foreground 212 --item.foreground 99 --selected.foreground 212 --prompt "é€‰æ‹©è¦åè½¬çš„æäº¤: " | awk '{print $1}')
            else
                commit=$(git log --oneline -n 50 | fzf --ansi --prompt="é€‰æ‹©è¦åè½¬çš„æäº¤> " | awk '{print $1}')
            fi
            
            if [ -n "$commit" ]; then
                git revert "$commit"
            fi
            ;;
        "â†©ï¸ è¿”å›"|*)
            break
            ;;
        esac
    done
}

# ======================================================
# ä¸´æ—¶å­˜å‚¨ç®¡ç†åŠŸèƒ½
# ======================================================

git_stash_manager() {
    local options=(
        "å‚¨è—æ›´æ”¹(push)"
        "æŸ¥çœ‹å‚¨è—åˆ—è¡¨(list)"
        "åº”ç”¨å‚¨è—(apply)"
        "åº”ç”¨å¹¶åˆ é™¤å‚¨è—(pop)"
        "åˆ é™¤å‚¨è—(drop)"
        "æ¸…ç©ºå‚¨è—(clear)"
        "â†©ï¸ è¿”å›"
    )

    while true; do
        local repo_name=$(basename "$(git rev-parse --show-toplevel)")
        local current_branch=$(git branch --show-current)
        
        if $USE_GUM; then
            custom_gum_show2hide_header "Git ä¸´æ—¶å­˜å‚¨: $(gum style --foreground 212 "$repo_name")"
            custom_gum_show2hide_header "å½“å‰åˆ†æ”¯: $(gum style --foreground 99 "$current_branch")"
        else
            echo -e "Git ä¸´æ—¶å­˜å‚¨: $repo_name"
            echo -e "å½“å‰åˆ†æ”¯: \033[1;35m$current_branch\033[0m"
        fi

        local selection=$(printf '%s\n' "${options[@]}" | fzf \
            --height=30% \
            --reverse \
            --prompt="â¤ Git å‚¨è—ç®¡ç† > "
        )

        case "$selection" in
        *å‚¨è—æ›´æ”¹*)
            local stash_message=$(user_input "è¯·è¾“å…¥å‚¨è—ä¿¡æ¯: " "ä¸´æ—¶å‚¨è—")
            if [ -z "$stash_message" ]; then
                git stash push
            else
                git stash push -m "$stash_message"
            fi
            ;;
        *æŸ¥çœ‹å‚¨è—åˆ—è¡¨*)
            clear
            git stash list
            wait_for_key
            ;;
        *åº”ç”¨å‚¨è—*)
            local stash
            if $USE_GUM; then
                stash=$(git stash list | gum choose --height 15 --cursor.foreground 212 --item.foreground 99 --selected.foreground 212 --prompt "é€‰æ‹©è¦åº”ç”¨çš„å‚¨è—: " | cut -d':' -f1)
            else
                stash=$(git stash list | fzf --ansi --prompt="é€‰æ‹©è¦åº”ç”¨çš„å‚¨è—> " | cut -d':' -f1)
            fi
            
            if [ -n "$stash" ]; then
                git stash apply "$stash"
            fi
            ;;
        *åº”ç”¨å¹¶åˆ é™¤å‚¨è—*)
            local stash
            if $USE_GUM; then
                stash=$(git stash list | gum choose --height 15 --cursor.foreground 212 --item.foreground 99 --selected.foreground 212 --prompt "é€‰æ‹©è¦åº”ç”¨çš„å‚¨è—: " | cut -d':' -f1)
            else
                stash=$(git stash list | fzf --ansi --prompt="é€‰æ‹©è¦åº”ç”¨çš„å‚¨è—> " | cut -d':' -f1)
            fi
            
            if [ -n "$stash" ]; then
                git stash pop "$stash"
            fi
            ;;
        *åˆ é™¤å‚¨è—*)
            local stash
            if $USE_GUM; then
                stash=$(git stash list | gum choose --height 15 --cursor.foreground 212 --item.foreground 99 --selected.foreground 212 --prompt "é€‰æ‹©è¦åˆ é™¤çš„å‚¨è—: " | cut -d':' -f1)
            else
                stash=$(git stash list | fzf --ansi --prompt="é€‰æ‹©è¦åˆ é™¤çš„å‚¨è—> " | cut -d':' -f1)
            fi
            
            if [ -n "$stash" ]; then
                git stash drop "$stash"
            fi
            ;;
        *æ¸…ç©ºå‚¨è—*)
            git stash clear
            ;;
        "â†©ï¸ è¿”å›"|*)
            break
            ;;
        esac
    done
}

# ======================================================
# æ ‡ç­¾ç®¡ç†åŠŸèƒ½
# ======================================================

git_tag_manager() {
    local options=(
        "æŸ¥çœ‹æœ¬åœ°æ ‡ç­¾"
        "åˆ›å»ºè½»é‡æ ‡ç­¾"
        "åˆ›å»ºé™„æ³¨æ ‡ç­¾(-a)"
        "åˆ›å»ºç­¾åæ ‡ç­¾(-s)"
        "æ¨é€æ ‡ç­¾åˆ°è¿œç¨‹(push --tags)"
        "åˆ é™¤æœ¬åœ°æ ‡ç­¾"
        "åˆ é™¤è¿œç¨‹æ ‡ç­¾"
        "â†©ï¸ è¿”å›"
    )

    while true; do
        local repo_name=$(basename "$(git rev-parse --show-toplevel)")
        local current_branch=$(git branch --show-current)
        
        if $USE_GUM; then
            custom_gum_show2hide_header "Git æ ‡ç­¾ç®¡ç†: $(gum style --foreground 212 "$repo_name")"
            custom_gum_show2hide_header "å½“å‰åˆ†æ”¯: $(gum style --foreground 99 "$current_branch")"
        else
            echo -e "Git æ ‡ç­¾ç®¡ç†: $repo_name"
            echo -e "å½“å‰åˆ†æ”¯: \033[1;35m$current_branch\033[0m"
        fi

        local selection=$(printf '%s\n' "${options[@]}" | fzf \
            --height=30% \
            --reverse \
            --prompt="â¤ Git æ ‡ç­¾ç®¡ç† > "
        )

        case "$selection" in
        *æŸ¥çœ‹æœ¬åœ°æ ‡ç­¾*)
            clear
            git tag -l
            wait_for_key
            ;;
        *åˆ›å»ºè½»é‡æ ‡ç­¾*)
            local tag_name=$(user_input "è¯·è¾“å…¥æ ‡ç­¾å: " "")
            if [ -n "$tag_name" ]; then
                git tag "$tag_name"
            fi
            ;;
        *åˆ›å»ºé™„æ³¨æ ‡ç­¾*)
            local tag_name=$(user_input "è¯·è¾“å…¥æ ‡ç­¾å: " "")
            if [ -n "$tag_name" ]; then
                local tag_message=$(user_input "è¯·è¾“å…¥æ ‡ç­¾ä¿¡æ¯: " "å‘å¸ƒæ ‡ç­¾ $tag_name")
                git tag -a "$tag_name" -m "$tag_message"
            fi
            ;;
        *åˆ›å»ºç­¾åæ ‡ç­¾*)
            local tag_name=$(user_input "è¯·è¾“å…¥æ ‡ç­¾å: " "")
            if [ -n "$tag_name" ]; then
                git tag -s "$tag_name"
            fi
            ;;
        *æ¨é€æ ‡ç­¾åˆ°è¿œç¨‹*)
            git push --tags
            ;;
        *åˆ é™¤æœ¬åœ°æ ‡ç­¾*)
            local tags=$(git tag -l)
            local selected
            
            if $USE_GUM; then
                selected=$(echo "$tags" | gum choose --no-limit --height 15 --cursor.foreground 212 --item.foreground 99 --selected.foreground 212 --prompt "é€‰æ‹©è¦åˆ é™¤çš„æ ‡ç­¾: ")
            else
                selected=$(echo "$tags" | fzf -m --ansi --prompt="é€‰æ‹©è¦åˆ é™¤çš„æ ‡ç­¾> ")
            fi
            
            if [ -n "$selected" ]; then
                echo "$selected" | xargs git tag -d
            fi
            ;;
        *åˆ é™¤è¿œç¨‹æ ‡ç­¾*)
            local tags=$(git tag -l)
            local selected
            
            if $USE_GUM; then
                selected=$(echo "$tags" | gum choose --no-limit --height 15 --cursor.foreground 212 --item.foreground 99 --selected.foreground 212 --prompt "é€‰æ‹©è¦åˆ é™¤çš„è¿œç¨‹æ ‡ç­¾: ")
            else
                selected=$(echo "$tags" | fzf -m --ansi --prompt="é€‰æ‹©è¦åˆ é™¤çš„è¿œç¨‹æ ‡ç­¾> ")
            fi
            
            if [ -n "$selected" ]; then
                for tag in $selected; do
                    git push origin :refs/tags/"$tag"
                done
            fi
            ;;
        "â†©ï¸ è¿”å›"|*)
            break
            ;;
        esac
    done
}

# ======================================================
# é«˜çº§æ“ä½œç®¡ç†åŠŸèƒ½
# ======================================================

git_advanced_manager() {
    local options=(
        "äºŒåˆ†æŸ¥æ‰¾(bisect)"
        "å­æ¨¡å—ç®¡ç†(submodule)"
        "ä»“åº“é‡å†™(filter-repo)"
        "æ‰“åŒ…ä¼ è¾“(bundle)"
        "å¯¹è±¡æ›¿æ¢(replace)"
        "â†©ï¸ è¿”å›"
    )

    while true; do
        local repo_name=$(basename "$(git rev-parse --show-toplevel)")
        local current_branch=$(git branch --show-current)
        
        if $USE_GUM; then
            custom_gum_show2hide_header "Git é«˜çº§æ“ä½œ: $(gum style --foreground 212 "$repo_name")"
            custom_gum_show2hide_header "å½“å‰åˆ†æ”¯: $(gum style --foreground 99 "$current_branch")"
        else
            echo -e "Git é«˜çº§æ“ä½œ: $repo_name"
            echo -e "å½“å‰åˆ†æ”¯: \033[1;35m$current_branch\033[0m"
        fi

        local selection=$(printf '%s\n' "${options[@]}" | fzf \
            --height=30% \
            --reverse \
            --prompt="â¤ Git é«˜çº§æ“ä½œ > "
        )

        case "$selection" in
        *äºŒåˆ†æŸ¥æ‰¾*)
            git_bisect_manager
            ;;
        *å­æ¨¡å—ç®¡ç†*)
            git_submodule_manager
            ;;
        *ä»“åº“é‡å†™*)
            if confirm_action "è­¦å‘Š: ä»“åº“é‡å†™æ˜¯å±é™©æ“ä½œ! ç¡®å®šè¦ä½¿ç”¨filter-repoå—?"; then
                git filter-repo
            fi
            ;;
        *æ‰“åŒ…ä¼ è¾“*)
            git_bundle_manager
            ;;
        *å¯¹è±¡æ›¿æ¢*)
            git_replace_manager
            ;;
        "â†©ï¸ è¿”å›"|*)
            break
            ;;
        esac
    done
}

# ======================================================
# äºŒåˆ†æŸ¥æ‰¾ç®¡ç†åŠŸèƒ½
# ======================================================

git_bisect_manager() {
    local options=(
        "å¼€å§‹äºŒåˆ†æŸ¥æ‰¾(start)"
        "æ ‡è®°ä¸ºæ­£ç¡®(good)"
        "æ ‡è®°ä¸ºé”™è¯¯(bad)"
        "è·³è¿‡å½“å‰(skip)"
        "é‡ç½®(reset)"
        "â†©ï¸ è¿”å›"
    )

    while true; do
        $USE_GUM && custom_gum_show2hide_header "Git äºŒåˆ†æŸ¥æ‰¾" || echo -e "Git äºŒåˆ†æŸ¥æ‰¾"

        local selection=$(printf '%s\n' "${options[@]}" | fzf \
            --height=30% \
            --reverse \
            --prompt="â¤ Git äºŒåˆ†æŸ¥æ‰¾ > "
        )

        case "$selection" in
        *å¼€å§‹äºŒåˆ†æŸ¥æ‰¾*)
            git bisect start
            ;;
        *æ ‡è®°ä¸ºæ­£ç¡®*)
            git bisect good
            ;;
        *æ ‡è®°ä¸ºé”™è¯¯*)
            git bisect bad
            ;;
        *è·³è¿‡å½“å‰*)
            git bisect skip
            ;;
        *é‡ç½®*)
            git bisect reset
            ;;
        "â†©ï¸ è¿”å›"|*)
            break
            ;;
        esac
    done
}

# ======================================================
# å­æ¨¡å—ç®¡ç†åŠŸèƒ½
# ======================================================

git_submodule_manager() {
    local options=(
        "æ·»åŠ å­æ¨¡å—(add)"
        "åˆå§‹åŒ–å­æ¨¡å—(init)"
        "æ›´æ–°å­æ¨¡å—(update)"
        "é€’å½’æ›´æ–°(--recursive)"
        "éå†æ‰§è¡Œå‘½ä»¤(foreach)"
        "â†©ï¸ è¿”å›"
    )

    while true; do
        $USE_GUM && custom_gum_show2hide_header "Git å­æ¨¡å—ç®¡ç†" || echo -e "Git å­æ¨¡å—ç®¡ç†"

        local selection=$(printf '%s\n' "${options[@]}" | fzf \
            --height=30% \
            --reverse \
            --prompt="â¤ Git å­æ¨¡å— > "
        )

        case "$selection" in
        *æ·»åŠ å­æ¨¡å—*)
            local sub_url=$(user_input "è¯·è¾“å…¥å­æ¨¡å—URL: " "")
            local sub_path=$(user_input "è¯·è¾“å…¥å­æ¨¡å—è·¯å¾„: " "")
            if [ -n "$sub_url" ] && [ -n "$sub_path" ]; then
                git submodule add "$sub_url" "$sub_path"
            fi
            ;;
        *åˆå§‹åŒ–å­æ¨¡å—*)
            git submodule init
            ;;
        *æ›´æ–°å­æ¨¡å—*)
            git submodule update
            ;;
        *é€’å½’æ›´æ–°*)
            git submodule update --init --recursive
            ;;
        *éå†æ‰§è¡Œå‘½ä»¤*)
            local command=$(user_input "è¯·è¾“å…¥è¦æ‰§è¡Œçš„å‘½ä»¤: " "git pull")
            if [ -n "$command" ]; then
                git submodule foreach "$command"
            fi
            ;;
        "â†©ï¸ è¿”å›"|*)
            break
            ;;
        esac
    done
}

# ======================================================
# æ‰“åŒ…ä¼ è¾“ç®¡ç†åŠŸèƒ½
# ======================================================

git_bundle_manager() {
    local options=(
        "åˆ›å»ºæ‰“åŒ…æ–‡ä»¶(create)"
        "è§£åŒ…æ–‡ä»¶(unbundle)"
        "éªŒè¯æ‰“åŒ…æ–‡ä»¶(verify)"
        "â†©ï¸ è¿”å›"
    )

    while true; do
        $USE_GUM && custom_gum_show2hide_header "Git æ‰“åŒ…ä¼ è¾“" || echo -e "Git æ‰“åŒ…ä¼ è¾“"

        local selection=$(printf '%s\n' "${options[@]}" | fzf \
            --height=30% \
            --reverse \
            --prompt="â¤ Git æ‰“åŒ… > "
        )

        case "$selection" in
        *åˆ›å»ºæ‰“åŒ…æ–‡ä»¶*)
            local bundle_file=$(user_input "è¯·è¾“å…¥æ‰“åŒ…æ–‡ä»¶å: " "repo.bundle")
            local refspec=$(user_input "è¯·è¾“å…¥åˆ†æ”¯æˆ–æäº¤èŒƒå›´: " "HEAD")
            if [ -n "$bundle_file" ] && [ -n "$refspec" ]; then
                git bundle create "$bundle_file" "$refspec"
            fi
            ;;
        *è§£åŒ…æ–‡ä»¶*)
            local bundle_files=$(ls *.bundle 2>/dev/null)
            if [ -z "$bundle_files" ]; then
                $USE_GUM && gum style --foreground 196 "æ²¡æœ‰æ‰¾åˆ°æ‰“åŒ…æ–‡ä»¶!" || echo -e "\033[31mæ²¡æœ‰æ‰¾åˆ°æ‰“åŒ…æ–‡ä»¶!\033[0m"
                sleep 1
                continue
            fi
            local selected
            if $USE_GUM; then
                selected=$(echo "$bundle_files" | gum choose --height 10 --cursor.foreground 212 --item.foreground 99 --selected.foreground 212 --prompt "é€‰æ‹©æ‰“åŒ…æ–‡ä»¶: ")
            else
                selected=$(echo "$bundle_files" | fzf --ansi --prompt="é€‰æ‹©æ‰“åŒ…æ–‡ä»¶> ")
            fi
            if [ -n "$selected" ]; then
                git bundle unbundle "$selected"
            fi
            ;;
        *éªŒè¯æ‰“åŒ…æ–‡ä»¶*)
            local bundle_files=$(ls *.bundle 2>/dev/null)
            if [ -z "$bundle_files" ]; then
                $USE_GUM && gum style --foreground 196 "æ²¡æœ‰æ‰¾åˆ°æ‰“åŒ…æ–‡ä»¶!" || echo -e "\033[31mæ²¡æœ‰æ‰¾åˆ°æ‰“åŒ…æ–‡ä»¶!\033[0m"
                sleep 1
                continue
            fi
            local selected
            if $USE_GUM; then
                selected=$(echo "$bundle_files" | gum choose --height 10 --cursor.foreground 212 --item.foreground 99 --selected.foreground 212 --prompt "é€‰æ‹©æ‰“åŒ…æ–‡ä»¶: ")
            else
                selected=$(echo "$bundle_files" | fzf --ansi --prompt="é€‰æ‹©æ‰“åŒ…æ–‡ä»¶> ")
            fi
            if [ -n "$selected" ]; then
                git bundle verify "$selected"
                wait_for_key
            fi
            ;;
        "â†©ï¸ è¿”å›"|*)
            break
            ;;
        esac
    done
}

# ======================================================
# å¯¹è±¡æ›¿æ¢ç®¡ç†åŠŸèƒ½
# ======================================================

git_replace_manager() {
    local options=(
        "åˆ›å»ºæ›¿æ¢å¯¹è±¡"
        "åˆ—å‡ºæ‰€æœ‰æ›¿æ¢å¯¹è±¡"
        "åˆ é™¤æ›¿æ¢å¯¹è±¡"
        "â†©ï¸ è¿”å›"
    )

    while true; do
        $USE_GUM && custom_gum_show2hide_header "Git å¯¹è±¡æ›¿æ¢" || echo -e "Git å¯¹è±¡æ›¿æ¢"

        local selection=$(printf '%s\n' "${options[@]}" | fzf \
            --height=30% \
            --reverse \
            --prompt="â¤ Git æ›¿æ¢å¯¹è±¡ > "
        )

        case "$selection" in
        *åˆ›å»ºæ›¿æ¢å¯¹è±¡*)
            local old_object
            if $USE_GUM; then
                old_object=$(git log --oneline -n 50 | gum choose --height 15 --cursor.foreground 212 --item.foreground 99 --selected.foreground 212 --prompt "é€‰æ‹©è¢«æ›¿æ¢çš„å¯¹è±¡: " | awk '{print $1}')
            else
                old_object=$(git log --oneline -n 50 | fzf --ansi --prompt="é€‰æ‹©è¢«æ›¿æ¢çš„å¯¹è±¡> " | awk '{print $1}')
            fi
            
            local new_object
            if $USE_GUM; then
                new_object=$(git log --oneline -n 50 | gum choose --height 15 --cursor.foreground 212 --item.foreground 99 --selected.foreground 212 --prompt "é€‰æ‹©æ›¿æ¢å¯¹è±¡: " | awk '{print $1}')
            else
                new_object=$(git log --oneline -n 50 | fzf --ansi --prompt="é€‰æ‹©æ›¿æ¢å¯¹è±¡> " | awk '{print $1}')
            fi
            
            if [ -n "$old_object" ] && [ -n "$new_object" ]; then
                git replace "$old_object" "$new_object"
            fi
            ;;
        *åˆ—å‡ºæ‰€æœ‰æ›¿æ¢å¯¹è±¡*)
            clear
            git replace -l
            wait_for_key
            ;;
        *åˆ é™¤æ›¿æ¢å¯¹è±¡*)
            local replaces=$(git replace -l)
            if [ -z "$replaces" ]; then
                $USE_GUM && gum style --foreground 196 "æ²¡æœ‰æ›¿æ¢å¯¹è±¡!" || echo -e "\033[31mæ²¡æœ‰æ›¿æ¢å¯¹è±¡!\033[0m"
                sleep 1
                continue
            fi
            local selected
            if $USE_GUM; then
                selected=$(echo "$replaces" | gum choose --height 10 --cursor.foreground 212 --item.foreground 99 --selected.foreground 212 --prompt "é€‰æ‹©è¦åˆ é™¤çš„æ›¿æ¢å¯¹è±¡: ")
            else
                selected=$(echo "$replaces" | fzf --ansi --prompt="é€‰æ‹©è¦åˆ é™¤çš„æ›¿æ¢å¯¹è±¡> ")
            fi
            if [ -n "$selected" ]; then
                git replace -d "$selected"
            fi
            ;;
        "â†©ï¸ è¿”å›"|*)
            break
            ;;
        esac
    done
}

# ======================================================
# è¯Šæ–­ä¸ç»´æŠ¤ç®¡ç†åŠŸèƒ½
# ======================================================

git_maintenance_manager() {
    local options=(
        "åƒåœ¾å›æ”¶(gc)"
        "è‡ªåŠ¨åƒåœ¾å›æ”¶(gc --auto)"
        "éªŒè¯å¯¹è±¡(fsck)"
        "ç»Ÿè®¡å¯¹è±¡(count-objects)"
        "éªŒè¯ç­¾å(verify-commit)"
        "ç»´æŠ¤ä»»åŠ¡(run)"
        "å¯åŠ¨ç»´æŠ¤ä»»åŠ¡(start)"
        "åœæ­¢ç»´æŠ¤ä»»åŠ¡(stop)"
        "â†©ï¸ è¿”å›"
    )

    while true; do
        local repo_name=$(basename "$(git rev-parse --show-toplevel)")
        
        if $USE_GUM; then
            custom_gum_show2hide_header "Git è¯Šæ–­ä¸ç»´æŠ¤: $(gum style --foreground 212 "$repo_name")"
        else
            echo -e "Git è¯Šæ–­ä¸ç»´æŠ¤: $repo_name"
        fi

        local selection=$(printf '%s\n' "${options[@]}" | fzf \
            --height=30% \
            --reverse \
            --prompt="â¤ Git ç»´æŠ¤ > "
        )

        case "$selection" in
        *åƒåœ¾å›æ”¶*)
            git gc
            ;;
        *è‡ªåŠ¨åƒåœ¾å›æ”¶*)
            git gc --auto
            ;;
        *éªŒè¯å¯¹è±¡*)
            clear
            git fsck
            wait_for_key
            ;;
        *ç»Ÿè®¡å¯¹è±¡*)
            clear
            git count-objects -v
            wait_for_key
            ;;
        *éªŒè¯ç­¾å*)
            local commit
            if $USE_GUM; then
                commit=$(git log --oneline -n 50 | gum choose --height 15 --cursor.foreground 212 --item.foreground 99 --selected.foreground 212 --prompt "é€‰æ‹©æäº¤éªŒè¯ç­¾å: " | awk '{print $1}')
            else
                commit=$(git log --oneline -n 50 | fzf --ansi --prompt="é€‰æ‹©æäº¤éªŒè¯ç­¾å> " | awk '{print $1}')
            fi
            if [ -n "$commit" ]; then
                git verify-commit "$commit"
                wait_for_key
            fi
            ;;
        *ç»´æŠ¤ä»»åŠ¡*)
            git maintenance run
            ;;
        *å¯åŠ¨ç»´æŠ¤ä»»åŠ¡*)
            git maintenance start
            ;;
        *åœæ­¢ç»´æŠ¤ä»»åŠ¡*)
            git maintenance stop
            ;;
        "â†©ï¸ è¿”å›"|*)
            break
            ;;
        esac
    done
}

# ======================================================
# é…ç½®å·¥å…·ç®¡ç†åŠŸèƒ½
# ======================================================

git_config_manager() {
    local options=(
        "æŸ¥çœ‹æ‰€æœ‰é…ç½®(--list)"
        "è®¾ç½®ç”¨æˆ·å(user.name)"
        "è®¾ç½®é‚®ç®±(user.email)"
        "è®¾ç½®åˆ«å(alias)"
        "è®¾ç½®æ¢è¡Œç¬¦å¤„ç†(core.autocrlf)"
        "ç¼–è¾‘é…ç½®æ–‡ä»¶(edit)"
        "â†©ï¸ è¿”å›"
    )

    while true; do
        $USE_GUM && custom_gum_show2hide_header "Git é…ç½®ç®¡ç†" || echo -e "Git é…ç½®ç®¡ç†"

        local selection=$(printf '%s\n' "${options[@]}" | fzf \
            --height=30% \
            --reverse \
            --prompt="â¤ Git é…ç½®ç®¡ç† > "
        )

        case "$selection" in
        *æŸ¥çœ‹æ‰€æœ‰é…ç½®*)
            clear
            git config --list
            wait_for_key
            ;;
        *è®¾ç½®ç”¨æˆ·å*)
            local username=$(user_input "è¯·è¾“å…¥ç”¨æˆ·å: " "")
            if [ -n "$username" ]; then
                git config --global user.name "$username"
            fi
            ;;
        *è®¾ç½®é‚®ç®±*)
            local email=$(user_input "è¯·è¾“å…¥é‚®ç®±: " "")
            if [ -n "$email" ]; then
                git config --global user.email "$email"
            fi
            ;;
        *è®¾ç½®åˆ«å*)
            local alias_name=$(user_input "è¯·è¾“å…¥åˆ«å (å¦‚: co): " "")
            local command=$(user_input "è¯·è¾“å…¥å‘½ä»¤ (å¦‚: checkout): " "")
            if [ -n "$alias_name" ] && [ -n "$command" ]; then
                git config --global alias."$alias_name" "$command"
            fi
            ;;
        *è®¾ç½®æ¢è¡Œç¬¦å¤„ç†*)
            local options=("input" "true" "false")
            local crlf
            if $USE_GUM; then
                crlf=$(printf '%s\n' "${options[@]}" | gum choose --height 5 --cursor.foreground 212 --item.foreground 99 --selected.foreground 212 --prompt "é€‰æ‹©autocrlfå€¼: ")
            else
                crlf=$(printf '%s\n' "${options[@]}" | fzf --ansi --prompt="é€‰æ‹©autocrlfå€¼> ")
            fi
            if [ -n "$crlf" ]; then
                git config --global core.autocrlf "$crlf"
            fi
            ;;
        *ç¼–è¾‘é…ç½®æ–‡ä»¶*)
            git config --global --edit
            ;;
        "â†©ï¸ è¿”å›"|*)
            break
            ;;
        esac
    done
}

# ======================================================
# åº•å±‚å‘½ä»¤ç®¡ç†åŠŸèƒ½
# ======================================================

git_plumbing_manager() {
    local options=(
        "æŸ¥çœ‹åŸå§‹å¯¹è±¡(cat-file)"
        "åˆ›å»ºå¯¹è±¡(hash-object)"
        "æŸ¥çœ‹æ ‘å¯¹è±¡(ls-tree)"
        "æ“ä½œç´¢å¼•(update-index)"
        "æ„å»ºæ ‘å¯¹è±¡(mktree)"
        "åˆ›å»ºæäº¤å¯¹è±¡(commit-tree)"
        "â†©ï¸ è¿”å›"
    )

    while true; do
        local repo_name=$(basename "$(git rev-parse --show-toplevel)")
        
        if $USE_GUM; then
            custom_gum_show2hide_header "Git åº•å±‚å‘½ä»¤: $(gum style --foreground 212 "$repo_name")"
        else
            echo -e "Git åº•å±‚å‘½ä»¤: $repo_name"
        fi

        local selection=$(printf '%s\n' "${options[@]}" | fzf \
            --height=30% \
            --reverse \
            --prompt="â¤ Git åº•å±‚å‘½ä»¤ > "
        )

        case "$selection" in
        *æŸ¥çœ‹åŸå§‹å¯¹è±¡*)
            local object
            if $USE_GUM; then
                object=$(git log --oneline -n 50 | gum choose --height 15 --cursor.foreground 212 --item.foreground 99 --selected.foreground 212 --prompt "é€‰æ‹©å¯¹è±¡: " | awk '{print $1}')
            else
                object=$(git log --oneline -n 50 | fzf --ansi --prompt="é€‰æ‹©å¯¹è±¡> " | awk '{print $1}')
            fi
            if [ -n "$object" ]; then
                clear
                git cat-file -p "$object"
                wait_for_key
            fi
            ;;
        *åˆ›å»ºå¯¹è±¡*)
            local file_name=$(user_input "è¯·è¾“å…¥æ–‡ä»¶å: " "")
            if [ -f "$file_name" ]; then
                git hash-object -w "$file_name"
            else
                $USE_GUM && gum style --foreground 196 "æ–‡ä»¶ä¸å­˜åœ¨!" || echo -e "\033[31mæ–‡ä»¶ä¸å­˜åœ¨!\033[0m"
            fi
            sleep 1
            ;;
        *æŸ¥çœ‹æ ‘å¯¹è±¡*)
            local tree
            if $USE_GUM; then
                tree=$(git log --oneline -n 50 | gum choose --height 15 --cursor.foreground 212 --item.foreground 99 --selected.foreground 212 --prompt "é€‰æ‹©æ ‘å¯¹è±¡: " | awk '{print $1}')
            else
                tree=$(git log --oneline -n 50 | fzf --ansi --prompt="é€‰æ‹©æ ‘å¯¹è±¡> " | awk '{print $1}')
            fi
            if [ -n "$tree" ]; then
                clear
                git ls-tree "$tree"
                wait_for_key
            fi
            ;;
        *æ“ä½œç´¢å¼•*)
            $USE_GUM && gum style --foreground 196 "è­¦å‘Š: ç›´æ¥æ“ä½œç´¢å¼•æ˜¯é«˜çº§æ“ä½œ!" || echo -e "\033[31mè­¦å‘Š: ç›´æ¥æ“ä½œç´¢å¼•æ˜¯é«˜çº§æ“ä½œ!\033[0m"
            local command=$(user_input "è¯·è¾“å…¥å‘½ä»¤ (å¦‚: --add): " "")
            if [ -n "$command" ]; then
                git update-index $command
            fi
            ;;
        *æ„å»ºæ ‘å¯¹è±¡*)
            echo -e "è¾“å…¥æ ‘å¯¹è±¡å†…å®¹ (æ ¼å¼: æ¨¡å¼ ç±»å‹ SHA æ–‡ä»¶å)"
            echo -e "è¾“å…¥å®ŒæˆåæŒ‰Ctrl+Dç»“æŸ"
            git mktree
            ;;
        *åˆ›å»ºæäº¤å¯¹è±¡*)
            local tree_sha=$(user_input "è¯·è¾“å…¥æ ‘å¯¹è±¡SHA: " "")
            local parent_sha=$(user_input "è¯·è¾“å…¥çˆ¶æäº¤SHA (å¯é€‰): " "")
            local commit_msg=$(user_input "è¯·è¾“å…¥æäº¤ä¿¡æ¯: " "æ–°æäº¤")
            if [ -n "$tree_sha" ] && [ -n "$commit_msg" ]; then
                if [ -n "$parent_sha" ]; then
                    echo "$commit_msg" | git commit-tree "$tree_sha" -p "$parent_sha"
                else
                    echo "$commit_msg" | git commit-tree "$tree_sha"
                fi
            fi
            ;;
        "â†©ï¸ è¿”å›"|*)
            break
            ;;
        esac
    done
}

# ======================================================
# è¾…åŠ©å·¥å…·ç®¡ç†åŠŸèƒ½
# ======================================================

git_helper_tools_manager() {
    local options=(
        "å›¾å½¢ç•Œé¢(gui)"
        "å¯è§†åŒ–æµè§ˆå™¨(k)"
        "æäº¤å·¥å…·(citool)"
        "å¯åŠ¨Webç•Œé¢(instaweb)"
        "â†©ï¸ è¿”å›"
    )

    while true; do
        local repo_name=$(basename "$(git rev-parse --show-toplevel)")
        
        if $USE_GUM; then
            custom_gum_show2hide_header "Git è¾…åŠ©å·¥å…·: $(gum style --foreground 212 "$repo_name")"
        else
            echo -e "Git è¾…åŠ©å·¥å…·: $repo_name"
        fi

        local selection=$(printf '%s\n' "${options[@]}" | fzf \
            --height=30% \
            --reverse \
            --prompt="â¤ Git è¾…åŠ©å·¥å…· > "
        )

        case "$selection" in
        *å›¾å½¢ç•Œé¢*)
            git gui
            ;;
        *å¯è§†åŒ–æµè§ˆå™¨*)
            gitk
            ;;
        *æäº¤å·¥å…·*)
            git citool
            ;;
        *å¯åŠ¨Webç•Œé¢*)
            git instaweb --start
            $USE_GUM && gum style --foreground 99 "Webç•Œé¢å·²å¯åŠ¨ï¼ŒæŒ‰ä»»æ„é”®åœæ­¢..." || echo -e "\033[35mWebç•Œé¢å·²å¯åŠ¨ï¼ŒæŒ‰ä»»æ„é”®åœæ­¢...\033[0m"
            wait_for_key
            git instaweb --stop
            ;;
        "â†©ï¸ è¿”å›"|*)
            break
            ;;
        esac
    done
}

# ======================================================
# SVN ç®¡ç†ä¸»å‡½æ•°
# ======================================================

# ä¸»SVNç®¡ç†å™¨
svn_manager() {
#    if ! svn info &>/dev/null; then
#        $USE_GUM && gum style --foreground 196 "å½“å‰ç›®å½•ä¸æ˜¯ SVN å·¥ä½œå‰¯æœ¬!" || echo -e "\033[31må½“å‰ç›®å½•ä¸æ˜¯ SVN å·¥ä½œå‰¯æœ¬!\033[0m"
#        sleep 2
#        return
#    fi

    local options=(
        "ä»“åº“æ“ä½œ"
        "å·¥ä½œå‰¯æœ¬ç®¡ç†"
        "æäº¤ç®¡ç†"
        "åˆ†æ”¯ä¸æ ‡ç­¾"
        "æ›´æ–°ä¸åŒæ­¥"
        "æ—¥å¿—ç®¡ç†"
        "å·®å¼‚æ¯”è¾ƒ"
        "å±æ€§ç®¡ç†"
        "é«˜çº§æ“ä½œ"
        "é…ç½®å·¥å…·"
        "â†©ï¸ è¿”å›"
    )

    while true; do
        local repo_url=$(svn info --show-item repos-root-url)
        local current_rev=$(svn info --show-item revision)
        
        if $USE_GUM; then
            custom_gum_show2hide_header "SVN ç®¡ç†å™¨: $(gum style --foreground 212 "$repo_url")"
            custom_gum_show2hide_header "å½“å‰ç‰ˆæœ¬: $(gum style --foreground 99 "r$current_rev")"
        else
            echo -e "SVN ç®¡ç†å™¨: $repo_url"
            echo -e "å½“å‰ç‰ˆæœ¬: \033[1;35mr$current_rev\033[0m"
        fi

        local selection=$(printf '%s\n' "${options[@]}" | fzf \
            --height=30% \
            --reverse \
            --prompt="â¤ SVN > "
        )

        case "$selection" in
        *ä»“åº“æ“ä½œ*)
            svn_repository_manager
            ;;
        *å·¥ä½œå‰¯æœ¬ç®¡ç†*)
            svn_working_copy_manager
            ;;
        *æäº¤ç®¡ç†*)
            svn_commit_manager
            ;;
        *åˆ†æ”¯ä¸æ ‡ç­¾*)
            svn_branch_tag_manager
            ;;
        *æ›´æ–°ä¸åŒæ­¥*)
            svn_update_sync_manager
            ;;
        *æ—¥å¿—ç®¡ç†*)
            svn_log_manager
            ;;
        *å·®å¼‚æ¯”è¾ƒ*)
            svn_diff_manager
            ;;
        *å±æ€§ç®¡ç†*)
            svn_property_manager
            ;;
        *é«˜çº§æ“ä½œ*)
            svn_advanced_manager
            ;;
        *é…ç½®å·¥å…·*)
            svn_config_manager
            ;;
        "â†©ï¸ è¿”å›"|*)
            break
            ;;
        esac
    done
}

# ======================================================
# ä»“åº“æ“ä½œåŠŸèƒ½
# ======================================================

svn_repository_manager() {
    local options=(
        "æ£€å‡ºä»“åº“(checkout)"
        "åˆ›å»ºæ–°ä»“åº“(create)"
        "å¯¼å…¥é¡¹ç›®(import)"
        "æŸ¥çœ‹ä»“åº“ä¿¡æ¯(info)"
        "â†©ï¸ è¿”å›"
    )

    while true; do
        $USE_GUM && custom_gum_show2hide_header "SVN ä»“åº“æ“ä½œ" || echo -e "SVN ä»“åº“æ“ä½œ"

        local selection=$(printf '%s\n' "${options[@]}" | fzf \
            --height=30% \
            --reverse \
            --prompt="â¤ SVN ä»“åº“æ“ä½œ > "
        )

        case "$selection" in
        *æ£€å‡ºä»“åº“*)
            local repo_url=$(user_input "è¯·è¾“å…¥ä»“åº“URL: " "")
            local local_dir=$(user_input "è¯·è¾“å…¥æœ¬åœ°ç›®å½• (é»˜è®¤ä¸ºå½“å‰ç›®å½•): " ".")
            
            if [ -n "$repo_url" ]; then
                svn checkout "$repo_url" "$local_dir"
            else
                $USE_GUM && gum style --foreground 196 "ä»“åº“URLä¸èƒ½ä¸ºç©º!" || echo -e "\033[31mä»“åº“URLä¸èƒ½ä¸ºç©º!\033[0m"
            fi
            wait_for_key
            ;;
        *åˆ›å»ºæ–°ä»“åº“*)
            $USE_GUM && gum style --foreground 196 "SVNä»“åº“åˆ›å»ºéœ€è¦æœåŠ¡å™¨æƒé™ï¼Œé€šå¸¸é€šè¿‡svnadminåˆ›å»º!" || echo -e "\033[31mSVNä»“åº“åˆ›å»ºéœ€è¦æœåŠ¡å™¨æƒé™ï¼Œé€šå¸¸é€šè¿‡svnadminåˆ›å»º!\033[0m"
            wait_for_key
            ;;
        *å¯¼å…¥é¡¹ç›®*)
            local local_path=$(user_input "è¯·è¾“å…¥æœ¬åœ°é¡¹ç›®è·¯å¾„: " ".")
            local repo_url=$(user_input "è¯·è¾“å…¥ç›®æ ‡ä»“åº“URL: " "")
            local message=$(user_input "è¯·è¾“å…¥æäº¤ä¿¡æ¯: " "åˆå§‹å¯¼å…¥")
            
            if [ -n "$repo_url" ]; then
                svn import "$local_path" "$repo_url" -m "$message"
            else
                $USE_GUM && gum style --foreground 196 "ä»“åº“URLä¸èƒ½ä¸ºç©º!" || echo -e "\033[31mä»“åº“URLä¸èƒ½ä¸ºç©º!\033[0m"
            fi
            wait_for_key
            ;;
        *æŸ¥çœ‹ä»“åº“ä¿¡æ¯*)
            clear
            svn info
            wait_for_key
            ;;
        "â†©ï¸ è¿”å›"|*)
            break
            ;;
        esac
    done
}

# ======================================================
# å·¥ä½œå‰¯æœ¬ç®¡ç†åŠŸèƒ½
# ======================================================

svn_working_copy_manager() {
    local options=(
        "çŠ¶æ€æ£€æŸ¥(status)"
        "æ·»åŠ æ–‡ä»¶(add)"
        "åˆ é™¤æ–‡ä»¶(delete)"
        "æ¢å¤æ–‡ä»¶(revert)"
        "ç§»åŠ¨/é‡å‘½å(move)"
        "æ¸…ç†å·¥ä½œå‰¯æœ¬(cleanup)"
        "è§£å†³å†²çª(resolved)"
        "å¿½ç•¥æ–‡ä»¶/ç›®å½•(ignore)"
        "â†©ï¸ è¿”å›"
    )

    while true; do
        $USE_GUM && custom_gum_show2hide_header "SVN å·¥ä½œå‰¯æœ¬ç®¡ç†" || echo -e "SVN å·¥ä½œå‰¯æœ¬ç®¡ç†"

        local selection=$(printf '%s\n' "${options[@]}" | fzf \
            --height=30% \
            --reverse \
            --prompt="â¤ SVN å·¥ä½œå‰¯æœ¬ç®¡ç† > "
        )

        case "$selection" in
        *çŠ¶æ€æ£€æŸ¥*)
            clear
            svn status
            wait_for_key
            ;;
        *æ·»åŠ æ–‡ä»¶*)
            local files
            if $USE_GUM; then
                files=$(svn status | awk '/^\?/{print $2}' | gum choose --no-limit --height 10 --cursor.foreground 212 --item.foreground 99 --selected.foreground 212 --prompt "é€‰æ‹©è¦æ·»åŠ çš„æ–‡ä»¶: ")
            else
                files=$(svn status | awk '/^\?/{print $2}' | fzf -m --ansi --prompt="é€‰æ‹©è¦æ·»åŠ çš„æ–‡ä»¶> ")
            fi
            
            if [ -n "$files" ]; then
                echo "$files" | xargs svn add
            fi
            ;;
        *åˆ é™¤æ–‡ä»¶*)
            local files
            if $USE_GUM; then
                files=$(svn list -R | gum choose --no-limit --height 15 --cursor.foreground 212 --item.foreground 99 --selected.foreground 212 --prompt "é€‰æ‹©è¦åˆ é™¤çš„æ–‡ä»¶: ")
            else
                files=$(svn list -R | fzf -m --ansi --prompt="é€‰æ‹©è¦åˆ é™¤çš„æ–‡ä»¶> ")
            fi
            
            if [ -n "$files" ]; then
                echo "$files" | xargs svn delete
            fi
            ;;
        *æ¢å¤æ–‡ä»¶*)
            local files
            if $USE_GUM; then
                files=$(svn status | awk '/^[MA]/{print $2}' | gum choose --no-limit --height 10 --cursor.foreground 212 --item.foreground 99 --selected.foreground 212 --prompt "é€‰æ‹©è¦æ¢å¤çš„æ–‡ä»¶: ")
            else
                files=$(svn status | awk '/^[MA]/{print $2}' | fzf -m --ansi --prompt="é€‰æ‹©è¦æ¢å¤çš„æ–‡ä»¶> ")
            fi
            
            if [ -n "$files" ]; then
                echo "$files" | xargs svn revert
            fi
            ;;
        *ç§»åŠ¨/é‡å‘½å*)
            local source=$(user_input "è¯·è¾“å…¥æºæ–‡ä»¶/ç›®å½•è·¯å¾„: " "")
            local dest=$(user_input "è¯·è¾“å…¥ç›®æ ‡è·¯å¾„: " "")
            
            if [ -n "$source" ] && [ -n "$dest" ]; then
                svn move "$source" "$dest"
            fi
            ;;
        *æ¸…ç†å·¥ä½œå‰¯æœ¬*)
            svn cleanup
            $USE_GUM && gum style --foreground 46 "å·¥ä½œå‰¯æœ¬å·²æ¸…ç†!" || echo -e "\033[32må·¥ä½œå‰¯æœ¬å·²æ¸…ç†!\033[0m"
            sleep 1
            ;;
        *è§£å†³å†²çª*)
            local files
            if $USE_GUM; then
                files=$(svn status | awk '/^C/{print $2}' | gum choose --no-limit --height 10 --cursor.foreground 212 --item.foreground 99 --selected.foreground 212 --prompt "é€‰æ‹©å·²è§£å†³å†²çªçš„æ–‡ä»¶: ")
            else
                files=$(svn status | awk '/^C/{print $2}' | fzf -m --ansi --prompt="é€‰æ‹©å·²è§£å†³å†²çªçš„æ–‡ä»¶> ")
            fi
            
            if [ -n "$files" ]; then
                echo "$files" | xargs svn resolved
            fi
            ;;
        *å¿½ç•¥æ–‡ä»¶/ç›®å½•*)
            local path=$(user_input "è¯·è¾“å…¥è¦å¿½ç•¥çš„æ–‡ä»¶/ç›®å½•è·¯å¾„: " "")
            if [ -n "$path" ]; then
                svn propset svn:ignore "$path" .
            fi
            ;;
        "â†©ï¸ è¿”å›"|*)
            break
            ;;
        esac
    done
}

# ======================================================
# æäº¤ç®¡ç†åŠŸèƒ½
# ======================================================

svn_commit_manager() {
    local options=(
        "æäº¤æ›´æ”¹(commit)"
        "æŸ¥çœ‹å¾…æäº¤å†…å®¹(diff)"
        "é€‰æ‹©æ€§æäº¤(éƒ¨åˆ†æ–‡ä»¶)"
        "ç©ºæäº¤(ä»…ä¿®æ”¹å±æ€§)"
        "â†©ï¸ è¿”å›"
    )

    while true; do
        $USE_GUM && custom_gum_show2hide_header "SVN æäº¤ç®¡ç†" || echo -e "SVN æäº¤ç®¡ç†"

        local selection=$(printf '%s\n' "${options[@]}" | fzf \
            --height=30% \
            --reverse \
            --prompt="â¤ SVN æäº¤ç®¡ç† > "
        )

        case "$selection" in
        *æäº¤æ›´æ”¹*)
            local message=$(user_input "è¯·è¾“å…¥æäº¤ä¿¡æ¯: " "æ›´æ–°")
            svn commit -m "$message"
            ;;
        *æŸ¥çœ‹å¾…æäº¤å†…å®¹*)
            clear
            svn diff
            wait_for_key
            ;;
        *é€‰æ‹©æ€§æäº¤*)
            local files
            if $USE_GUM; then
                files=$(svn status | awk '/^[MA]/{print $2}' | gum choose --no-limit --height 15 --cursor.foreground 212 --item.foreground 99 --selected.foreground 212 --prompt "é€‰æ‹©è¦æäº¤çš„æ–‡ä»¶: ")
            else
                files=$(svn status | awk '/^[MA]/{print $2}' | fzf -m --ansi --prompt="é€‰æ‹©è¦æäº¤çš„æ–‡ä»¶> ")
            fi
            
            if [ -n "$files" ]; then
                local message=$(user_input "è¯·è¾“å…¥æäº¤ä¿¡æ¯: " "éƒ¨åˆ†æ›´æ–°")
                echo "$files" | xargs svn commit -m "$message"
            fi
            ;;
        *ç©ºæäº¤*)
            local message=$(user_input "è¯·è¾“å…¥æäº¤ä¿¡æ¯: " "å±æ€§ä¿®æ”¹")
            svn commit -m "$message" --depth empty .
            ;;
        "â†©ï¸ è¿”å›"|*)
            break
            ;;
        esac
    done
}

# ======================================================
# åˆ†æ”¯ä¸æ ‡ç­¾ç®¡ç†åŠŸèƒ½
# ======================================================

svn_branch_tag_manager() {
    local options=(
        "åˆ›å»ºåˆ†æ”¯(copy)"
        "åˆ›å»ºæ ‡ç­¾(copy)"
        "åˆ‡æ¢åˆ†æ”¯(switch)"
        "åˆå¹¶åˆ†æ”¯(merge)"
        "æŸ¥çœ‹åˆ†æ”¯åˆ—è¡¨(list)"
        "â†©ï¸ è¿”å›"
    )

    while true; do
        $USE_GUM && custom_gum_show2hide_header "SVN åˆ†æ”¯ä¸æ ‡ç­¾" || echo -e "SVN åˆ†æ”¯ä¸æ ‡ç­¾"

        local selection=$(printf '%s\n' "${options[@]}" | fzf \
            --height=30% \
            --reverse \
            --prompt="â¤ SVN åˆ†æ”¯/æ ‡ç­¾ > "
        )

        case "$selection" in
        *åˆ›å»ºåˆ†æ”¯*)
            local source_url=$(user_input "è¯·è¾“å…¥æºURL (é»˜è®¤ä¸ºå½“å‰è·¯å¾„): " "")
            local branch_name=$(user_input "è¯·è¾“å…¥åˆ†æ”¯åç§°: " "")
            local trunk_url=$(svn info --show-item repos-root-url)/trunk
            local branches_url=$(svn info --show-item repos-root-url)/branches
            
            if [ -z "$source_url" ]; then
                source_url="."
            fi
            
            if [ -n "$branch_name" ]; then
                svn copy "$source_url" "$branches_url/$branch_name" -m "åˆ›å»ºåˆ†æ”¯: $branch_name"
            fi
            ;;
        *åˆ›å»ºæ ‡ç­¾*)
            local source_url=$(user_input "è¯·è¾“å…¥æºURL (é»˜è®¤ä¸ºå½“å‰è·¯å¾„): " "")
            local tag_name=$(user_input "è¯·è¾“å…¥æ ‡ç­¾åç§°: " "")
            local trunk_url=$(svn info --show-item repos-root-url)/trunk
            local tags_url=$(svn info --show-item repos-root-url)/tags
            
            if [ -z "$source_url" ]; then
                source_url="."
            fi
            
            if [ -n "$tag_name" ]; then
                svn copy "$source_url" "$tags_url/$tag_name" -m "åˆ›å»ºæ ‡ç­¾: $tag_name"
            fi
            ;;
        *åˆ‡æ¢åˆ†æ”¯*)
            local branches_url=$(svn info --show-item repos-root-url)/branches
            local branches=$(svn list "$branches_url" 2>/dev/null)
            
            if [ -z "$branches" ]; then
                $USE_GUM && gum style --foreground 196 "æ²¡æœ‰æ‰¾åˆ°åˆ†æ”¯!" || echo -e "\033[31mæ²¡æœ‰æ‰¾åˆ°åˆ†æ”¯!\033[0m"
                sleep 1
                continue
            fi
            
            local selected
            if $USE_GUM; then
                selected=$(echo "$branches" | gum choose --height 15 --cursor.foreground 212 --item.foreground 99 --selected.foreground 212 --prompt "é€‰æ‹©åˆ†æ”¯: ")
            else
                selected=$(echo "$branches" | fzf --ansi --prompt="é€‰æ‹©åˆ†æ”¯> ")
            fi
            
            if [ -n "$selected" ]; then
                svn switch "$branches_url/$selected"
            fi
            ;;
        *åˆå¹¶åˆ†æ”¯*)
            local branches_url=$(svn info --show-item repos-root-url)/branches
            local branches=$(svn list "$branches_url" 2>/dev/null)
            
            if [ -z "$branches" ]; then
                $USE_GUM && gum style --foreground 196 "æ²¡æœ‰æ‰¾åˆ°åˆ†æ”¯!" || echo -e "\033[31mæ²¡æœ‰æ‰¾åˆ°åˆ†æ”¯!\033[0m"
                sleep 1
                continue
            fi
            
            local selected
            if $USE_GUM; then
                selected=$(echo "$branches" | gum choose --height 15 --cursor.foreground 212 --item.foreground 99 --selected.foreground 212 --prompt "é€‰æ‹©è¦åˆå¹¶çš„åˆ†æ”¯: ")
            else
                selected=$(echo "$branches" | fzf --ansi --prompt="é€‰æ‹©è¦åˆå¹¶çš„åˆ†æ”¯> ")
            fi
            
            if [ -n "$selected" ]; then
                svn merge "$branches_url/$selected"
            fi
            ;;
        *æŸ¥çœ‹åˆ†æ”¯åˆ—è¡¨*)
            clear
            local branches_url=$(svn info --show-item repos-root-url)/branches
            echo "=== åˆ†æ”¯åˆ—è¡¨ ==="
            svn list "$branches_url"
            echo ""
            
            local tags_url=$(svn info --show-item repos-root-url)/tags
            echo "=== æ ‡ç­¾åˆ—è¡¨ ==="
            svn list "$tags_url"
            wait_for_key
            ;;
        "â†©ï¸ è¿”å›"|*)
            break
            ;;
        esac
    done
}

# ======================================================
# æ›´æ–°ä¸åŒæ­¥ç®¡ç†åŠŸèƒ½
# ======================================================

svn_update_sync_manager() {
    local options=(
        "æ›´æ–°å·¥ä½œå‰¯æœ¬(update)"
        "æ›´æ–°åˆ°ç‰¹å®šç‰ˆæœ¬(-r)"
        "æŸ¥çœ‹æ›´æ–°å†…å®¹(diff)"
        "æŸ¥çœ‹è¿œç¨‹å˜æ›´(status -u)"
        "é”å®šæ–‡ä»¶(lock)"
        "è§£é”æ–‡ä»¶(unlock)"
        "â†©ï¸ è¿”å›"
    )

    while true; do
        $USE_GUM && custom_gum_show2hide_header "SVN æ›´æ–°ä¸åŒæ­¥" || echo -e "SVN æ›´æ–°ä¸åŒæ­¥"

        local selection=$(printf '%s\n' "${options[@]}" | fzf \
            --height=30% \
            --reverse \
            --prompt="â¤ SVN æ›´æ–°/åŒæ­¥ > "
        )

        case "$selection" in
        *æ›´æ–°å·¥ä½œå‰¯æœ¬*)
            svn update
            ;;
        *æ›´æ–°åˆ°ç‰¹å®šç‰ˆæœ¬*)
            local revision=$(user_input "è¯·è¾“å…¥ç‰ˆæœ¬å·: " "")
            if [[ "$revision" =~ ^[0-9]+$ ]]; then
                svn update -r "$revision"
            else
                $USE_GUM && gum style --foreground 196 "æ— æ•ˆçš„ç‰ˆæœ¬å·!" || echo -e "\033[31mæ— æ•ˆçš„ç‰ˆæœ¬å·!\033[0m"
            fi
            ;;
        *æŸ¥çœ‹æ›´æ–°å†…å®¹*)
            clear
            svn diff
            wait_for_key
            ;;
        *æŸ¥çœ‹è¿œç¨‹å˜æ›´*)
            clear
            svn status -u
            wait_for_key
            ;;
        *é”å®šæ–‡ä»¶*)
            local file=$(user_input "è¯·è¾“å…¥è¦é”å®šçš„æ–‡ä»¶è·¯å¾„: " "")
            local message=$(user_input "è¯·è¾“å…¥é”å®šä¿¡æ¯: " "é”å®šç¼–è¾‘")
            
            if [ -n "$file" ]; then
                svn lock "$file" -m "$message"
            fi
            ;;
        *è§£é”æ–‡ä»¶*)
            local file=$(user_input "è¯·è¾“å…¥è¦è§£é”çš„æ–‡ä»¶è·¯å¾„: " "")
            
            if [ -n "$file" ]; then
                svn unlock "$file"
            fi
            ;;
        "â†©ï¸ è¿”å›"|*)
            break
            ;;
        esac
    done
}

# ======================================================
# æ—¥å¿—ç®¡ç†åŠŸèƒ½
# ======================================================

svn_log_manager() {
    local options=(
        "æŸ¥çœ‹å®Œæ•´æ—¥å¿—(log)"
        "æŸ¥çœ‹ç®€åŒ–æ—¥å¿—(-v)"
        "æŸ¥çœ‹ç‰¹å®šæ–‡ä»¶æ—¥å¿—"
        "æŒ‰ä½œè€…æŸ¥çœ‹æ—¥å¿—(-r)"
        "æŒ‰æ—¥æœŸèŒƒå›´æŸ¥çœ‹æ—¥å¿—"
        "æœç´¢æ—¥å¿—æ¶ˆæ¯(-s)"
        "â†©ï¸ è¿”å›"
    )

    while true; do
        $USE_GUM && custom_gum_show2hide_header "SVN æ—¥å¿—ç®¡ç†" || echo -e "SVN æ—¥å¿—ç®¡ç†"

        local selection=$(printf '%s\n' "${options[@]}" | fzf \
            --height=30% \
            --reverse \
            --prompt="â¤ SVN æ—¥å¿—ç®¡ç† > "
        )
        
        case "$selection" in
        *æŸ¥çœ‹å®Œæ•´æ—¥å¿—*)
            clear
            svn log
            wait_for_key
            ;;
        *æŸ¥çœ‹ç®€åŒ–æ—¥å¿—*)
            clear
            svn log -v
            wait_for_key
            ;;
        *æŸ¥çœ‹ç‰¹å®šæ–‡ä»¶æ—¥å¿—*)
            local file=$(user_input "è¯·è¾“å…¥æ–‡ä»¶è·¯å¾„: " "")
            if [ -n "$file" ]; then
                clear
                svn log "$file"
                wait_for_key
            fi
            ;;
        *æŒ‰ä½œè€…æŸ¥çœ‹æ—¥å¿—*)
            local author=$(user_input "è¯·è¾“å…¥ä½œè€…åç§°: " "")
            if [ -n "$author" ]; then
                clear
                svn log --search "$author"
                wait_for_key
            fi
            ;;
        *æŒ‰æ—¥æœŸèŒƒå›´æŸ¥çœ‹æ—¥å¿—*)
            local start_date=$(user_input "è¯·è¾“å…¥å¼€å§‹æ—¥æœŸ (YYYY-MM-DD): " "")
            local end_date=$(user_input "è¯·è¾“å…¥ç»“æŸæ—¥æœŸ (YYYY-MM-DD): " "$(date +%Y-%m-%d)")
            
            if [ -n "$start_date" ]; then
                clear
                svn log -r "{$start_date}:{$end_date}"
                wait_for_key
            fi
            ;;
        *æœç´¢æ—¥å¿—æ¶ˆæ¯*)
            local search_term=$(user_input "è¯·è¾“å…¥æœç´¢å…³é”®è¯: " "")
            if [ -n "$search_term" ]; then
                clear
                svn log --search "$search_term"
                wait_for_key
            fi
            ;;
        "â†©ï¸ è¿”å›"|*)
            break
            ;;
        esac
    done
}

# ======================================================
# å·®å¼‚æ¯”è¾ƒåŠŸèƒ½
# ======================================================

svn_diff_manager() {
    local options=(
        "æ¯”è¾ƒå·¥ä½œå‰¯æœ¬ä¸åŸºç¡€ç‰ˆæœ¬"
        "æ¯”è¾ƒä¸¤ä¸ªç‰ˆæœ¬(-r)"
        "æ¯”è¾ƒç‰¹å®šæ–‡ä»¶"
        "ä¸ç‰¹å®šç‰ˆæœ¬æ¯”è¾ƒ"
        "â†©ï¸ è¿”å›"
    )

    while true; do
        $USE_GUM && custom_gum_show2hide_header "SVN å·®å¼‚æ¯”è¾ƒ" || echo -e "SVN å·®å¼‚æ¯”è¾ƒ"

        local selection=$(printf '%s\n' "${options[@]}" | fzf \
            --height=30% \
            --reverse \
            --prompt="â¤ SVN å·®å¼‚æ¯”è¾ƒ > "
        )

        case "$selection" in
        *æ¯”è¾ƒå·¥ä½œå‰¯æœ¬ä¸åŸºç¡€ç‰ˆæœ¬*)
            clear
            svn diff
            wait_for_key
            ;;
        *æ¯”è¾ƒä¸¤ä¸ªç‰ˆæœ¬*)
            local rev1=$(user_input "è¯·è¾“å…¥èµ·å§‹ç‰ˆæœ¬å·: " "")
            local rev2=$(user_input "è¯·è¾“å…¥ç»“æŸç‰ˆæœ¬å·: " "")
            
            if [[ "$rev1" =~ ^[0-9]+$ ]] && [[ "$rev2" =~ ^[0-9]+$ ]]; then
                clear
                svn diff -r "$rev1:$rev2"
                wait_for_key
            else
                $USE_GUM && gum style --foreground 196 "æ— æ•ˆçš„ç‰ˆæœ¬å·!" || echo -e "\033[31mæ— æ•ˆçš„ç‰ˆæœ¬å·!\033[0m"
            fi
            ;;
        *æ¯”è¾ƒç‰¹å®šæ–‡ä»¶*)
            local file=$(user_input "è¯·è¾“å…¥æ–‡ä»¶è·¯å¾„: " "")
            if [ -n "$file" ]; then
                clear
                svn diff "$file"
                wait_for_key
            fi
            ;;
        *ä¸ç‰¹å®šç‰ˆæœ¬æ¯”è¾ƒ*)
            local revision=$(user_input "è¯·è¾“å…¥ç‰ˆæœ¬å·: " "")
            if [[ "$revision" =~ ^[0-9]+$ ]]; then
                clear
                svn diff -r "$revision"
                wait_for_key
            else
                $USE_GUM && gum style --foreground 196 "æ— æ•ˆçš„ç‰ˆæœ¬å·!" || echo -e "\033[31mæ— æ•ˆçš„ç‰ˆæœ¬å·!\033[0m"
            fi
            ;;
        "â†©ï¸ è¿”å›"|*)
            break
            ;;
        esac
    done
}

# ======================================================
# å±æ€§ç®¡ç†åŠŸèƒ½
# ======================================================

svn_property_manager() {
    local options=(
        "è®¾ç½®å±æ€§(pset)"
        "è·å–å±æ€§(pget)"
        "åˆ—å‡ºæ‰€æœ‰å±æ€§(plist)"
        "åˆ é™¤å±æ€§(pdel)"
        "ç¼–è¾‘å±æ€§(pedit)"
        "â†©ï¸ è¿”å›"
    )

    while true; do
        $USE_GUM && custom_gum_show2hide_header "SVN å±æ€§ç®¡ç†" || echo -e "SVN å±æ€§ç®¡ç†"

        local selection=$(printf '%s\n' "${options[@]}" | fzf \
            --height=30% \
            --reverse \
            --prompt="â¤ SVN å±æ€§ç®¡ç† > "
        )

        case "$selection" in
        *è®¾ç½®å±æ€§*)
            local path=$(user_input "è¯·è¾“å…¥æ–‡ä»¶/ç›®å½•è·¯å¾„: " ".")
            local prop_name=$(user_input "è¯·è¾“å…¥å±æ€§å: " "")
            local prop_value=$(user_input "è¯·è¾“å…¥å±æ€§å€¼: " "")
            
            if [ -n "$prop_name" ] && [ -n "$prop_value" ]; then
                svn propset "$prop_name" "$prop_value" "$path"
            fi
            ;;
        *è·å–å±æ€§*)
            local path=$(user_input "è¯·è¾“å…¥æ–‡ä»¶/ç›®å½•è·¯å¾„: " ".")
            local prop_name=$(user_input "è¯·è¾“å…¥å±æ€§å: " "")
            
            if [ -n "$prop_name" ]; then
                clear
                svn propget "$prop_name" "$path"
                wait_for_key
            fi
            ;;
        *åˆ—å‡ºæ‰€æœ‰å±æ€§*)
            local path=$(user_input "è¯·è¾“å…¥æ–‡ä»¶/ç›®å½•è·¯å¾„: " ".")
            clear
            svn proplist "$path" -v
            wait_for_key
            ;;
        *åˆ é™¤å±æ€§*)
            local path=$(user_input "è¯·è¾“å…¥æ–‡ä»¶/ç›®å½•è·¯å¾„: " ".")
            local prop_name=$(user_input "è¯·è¾“å…¥å±æ€§å: " "")
            
            if [ -n "$prop_name" ]; then
                svn propdel "$prop_name" "$path"
            fi
            ;;
        *ç¼–è¾‘å±æ€§*)
            local path=$(user_input "è¯·è¾“å…¥æ–‡ä»¶/ç›®å½•è·¯å¾„: " ".")
            local prop_name=$(user_input "è¯·è¾“å…¥å±æ€§å: " "")
            
            if [ -n "$prop_name" ]; then
                svn propedit "$prop_name" "$path"
            fi
            ;;
        "â†©ï¸ è¿”å›"|*)
            break
            ;;
        esac
    done
}

# ======================================================
# é«˜çº§æ“ä½œåŠŸèƒ½
# ======================================================

svn_advanced_manager() {
    local options=(
        "å¯¼å‡ºå·¥ä½œå‰¯æœ¬(export)"
        "åˆ›å»ºè¡¥ä¸(patch)"
        "åº”ç”¨è¡¥ä¸(patch)"
        "æŸ¥çœ‹æ–‡ä»¶å†…å®¹(cat)"
        "æŸ¥çœ‹æ–‡ä»¶å†å²(blame)"
        "ä»“åº“åŒæ­¥(sync)"
        "â†©ï¸ è¿”å›"
    )

    while true; do
        $USE_GUM && custom_gum_show2hide_header "SVN é«˜çº§æ“ä½œ" || echo -e "SVN é«˜çº§æ“ä½œ"

        local selection=$(printf '%s\n' "${options[@]}" | fzf \
            --height=30% \
            --reverse \
            --prompt="â¤ SVN é«˜çº§æ“ä½œ > "
        )

        case "$selection" in
        *å¯¼å‡ºå·¥ä½œå‰¯æœ¬*)
            local export_dir=$(user_input "è¯·è¾“å…¥å¯¼å‡ºç›®å½•: " "")
            if [ -n "$export_dir" ]; then
                svn export . "$export_dir"
            fi
            ;;
        *åˆ›å»ºè¡¥ä¸*)
            local patch_file=$(user_input "è¯·è¾“å…¥è¡¥ä¸æ–‡ä»¶å: " "changes.patch")
            svn diff > "$patch_file"
            $USE_GUM && gum style --foreground 46 "è¡¥ä¸å·²åˆ›å»º: $patch_file" || echo -e "\033[32mè¡¥ä¸å·²åˆ›å»º: $patch_file\033[0m"
            sleep 1
            ;;
        *åº”ç”¨è¡¥ä¸*)
            local patch_file=$(user_input "è¯·è¾“å…¥è¡¥ä¸æ–‡ä»¶å: " "changes.patch")
            if [ -f "$patch_file" ]; then
                patch -p0 < "$patch_file"
            else
                $USE_GUM && gum style --foreground 196 "æ–‡ä»¶ä¸å­˜åœ¨: $patch_file" || echo -e "\033[31mæ–‡ä»¶ä¸å­˜åœ¨: $patch_file\033[0m"
            fi
            sleep 1
            ;;
        *æŸ¥çœ‹æ–‡ä»¶å†…å®¹*)
            local file=$(user_input "è¯·è¾“å…¥æ–‡ä»¶è·¯å¾„: " "")
            if [ -n "$file" ]; then
                clear
                svn cat "$file"
                wait_for_key
            fi
            ;;
        *æŸ¥çœ‹æ–‡ä»¶å†å²*)
            local file=$(user_input "è¯·è¾“å…¥æ–‡ä»¶è·¯å¾„: " "")
            if [ -n "$file" ]; then
                clear
                svn blame "$file"
                wait_for_key
            fi
            ;;
        *ä»“åº“åŒæ­¥*)
            $USE_GUM && gum style --foreground 196 "è­¦å‘Š: æ­¤æ“ä½œå°†åŒæ­¥æ•´ä¸ªä»“åº“ï¼Œå¯èƒ½éœ€è¦è¾ƒé•¿æ—¶é—´!" || echo -e "\033[31mè­¦å‘Š: æ­¤æ“ä½œå°†åŒæ­¥æ•´ä¸ªä»“åº“ï¼Œå¯èƒ½éœ€è¦è¾ƒé•¿æ—¶é—´!\033[0m"
            if confirm_action "ç¡®å®šè¦åŒæ­¥æ•´ä¸ªä»“åº“å—?"; then
                svn update --force
            fi
            ;;
        "â†©ï¸ è¿”å›"|*)
            break
            ;;
        esac
    done
}

# ======================================================
# é…ç½®å·¥å…·åŠŸèƒ½
# ======================================================

svn_config_manager() {
    local options=(
        "æŸ¥çœ‹é…ç½®(config)"
        "è®¾ç½®é»˜è®¤ç¼–è¾‘å™¨"
        "è®¾ç½®è‡ªåŠ¨å±æ€§(auto-props)"
        "è®¾ç½®å¿½ç•¥æ¨¡å¼(ignore)"
        "è®¾ç½®å…¨å±€å¿½ç•¥(global-ignores)"
        "â†©ï¸ è¿”å›"
    )

    while true; do
        $USE_GUM && custom_gum_show2hide_header "SVN é…ç½®å·¥å…·" || echo -e "SVN é…ç½®å·¥å…·"

        local selection=$(printf '%s\n' "${options[@]}" | fzf \
            --height=30% \
            --reverse \
            --prompt="â¤ SVN é…ç½®å·¥å…· > "
        )

        case "$selection" in
        *æŸ¥çœ‹é…ç½®*)
            clear
            svn config list
            wait_for_key
            ;;
        *è®¾ç½®é»˜è®¤ç¼–è¾‘å™¨*)
            local editor=$(user_input "è¯·è¾“å…¥ç¼–è¾‘å™¨å‘½ä»¤ (å¦‚: vim, nano): " "vim")
            svn config set editor "$editor"
            ;;
        *è®¾ç½®è‡ªåŠ¨å±æ€§*)
            local pattern=$(user_input "è¯·è¾“å…¥æ–‡ä»¶æ¨¡å¼ (å¦‚: *.txt): " "")
            local props=$(user_input "è¯·è¾“å…¥å±æ€§ (å¦‚: svn:eol-style=native): " "")
            
            if [ -n "$pattern" ] && [ -n "$props" ]; then
                svn config set auto-props "$pattern = $props"
            fi
            ;;
        *è®¾ç½®å¿½ç•¥æ¨¡å¼*)
            local pattern=$(user_input "è¯·è¾“å…¥å¿½ç•¥æ¨¡å¼ (å¦‚: *.tmp): " "")
            if [ -n "$pattern" ]; then
                svn config set ignore "$pattern"
            fi
            ;;
        *è®¾ç½®å…¨å±€å¿½ç•¥*)
            local patterns=$(user_input "è¯·è¾“å…¥å…¨å±€å¿½ç•¥æ¨¡å¼ (å¦‚: *.log *.bak): " "")
            if [ -n "$patterns" ]; then
                svn config set global-ignores "$patterns"
            fi
            ;;
        "â†©ï¸ è¿”å›"|*)
            break
            ;;
        esac
    done
}

# ======================================================
# Mercurial (hg) ç®¡ç†ä¸»å‡½æ•°
# ======================================================

# ä¸»hgç®¡ç†å™¨
hg_manager() {
#    if ! hg root &>/dev/null; then
#        $USE_GUM && gum style --foreground 196 "å½“å‰ç›®å½•ä¸æ˜¯ Mercurial ä»“åº“!" || echo -e "\033[31må½“å‰ç›®å½•ä¸æ˜¯ Mercurial ä»“åº“!\033[0m"
#        sleep 2
#        return
#    fi

    local options=(
        "ä»“åº“ç®¡ç†"
        "å·¥ä½œå‰¯æœ¬ç®¡ç†"
        "æäº¤ç®¡ç†"
        "åˆ†æ”¯ç®¡ç†"
        "æ ‡ç­¾ç®¡ç†"
        "æ›´æ–°ä¸åŒæ­¥"
        "æ—¥å¿—ç®¡ç†"
        "å·®å¼‚æ¯”è¾ƒ"
        "ä¹¦ç­¾ç®¡ç†"
        "è¡¥ä¸ç®¡ç†"
        "é«˜çº§æ“ä½œ"
        "é…ç½®å·¥å…·"
        "â†©ï¸ è¿”å›"
    )

    while true; do
        local repo_path=$(hg root)
        local repo_name=$(basename "$repo_path")
        local current_branch=$(hg branch)
        
        if $USE_GUM; then
            custom_gum_show2hide_header "Mercurial ç®¡ç†å™¨: $(gum style --foreground 212 "$repo_name")"
            custom_gum_show2hide_header "å½“å‰åˆ†æ”¯: $(gum style --foreground 99 "$current_branch")"
        else
            echo -e "Mercurial ç®¡ç†å™¨: $repo_name"
            echo -e "å½“å‰åˆ†æ”¯: \033[1;35m$current_branch\033[0m"
        fi

        local selection=$(printf '%s\n' "${options[@]}" | fzf \
            --height=30% \
            --reverse \
            --prompt="â¤ Mercurial ç®¡ç†å™¨ > "
        )

        case "$selection" in
        *ä»“åº“ç®¡ç†*)
            hg_repository_manager
            ;;
        *å·¥ä½œå‰¯æœ¬ç®¡ç†*)
            hg_working_copy_manager
            ;;
        *æäº¤ç®¡ç†*)
            hg_commit_manager
            ;;
        *åˆ†æ”¯ç®¡ç†*)
            hg_branch_manager
            ;;
        *æ ‡ç­¾ç®¡ç†*)
            hg_tag_manager
            ;;
        *æ›´æ–°ä¸åŒæ­¥*)
            hg_update_sync_manager
            ;;
        *æ—¥å¿—ç®¡ç†*)
            hg_log_manager
            ;;
        *å·®å¼‚æ¯”è¾ƒ*)
            hg_diff_manager
            ;;
        *ä¹¦ç­¾ç®¡ç†*)
            hg_bookmark_manager
            ;;
        *è¡¥ä¸ç®¡ç†*)
            hg_patch_manager
            ;;
        *é«˜çº§æ“ä½œ*)
            hg_advanced_manager
            ;;
        *é…ç½®å·¥å…·*)
            hg_config_manager
            ;;
        "â†©ï¸ è¿”å›"|*)
            break
            ;;
        esac
    done
}

# ======================================================
# ä»“åº“ç®¡ç†åŠŸèƒ½
# ======================================================

hg_repository_manager() {
    local options=(
        "åˆå§‹åŒ–æ–°ä»“åº“(init)"
        "å…‹éš†è¿œç¨‹ä»“åº“(clone)"
        "æŸ¥çœ‹ä»“åº“ä¿¡æ¯(summary)"
        "å½’æ¡£ä»“åº“(archive)"
        "â†©ï¸ è¿”å›"
    )

    while true; do
        $USE_GUM && custom_gum_show2hide_header "Mercurial ä»“åº“ç®¡ç†" || echo -e "Mercurial ä»“åº“ç®¡ç†"

        local selection=$(printf '%s\n' "${options[@]}" | fzf \
            --height=30% \
            --reverse \
            --prompt="â¤ Mercurial ä»“åº“ç®¡ç† > "
        )

        case "$selection" in
        *åˆå§‹åŒ–æ–°ä»“åº“*)
            local repo_path=$(user_input "è¯·è¾“å…¥ä»“åº“è·¯å¾„ï¼ˆé»˜è®¤ä¸ºå½“å‰ç›®å½•ï¼‰: " ".")
            hg init "$repo_path"
            $USE_GUM && gum style --foreground 46 "ä»“åº“åˆå§‹åŒ–æˆåŠŸ!" || echo -e "\033[32mä»“åº“åˆå§‹åŒ–æˆåŠŸ!\033[0m"
            sleep 1
            ;;
        *å…‹éš†è¿œç¨‹ä»“åº“*)
            local repo_url=$(user_input "è¯·è¾“å…¥è¿œç¨‹ä»“åº“URL: " "")
            local local_dir=$(user_input "è¯·è¾“å…¥æœ¬åœ°ç›®å½•ï¼ˆé»˜è®¤ä¸ºå½“å‰ç›®å½•ï¼‰: " ".")
            
            if [ -n "$repo_url" ]; then
                hg clone "$repo_url" "$local_dir"
            else
                $USE_GUM && gum style --foreground 196 "URL ä¸èƒ½ä¸ºç©º!" || echo -e "\033[31mURL ä¸èƒ½ä¸ºç©º!\033[0m"
            fi
            sleep 1
            ;;
        *æŸ¥çœ‹ä»“åº“ä¿¡æ¯*)
            clear
            hg summary
            wait_for_key
            ;;
        *å½’æ¡£ä»“åº“*)
            local archive_path=$(user_input "è¯·è¾“å…¥å½’æ¡£è·¯å¾„: " "repo_archive.zip")
            hg archive "$archive_path"
            $USE_GUM && gum style --foreground 46 "ä»“åº“å·²å½’æ¡£: $archive_path" || echo -e "\033[32mä»“åº“å·²å½’æ¡£: $archive_path\033[0m"
            sleep 1
            ;;
        "â†©ï¸ è¿”å›"|*)
            break
            ;;
        esac
    done
}

# ======================================================
# å·¥ä½œå‰¯æœ¬ç®¡ç†åŠŸèƒ½
# ======================================================

hg_working_copy_manager() {
    local options=(
        "çŠ¶æ€æ£€æŸ¥(status)"
        "æ·»åŠ æ–‡ä»¶(add)"
        "åˆ é™¤æ–‡ä»¶(remove)"
        "é‡å‘½åæ–‡ä»¶(rename)"
        "æ¢å¤æ–‡ä»¶(revert)"
        "æ¸…é™¤æœªè·Ÿè¸ªæ–‡ä»¶(purge)"
        "å¿½ç•¥æ–‡ä»¶/ç›®å½•(ignore)"
        "æŸ¥çœ‹å¿½ç•¥æ–‡ä»¶(ignored)"
        "â†©ï¸ è¿”å›"
    )

    while true; do
        $USE_GUM && custom_gum_show2hide_header "Mercurial å·¥ä½œå‰¯æœ¬ç®¡ç†" || echo -e "Mercurial å·¥ä½œå‰¯æœ¬ç®¡ç†"

        local selection=$(printf '%s\n' "${options[@]}" | fzf \
            --height=30% \
            --reverse \
            --prompt="â¤ Mercurial å·¥ä½œå‰¯æœ¬ç®¡ç† > "
        )

        case "$selection" in
        *çŠ¶æ€æ£€æŸ¥*)
            clear
            hg status
            wait_for_key
            ;;
        *æ·»åŠ æ–‡ä»¶*)
            local files
            if $USE_GUM; then
                files=$(hg status -un | gum choose --no-limit --height 15 --cursor.foreground 212 --item.foreground 99 --selected.foreground 212 --prompt "é€‰æ‹©è¦æ·»åŠ çš„æ–‡ä»¶: ")
            else
                files=$(hg status -un | fzf -m --ansi --prompt="é€‰æ‹©è¦æ·»åŠ çš„æ–‡ä»¶> ")
            fi
            
            if [ -n "$files" ]; then
                echo "$files" | xargs hg add
            fi
            ;;
        *åˆ é™¤æ–‡ä»¶*)
            local files
            if $USE_GUM; then
                files=$(hg status -mn | gum choose --no-limit --height 15 --cursor.foreground 212 --item.foreground 99 --selected.foreground 212 --prompt "é€‰æ‹©è¦åˆ é™¤çš„æ–‡ä»¶: ")
            else
                files=$(hg status -mn | fzf -m --ansi --prompt="é€‰æ‹©è¦åˆ é™¤çš„æ–‡ä»¶> ")
            fi
            
            if [ -n "$files" ]; then
                echo "$files" | xargs hg remove
            fi
            ;;
        *é‡å‘½åæ–‡ä»¶*)
            local source=$(user_input "è¯·è¾“å…¥æºæ–‡ä»¶è·¯å¾„: " "")
            local dest=$(user_input "è¯·è¾“å…¥ç›®æ ‡è·¯å¾„: " "")
            
            if [ -n "$source" ] && [ -n "$dest" ]; then
                hg rename "$source" "$dest"
            fi
            ;;
        *æ¢å¤æ–‡ä»¶*)
            local files
            if $USE_GUM; then
                files=$(hg status -mn | gum choose --no-limit --height 15 --cursor.foreground 212 --item.foreground 99 --selected.foreground 212 --prompt "é€‰æ‹©è¦æ¢å¤çš„æ–‡ä»¶: ")
            else
                files=$(hg status -mn | fzf -m --ansi --prompt="é€‰æ‹©è¦æ¢å¤çš„æ–‡ä»¶> ")
            fi
            
            if [ -n "$files" ]; then
                echo "$files" | xargs hg revert
            fi
            ;;
        *æ¸…é™¤æœªè·Ÿè¸ªæ–‡ä»¶*)
            if confirm_action "ç¡®å®šè¦æ¸…é™¤æ‰€æœ‰æœªè·Ÿè¸ªæ–‡ä»¶å—?"; then
                hg purge
            fi
            ;;
        *å¿½ç•¥æ–‡ä»¶/ç›®å½•*)
            local pattern=$(user_input "è¯·è¾“å…¥è¦å¿½ç•¥çš„æ¨¡å¼ (å¦‚: *.tmp): " "")
            if [ -n "$pattern" ]; then
                echo "$pattern" >> .hgignore
                $USE_GUM && gum style --foreground 46 "å·²æ·»åŠ åˆ°.hgignore" || echo -e "\033[32må·²æ·»åŠ åˆ°.hgignore\033[0m"
            fi
            sleep 1
            ;;
        *æŸ¥çœ‹å¿½ç•¥æ–‡ä»¶*)
            clear
            hg ignored
            wait_for_key
            ;;
        "â†©ï¸ è¿”å›"|*)
            break
            ;;
        esac
    done
}

# ======================================================
# æäº¤ç®¡ç†åŠŸèƒ½
# ======================================================

hg_commit_manager() {
    local options=(
        "æäº¤æ›´æ”¹(commit)"
        "ä¿®æ”¹æœ€è¿‘æäº¤(--amend)"
        "æŸ¥çœ‹æäº¤å†å²(log)"
        "æŸ¥çœ‹æäº¤è¯¦æƒ…(show)"
        "å›æ»šæäº¤(rollback)"
        "â†©ï¸ è¿”å›"
    )

    while true; do
        $USE_GUM && custom_gum_show2hide_header "Mercurial æäº¤ç®¡ç†" || echo -e "Mercurial æäº¤ç®¡ç†"

        local selection=$(printf '%s\n' "${options[@]}" | fzf \
            --height=30% \
            --reverse \
            --prompt="â¤ Mercurial æäº¤ç®¡ç† > "
        )

        case "$selection" in
        *æäº¤æ›´æ”¹*)
            local message=$(user_input "è¯·è¾“å…¥æäº¤ä¿¡æ¯: " "æ›´æ–°")
            hg commit -m "$message"
            ;;
        *ä¿®æ”¹æœ€è¿‘æäº¤*)
            local message=$(user_input "è¯·è¾“å…¥æ–°çš„æäº¤ä¿¡æ¯: " "ä¿®æ­£æäº¤")
            hg commit --amend -m "$message"
            $USE_GUM && gum style --foreground 46 "æœ€è¿‘æäº¤å·²ä¿®æ”¹!" || echo -e "\033[32mæœ€è¿‘æäº¤å·²ä¿®æ”¹!\033[0m"
            sleep 1
            ;;
        *æŸ¥çœ‹æäº¤å†å²*)
            clear
            hg log
            wait_for_key
            ;;
        *æŸ¥çœ‹æäº¤è¯¦æƒ…*)
            local rev
            if $USE_GUM; then
                rev=$(hg log --template "{rev}: {desc|firstline}\n" | gum choose --height 15 --cursor.foreground 212 --item.foreground 99 --selected.foreground 212 --prompt "é€‰æ‹©æäº¤: " | cut -d':' -f1)
            else
                rev=$(hg log --template "{rev}: {desc|firstline}\n" | fzf --ansi --prompt="é€‰æ‹©æäº¤> " | cut -d':' -f1)
            fi
            
            if [ -n "$rev" ]; then
                clear
                hg show "$rev"
                wait_for_key
            fi
            ;;
        *å›æ»šæäº¤*)
            if confirm_action "è­¦å‘Š: å›æ»šæ“ä½œå°†æ’¤é”€æœ€åä¸€æ¬¡æäº¤! ç¡®å®šç»§ç»­å—?"; then
                hg rollback
                $USE_GUM && gum style --foreground 46 "æœ€åä¸€æ¬¡æäº¤å·²å›æ»š!" || echo -e "\033[32mæœ€åä¸€æ¬¡æäº¤å·²å›æ»š!\033[0m"
            fi
            sleep 1
            ;;
        "â†©ï¸ è¿”å›"|*)
            break
            ;;
        esac
    done
}

# ======================================================
# åˆ†æ”¯ç®¡ç†åŠŸèƒ½
# ======================================================

hg_branch_manager() {
    local options=(
        "æŸ¥çœ‹åˆ†æ”¯åˆ—è¡¨"
        "åˆ›å»ºæ–°åˆ†æ”¯"
        "åˆ‡æ¢åˆ†æ”¯"
        "åˆå¹¶åˆ†æ”¯"
        "å…³é—­åˆ†æ”¯"
        "æŸ¥çœ‹æ´»åŠ¨åˆ†æ”¯"
        "â†©ï¸ è¿”å›"
    )

    while true; do
        $USE_GUM && custom_gum_show2hide_header "Mercurial åˆ†æ”¯ç®¡ç†" || echo -e "Mercurial åˆ†æ”¯ç®¡ç†"

        local selection=$(printf '%s\n' "${options[@]}" | fzf \
            --height=30% \
            --reverse \
            --prompt="â¤ Mercurial åˆ†æ”¯ç®¡ç† > "
        )

        case "$selection" in
        *æŸ¥çœ‹åˆ†æ”¯åˆ—è¡¨*)
            clear
            hg branches
            wait_for_key
            ;;
        *åˆ›å»ºæ–°åˆ†æ”¯*)
            local branch_name=$(user_input "è¯·è¾“å…¥æ–°åˆ†æ”¯å: " "")
            if [ -n "$branch_name" ]; then
                hg branch "$branch_name"
            fi
            ;;
        *åˆ‡æ¢åˆ†æ”¯*)
            local branches=$(hg branches | awk '{print $1}')
            local selected
            
            if $USE_GUM; then
                selected=$(echo "$branches" | gum choose --height 15 --cursor.foreground 212 --item.foreground 99 --selected.foreground 212 --prompt "é€‰æ‹©è¦åˆ‡æ¢çš„åˆ†æ”¯: ")
            else
                selected=$(echo "$branches" | fzf --ansi --prompt="é€‰æ‹©è¦åˆ‡æ¢çš„åˆ†æ”¯> ")
            fi
            
            if [ -n "$selected" ]; then
                hg update "$selected"
            fi
            ;;
        *åˆå¹¶åˆ†æ”¯*)
            local branches=$(hg branches | awk '{print $1}')
            local selected
            
            if $USE_GUM; then
                selected=$(echo "$branches" | gum choose --height 15 --cursor.foreground 212 --item.foreground 99 --selected.foreground 212 --prompt "é€‰æ‹©è¦åˆå¹¶çš„åˆ†æ”¯: ")
            else
                selected=$(echo "$branches" | fzf --ansi --prompt="é€‰æ‹©è¦åˆå¹¶çš„åˆ†æ”¯> ")
            fi
            
            if [ -n "$selected" ]; then
                hg merge "$selected"
            fi
            ;;
        *å…³é—­åˆ†æ”¯*)
            local branches=$(hg branches | awk '{print $1}')
            local selected
            
            if $USE_GUM; then
                selected=$(echo "$branches" | gum choose --height 15 --cursor.foreground 212 --item.foreground 99 --selected.foreground 212 --prompt "é€‰æ‹©è¦å…³é—­çš„åˆ†æ”¯: ")
            else
                selected=$(echo "$branches" | fzf --ansi --prompt="é€‰æ‹©è¦å…³é—­çš„åˆ†æ”¯> ")
            fi
            
            if [ -n "$selected" ]; then
                hg update "$selected"
                hg commit --close-branch -m "å…³é—­åˆ†æ”¯: $selected"
                hg update default
            fi
            ;;
        *æŸ¥çœ‹æ´»åŠ¨åˆ†æ”¯*)
            clear
            hg branch
            wait_for_key
            ;;
        "â†©ï¸ è¿”å›"|*)
            break
            ;;
        esac
    done
}

# ======================================================
# æ ‡ç­¾ç®¡ç†åŠŸèƒ½
# ======================================================

hg_tag_manager() {
    local options=(
        "æŸ¥çœ‹æ ‡ç­¾åˆ—è¡¨"
        "åˆ›å»ºæ ‡ç­¾"
        "åˆ é™¤æ ‡ç­¾"
        "åˆ‡æ¢åˆ°æ ‡ç­¾"
        "â†©ï¸ è¿”å›"
    )

    while true; do
        $USE_GUM && custom_gum_show2hide_header "Mercurial æ ‡ç­¾ç®¡ç†" || echo -e "Mercurial æ ‡ç­¾ç®¡ç†"

        local selection=$(printf '%s\n' "${options[@]}" | fzf \
            --height=30% \
            --reverse \
            --prompt="â¤ Mercurial æ ‡ç­¾ç®¡ç† > "
        )

        case "$selection" in
        *æŸ¥çœ‹æ ‡ç­¾åˆ—è¡¨*)
            clear
            hg tags
            wait_for_key
            ;;
        *åˆ›å»ºæ ‡ç­¾*)
            local tag_name=$(user_input "è¯·è¾“å…¥æ ‡ç­¾å: " "")
            local message=$(user_input "è¯·è¾“å…¥æ ‡ç­¾ä¿¡æ¯: " "æ ‡ç­¾: $tag_name")
            
            if [ -n "$tag_name" ]; then
                hg tag -m "$message" "$tag_name"
            fi
            ;;
        *åˆ é™¤æ ‡ç­¾*)
            local tags=$(hg tags | awk '{print $1}')
            local selected
            
            if $USE_GUM; then
                selected=$(echo "$tags" | gum choose --height 15 --cursor.foreground 212 --item.foreground 99 --selected.foreground 212 --prompt "é€‰æ‹©è¦åˆ é™¤çš„æ ‡ç­¾: ")
            else
                selected=$(echo "$tags" | fzf --ansi --prompt="é€‰æ‹©è¦åˆ é™¤çš„æ ‡ç­¾> ")
            fi
            
            if [ -n "$selected" ]; then
                hg tag --remove "$selected"
            fi
            ;;
        *åˆ‡æ¢åˆ°æ ‡ç­¾*)
            local tags=$(hg tags | awk '{print $1}')
            local selected
            
            if $USE_GUM; then
                selected=$(echo "$tags" | gum choose --height 15 --cursor.foreground 212 --item.foreground 99 --selected.foreground 212 --prompt "é€‰æ‹©è¦åˆ‡æ¢çš„æ ‡ç­¾: ")
            else
                selected=$(echo "$tags" | fzf --ansi --prompt="é€‰æ‹©è¦åˆ‡æ¢çš„æ ‡ç­¾> ")
            fi
            
            if [ -n "$selected" ]; then
                hg update "$selected"
            fi
            ;;
        "â†©ï¸ è¿”å›"|*)
            break
            ;;
        esac
    done
}

# ======================================================
# æ›´æ–°ä¸åŒæ­¥åŠŸèƒ½
# ======================================================

hg_update_sync_manager() {
    local options=(
        "æ‹‰å–å˜æ›´(pull)"
        "æ¨é€å˜æ›´(push)"
        "æŸ¥çœ‹è¿œç¨‹ä»“åº“(path)"
        "æ·»åŠ è¿œç¨‹ä»“åº“"
        "æŸ¥çœ‹å˜æ›´çŠ¶æ€(incoming)"
        "æŸ¥çœ‹æ¨é€çŠ¶æ€(outgoing)"
        "â†©ï¸ è¿”å›"
    )

    while true; do
        $USE_GUM && custom_gum_show2hide_header "Mercurial æ›´æ–°ä¸åŒæ­¥" || echo -e "Mercurial æ›´æ–°ä¸åŒæ­¥"

        local selection=$(printf '%s\n' "${options[@]}" | fzf \
            --height=30% \
            --reverse \
            --prompt="â¤ Mercurial æ›´æ–°ä¸åŒæ­¥ > "
        )

        case "$selection" in
        *æ‹‰å–å˜æ›´*)
            hg pull
            ;;
        *æ¨é€å˜æ›´*)
            hg push
            ;;
        *æŸ¥çœ‹è¿œç¨‹ä»“åº“*)
            clear
            hg paths
            wait_for_key
            ;;
        *æ·»åŠ è¿œç¨‹ä»“åº“*)
            local name=$(user_input "è¯·è¾“å…¥è¿œç¨‹åç§°: " "default")
            local url=$(user_input "è¯·è¾“å…¥è¿œç¨‹URL: " "")
            
            if [ -n "$name" ] && [ -n "$url" ]; then
                echo "[paths]" >> .hg/hgrc
                echo "$name = $url" >> .hg/hgrc
                $USE_GUM && gum style --foreground 46 "è¿œç¨‹ä»“åº“å·²æ·»åŠ !" || echo -e "\033[32mè¿œç¨‹ä»“åº“å·²æ·»åŠ !\033[0m"
            fi
            sleep 1
            ;;
        *æŸ¥çœ‹å˜æ›´çŠ¶æ€*)
            clear
            hg incoming
            wait_for_key
            ;;
        *æŸ¥çœ‹æ¨é€çŠ¶æ€*)
            clear
            hg outgoing
            wait_for_key
            ;;
        "â†©ï¸ è¿”å›"|*)
            break
            ;;
        esac
    done
}

# ======================================================
# æ—¥å¿—ç®¡ç†åŠŸèƒ½
# ======================================================

hg_log_manager() {
    local options=(
        "æŸ¥çœ‹å®Œæ•´æ—¥å¿—"
        "æŸ¥çœ‹ç®€åŒ–æ—¥å¿—"
        "æŒ‰ä½œè€…æŸ¥çœ‹æ—¥å¿—"
        "æŒ‰æ—¥æœŸèŒƒå›´æŸ¥çœ‹æ—¥å¿—"
        "æŒ‰æ–‡ä»¶æŸ¥çœ‹æ—¥å¿—"
        "æŒ‰å…³é”®å­—æœç´¢æ—¥å¿—"
        "â†©ï¸ è¿”å›"
    )

    while true; do
        $USE_GUM && custom_gum_show2hide_header "Mercurial æ—¥å¿—ç®¡ç†" || echo -e "Mercurial æ—¥å¿—ç®¡ç†"
        
        local selection=$(printf '%s\n' "${options[@]}" | fzf \
            --height=30% \
            --reverse \
            --prompt="â¤ Mercurial æ—¥å¿—ç®¡ç† > "
        )

        case "$selection" in
        *æŸ¥çœ‹å®Œæ•´æ—¥å¿—*)
            clear
            hg log
            wait_for_key
            ;;
        *æŸ¥çœ‹ç®€åŒ–æ—¥å¿—*)
            clear
            hg log --template "{rev}: {desc|firstline}\n"
            wait_for_key
            ;;
        *æŒ‰ä½œè€…æŸ¥çœ‹æ—¥å¿—*)
            local author=$(user_input "è¯·è¾“å…¥ä½œè€…åç§°: " "")
            if [ -n "$author" ]; then
                clear
                hg log -u "$author"
                wait_for_key
            fi
            ;;
        *æŒ‰æ—¥æœŸèŒƒå›´æŸ¥çœ‹æ—¥å¿—*)
            local start_date=$(user_input "è¯·è¾“å…¥å¼€å§‹æ—¥æœŸ (YYYY-MM-DD): " "")
            local end_date=$(user_input "è¯·è¾“å…¥ç»“æŸæ—¥æœŸ (YYYY-MM-DD): " "$(date +%Y-%m-%d)")
            
            if [ -n "$start_date" ]; then
                clear
                hg log -d "$start_date to $end_date"
                wait_for_key
            fi
            ;;
        *æŒ‰æ–‡ä»¶æŸ¥çœ‹æ—¥å¿—*)
            local file=$(user_input "è¯·è¾“å…¥æ–‡ä»¶è·¯å¾„: " "")
            if [ -n "$file" ]; then
                clear
                hg log "$file"
                wait_for_key
            fi
            ;;
        *æŒ‰å…³é”®å­—æœç´¢æ—¥å¿—*)
            local keyword=$(user_input "è¯·è¾“å…¥æœç´¢å…³é”®è¯: " "")
            if [ -n "$keyword" ]; then
                clear
                hg log -k "$keyword"
                wait_for_key
            fi
            ;;
        "â†©ï¸ è¿”å›"|*)
            break
            ;;
        esac
    done
}

# ======================================================
# å·®å¼‚æ¯”è¾ƒåŠŸèƒ½
# ======================================================

hg_diff_manager() {
    local options=(
        "æ¯”è¾ƒå·¥ä½œå‰¯æœ¬ä¸åŸºç¡€ç‰ˆæœ¬"
        "æ¯”è¾ƒä¸¤ä¸ªç‰ˆæœ¬"
        "æ¯”è¾ƒç‰¹å®šæ–‡ä»¶"
        "ä¸ç‰¹å®šç‰ˆæœ¬æ¯”è¾ƒ"
        "ç»Ÿè®¡å˜æ›´(stat)"
        "â†©ï¸ è¿”å›"
    )

    while true; do
        $USE_GUM && custom_gum_show2hide_header "Mercurial å·®å¼‚æ¯”è¾ƒ" || echo -e "Mercurial å·®å¼‚æ¯”è¾ƒ"

        local selection=$(printf '%s\n' "${options[@]}" | fzf \
            --height=30% \
            --reverse \
            --prompt="â¤ Mercurial å·®å¼‚æ¯”è¾ƒ > "
        )

        case "$selection" in
        *æ¯”è¾ƒå·¥ä½œå‰¯æœ¬ä¸åŸºç¡€ç‰ˆæœ¬*)
            clear
            hg diff
            wait_for_key
            ;;
        *æ¯”è¾ƒä¸¤ä¸ªç‰ˆæœ¬*)
            local rev1=$(user_input "è¯·è¾“å…¥èµ·å§‹ç‰ˆæœ¬å·: " "")
            local rev2=$(user_input "è¯·è¾“å…¥ç»“æŸç‰ˆæœ¬å·: " "")
            
            if [[ "$rev1" =~ ^[0-9]+$ ]] && [[ "$rev2" =~ ^[0-9]+$ ]]; then
                clear
                hg diff -r "$rev1:$rev2"
                wait_for_key
            else
                $USE_GUM && gum style --foreground 196 "æ— æ•ˆçš„ç‰ˆæœ¬å·!" || echo -e "\033[31mæ— æ•ˆçš„ç‰ˆæœ¬å·!\033[0m"
            fi
            ;;
        *æ¯”è¾ƒç‰¹å®šæ–‡ä»¶*)
            local file=$(user_input "è¯·è¾“å…¥æ–‡ä»¶è·¯å¾„: " "")
            if [ -n "$file" ]; then
                clear
                hg diff "$file"
                wait_for_key
            fi
            ;;
        *ä¸ç‰¹å®šç‰ˆæœ¬æ¯”è¾ƒ*)
            local revision=$(user_input "è¯·è¾“å…¥ç‰ˆæœ¬å·: " "")
            if [[ "$revision" =~ ^[0-9]+$ ]]; then
                clear
                hg diff -r "$revision"
                wait_for_key
            else
                $USE_GUM && gum style --foreground 196 "æ— æ•ˆçš„ç‰ˆæœ¬å·!" || echo -e "\033[31mæ— æ•ˆçš„ç‰ˆæœ¬å·!\033[0m"
            fi
            ;;
        *ç»Ÿè®¡å˜æ›´*)
            clear
            hg diff --stat
            wait_for_key
            ;;
        "â†©ï¸ è¿”å›"|*)
            break
            ;;
        esac
    done
}

# ======================================================
# ä¹¦ç­¾ç®¡ç†åŠŸèƒ½
# ======================================================

hg_bookmark_manager() {
    local options=(
        "æŸ¥çœ‹ä¹¦ç­¾åˆ—è¡¨"
        "åˆ›å»ºä¹¦ç­¾"
        "åˆ é™¤ä¹¦ç­¾"
        "åˆ‡æ¢åˆ°ä¹¦ç­¾"
        "é‡å‘½åä¹¦ç­¾"
        "â†©ï¸ è¿”å›"
    )

    while true; do
        $USE_GUM && custom_gum_show2hide_header "Mercurial ä¹¦ç­¾ç®¡ç†" || echo -e "Mercurial ä¹¦ç­¾ç®¡ç†"
        
        local selection=$(printf '%s\n' "${options[@]}" | fzf \
            --height=30% \
            --reverse \
            --prompt="â¤ Mercurial ä¹¦ç­¾ç®¡ç† > "
        )

        case "$selection" in
        *æŸ¥çœ‹ä¹¦ç­¾åˆ—è¡¨*)
            clear
            hg bookmarks
            wait_for_key
            ;;
        *åˆ›å»ºä¹¦ç­¾*)
            local bookmark_name=$(user_input "è¯·è¾“å…¥ä¹¦ç­¾å: " "")
            if [ -n "$bookmark_name" ]; then
                hg bookmark "$bookmark_name"
            fi
            ;;
        *åˆ é™¤ä¹¦ç­¾*)
            local bookmarks=$(hg bookmarks | awk '{print $1}')
            local selected
            
            if $USE_GUM; then
                selected=$(echo "$bookmarks" | gum choose --height 15 --cursor.foreground 212 --item.foreground 99 --selected.foreground 212 --prompt "é€‰æ‹©è¦åˆ é™¤çš„ä¹¦ç­¾: ")
            else
                selected=$(echo "$bookmarks" | fzf --ansi --prompt="é€‰æ‹©è¦åˆ é™¤çš„ä¹¦ç­¾> ")
            fi
            
            if [ -n "$selected" ]; then
                hg bookmark -d "$selected"
            fi
            ;;
        *åˆ‡æ¢åˆ°ä¹¦ç­¾*)
            local bookmarks=$(hg bookmarks | awk '{print $1}')
            local selected
            
            if $USE_GUM; then
                selected=$(echo "$bookmarks" | gum choose --height 15 --cursor.foreground 212 --item.foreground 99 --selected.foreground 212 --prompt "é€‰æ‹©è¦åˆ‡æ¢çš„ä¹¦ç­¾: ")
            else
                selected=$(echo "$bookmarks" | fzf --ansi --prompt="é€‰æ‹©è¦åˆ‡æ¢çš„ä¹¦ç­¾> ")
            fi
            
            if [ -n "$selected" ]; then
                hg update "$selected"
            fi
            ;;
        *é‡å‘½åä¹¦ç­¾*)
            local bookmarks=$(hg bookmarks | awk '{print $1}')
            local selected
            
            if $USE_GUM; then
                selected=$(echo "$bookmarks" | gum choose --height 15 --cursor.foreground 212 --item.foreground 99 --selected.foreground 212 --prompt "é€‰æ‹©è¦é‡å‘½åçš„ä¹¦ç­¾: ")
            else
                selected=$(echo "$bookmarks" | fzf --ansi --prompt="é€‰æ‹©è¦é‡å‘½åçš„ä¹¦ç­¾> ")
            fi
            
            if [ -n "$selected" ]; then
                local new_name=$(user_input "è¯·è¾“å…¥æ–°åç§°: " "")
                hg bookmark -m "$selected" "$new_name"
            fi
            ;;
        "â†©ï¸ è¿”å›"|*)
            break
            ;;
        esac
    done
}

# ======================================================
# è¡¥ä¸ç®¡ç†åŠŸèƒ½
# ======================================================

hg_patch_manager() {
    local options=(
        "åˆ›å»ºè¡¥ä¸(export)"
        "åº”ç”¨è¡¥ä¸(import)"
        "æŸ¥çœ‹è¡¥ä¸å†…å®¹"
        "åˆ—å‡ºæ‰€æœ‰è¡¥ä¸(queue)"
        "åˆ é™¤è¡¥ä¸(remove)"
        "â†©ï¸ è¿”å›"
    )

    while true; do
        $USE_GUM && custom_gum_show2hide_header "Mercurial è¡¥ä¸ç®¡ç†" || echo -e "Mercurial è¡¥ä¸ç®¡ç†"
        
        local selection=$(printf '%s\n' "${options[@]}" | fzf \
            --height=30% \
            --reverse \
            --prompt="â¤ Mercurial è¡¥ä¸ç®¡ç† > "
        )

        case "$selection" in
        *åˆ›å»ºè¡¥ä¸*)
            local rev1=$(user_input "è¯·è¾“å…¥èµ·å§‹ç‰ˆæœ¬å·: " "")
            local rev2=$(user_input "è¯·è¾“å…¥ç»“æŸç‰ˆæœ¬å·: " "")
            local patch_file=$(user_input "è¯·è¾“å…¥è¡¥ä¸æ–‡ä»¶å: " "changes.patch")
            
            if [[ "$rev1" =~ ^[0-9]+$ ]] && [[ "$rev2" =~ ^[0-9]+$ ]]; then
                hg export -r "$rev1:$rev2" -o "$patch_file"
                $USE_GUM && gum style --foreground 46 "è¡¥ä¸å·²åˆ›å»º: $patch_file" || echo -e "\033[32mè¡¥ä¸å·²åˆ›å»º: $patch_file\033[0m"
            else
                $USE_GUM && gum style --foreground 196 "æ— æ•ˆçš„ç‰ˆæœ¬å·!" || echo -e "\033[31mæ— æ•ˆçš„ç‰ˆæœ¬å·!\033[0m"
            fi
            sleep 1
            ;;
        *åº”ç”¨è¡¥ä¸*)
            local patch_file=$(user_input "è¯·è¾“å…¥è¡¥ä¸æ–‡ä»¶å: " "changes.patch")
            if [ -f "$patch_file" ]; then
                hg import "$patch_file"
            else
                $USE_GUM && gum style --foreground 196 "æ–‡ä»¶ä¸å­˜åœ¨: $patch_file" || echo -e "\033[31mæ–‡ä»¶ä¸å­˜åœ¨: $patch_file\033[0m"
            fi
            sleep 1
            ;;
        *æŸ¥çœ‹è¡¥ä¸å†…å®¹*)
            local patch_file=$(user_input "è¯·è¾“å…¥è¡¥ä¸æ–‡ä»¶å: " "changes.patch")
            if [ -f "$patch_file" ]; then
                clear
                cat "$patch_file"
                wait_for_key
            else
                $USE_GUM && gum style --foreground 196 "æ–‡ä»¶ä¸å­˜åœ¨: $patch_file" || echo -e "\033[31mæ–‡ä»¶ä¸å­˜åœ¨: $patch_file\033[0m"
                sleep 1
            fi
            ;;
        *åˆ—å‡ºæ‰€æœ‰è¡¥ä¸*)
            clear
            hg qseries
            wait_for_key
            ;;
        *åˆ é™¤è¡¥ä¸*)
            local patch_name=$(user_input "è¯·è¾“å…¥è¡¥ä¸å: " "")
            if [ -n "$patch_name" ]; then
                hg qremove "$patch_name"
            fi
            ;;
        "â†©ï¸ è¿”å›"|*)
            break
            ;;
        esac
    done
}

# ======================================================
# é«˜çº§æ“ä½œåŠŸèƒ½
# ======================================================

hg_advanced_manager() {
    local options=(
        "äºŒåˆ†æŸ¥æ‰¾(bisect)"
        "è½¬æ¢ä»“åº“(convert)"
        "æŸ¥æ‰¾æ–‡ä»¶å‰¯æœ¬(trace)"
        "æŸ¥çœ‹æ–‡ä»¶å†å²(annotate)"
        "æŸ¥çœ‹æ–‡ä»¶å†…å®¹(cat)"
        "æŸ¥æ‰¾æ–‡ä»¶å‰¯æœ¬(trace)"
        "â†©ï¸ è¿”å›"
    )

    while true; do
        $USE_GUM && custom_gum_show2hide_header "Mercurial é«˜çº§æ“ä½œ" || echo -e "Mercurial é«˜çº§æ“ä½œ"

        local selection=$(printf '%s\n' "${options[@]}" | fzf \
            --height=30% \
            --reverse \
            --prompt="â¤ Mercurial é«˜çº§æ“ä½œ > "
        )

        case "$selection" in
        *äºŒåˆ†æŸ¥æ‰¾*)
            hg_bisect_manager
            ;;
        *è½¬æ¢ä»“åº“*)
            $USE_GUM && gum style --foreground 196 "è­¦å‘Š: ä»“åº“è½¬æ¢æ˜¯é«˜çº§æ“ä½œ!" || echo -e "\033[31mè­¦å‘Š: ä»“åº“è½¬æ¢æ˜¯é«˜çº§æ“ä½œ!\033[0m"
            local source_repo=$(user_input "è¯·è¾“å…¥æºä»“åº“è·¯å¾„: " "")
            local dest_repo=$(user_input "è¯·è¾“å…¥ç›®æ ‡ä»“åº“è·¯å¾„: " "")
            
            if [ -n "$source_repo" ] && [ -n "$dest_repo" ]; then
                hg convert "$source_repo" "$dest_repo"
            fi
            ;;
        *æŸ¥æ‰¾æ–‡ä»¶å‰¯æœ¬*)
            local file=$(user_input "è¯·è¾“å…¥æ–‡ä»¶è·¯å¾„: " "")
            if [ -n "$file" ]; then
                clear
                hg trace "$file"
                wait_for_key
            fi
            ;;
        *æŸ¥çœ‹æ–‡ä»¶å†å²*)
            local file=$(user_input "è¯·è¾“å…¥æ–‡ä»¶è·¯å¾„: " "")
            if [ -n "$file" ]; then
                clear
                hg annotate "$file"
                wait_for_key
            fi
            ;;
        *æŸ¥çœ‹æ–‡ä»¶å†…å®¹*)
            local file=$(user_input "è¯·è¾“å…¥æ–‡ä»¶è·¯å¾„: " "")
            if [ -n "$file" ]; then
                clear
                hg cat "$file"
                wait_for_key
            fi
            ;;
        "â†©ï¸ è¿”å›"|*)
            break
            ;;
        esac
    done
}

# ======================================================
# äºŒåˆ†æŸ¥æ‰¾ç®¡ç†åŠŸèƒ½
# ======================================================

hg_bisect_manager() {
    local options=(
        "å¼€å§‹äºŒåˆ†æŸ¥æ‰¾(reset)"
        "æ ‡è®°ä¸ºå¥½ç‰ˆæœ¬(good)"
        "æ ‡è®°ä¸ºåç‰ˆæœ¬(bad)"
        "è·³è¿‡å½“å‰ç‰ˆæœ¬(skip)"
        "ç»“æŸäºŒåˆ†æŸ¥æ‰¾(reset)"
        "â†©ï¸ è¿”å›"
    )

    while true; do
        $USE_GUM && custom_gum_show2hide_header "Mercurial äºŒåˆ†æŸ¥æ‰¾" || echo -e "Mercurial äºŒåˆ†æŸ¥æ‰¾"

        local selection=$(printf '%s\n' "${options[@]}" | fzf \
            --height=30% \
            --reverse \
            --prompt="â¤ Mercurial äºŒåˆ†æŸ¥æ‰¾ > "
        )

        case "$selection" in
        *å¼€å§‹äºŒåˆ†æŸ¥æ‰¾*)
            hg bisect --reset
            $USE_GUM && gum style --foreground 46 "äºŒåˆ†æŸ¥æ‰¾å·²é‡ç½®!" || echo -e "\033[32mäºŒåˆ†æŸ¥æ‰¾å·²é‡ç½®!\033[0m"
            sleep 1
            ;;
        *æ ‡è®°ä¸ºå¥½ç‰ˆæœ¬*)
            hg bisect --good
            ;;
        *æ ‡è®°ä¸ºåç‰ˆæœ¬*)
            hg bisect --bad
            ;;
        *è·³è¿‡å½“å‰ç‰ˆæœ¬*)
            hg bisect --skip
            ;;
        *ç»“æŸäºŒåˆ†æŸ¥æ‰¾*)
            hg bisect --reset
            $USE_GUM && gum style --foreground 46 "äºŒåˆ†æŸ¥æ‰¾å·²ç»“æŸ!" || echo -e "\033[32mäºŒåˆ†æŸ¥æ‰¾å·²ç»“æŸ!\033[0m"
            sleep 1
            ;;
        "â†©ï¸ è¿”å›"|*)
            break
            ;;
        esac
    done
}

# ======================================================
# é…ç½®å·¥å…·åŠŸèƒ½
# ======================================================

hg_config_manager() {
    local options=(
        "æŸ¥çœ‹é…ç½®(showconfig)"
        "è®¾ç½®ç”¨æˆ·å(username)"
        "è®¾ç½®ç¼–è¾‘å™¨(editor)"
        "è®¾ç½®å¿½ç•¥æ–‡ä»¶(ignore)"
        "è®¾ç½®æ‰©å±•(extensions)"
        "ç¼–è¾‘é…ç½®æ–‡ä»¶(edit)"
        "â†©ï¸ è¿”å›"
    )

    while true; do
        $USE_GUM && custom_gum_show2hide_header "Mercurial é…ç½®å·¥å…·" || echo -e "Mercurial é…ç½®å·¥å…·"

        local selection=$(printf '%s\n' "${options[@]}" | fzf \
            --height=30% \
            --reverse \
            --prompt="â¤ Mercurial é…ç½®å·¥å…· > "
        )

        case "$selection" in
        *æŸ¥çœ‹é…ç½®*)
            clear
            hg showconfig
            wait_for_key
            ;;
        *è®¾ç½®ç”¨æˆ·å*)
            local username=$(user_input "è¯·è¾“å…¥ç”¨æˆ·å: " "")
            if [ -n "$username" ]; then
                echo "[ui]" >> .hg/hgrc
                echo "username = $username" >> .hg/hgrc
                $USE_GUM && gum style --foreground 46 "ç”¨æˆ·åå·²è®¾ç½®!" || echo -e "\033[32mç”¨æˆ·åå·²è®¾ç½®!\033[0m"
            fi
            sleep 1
            ;;
        *è®¾ç½®ç¼–è¾‘å™¨*)
            local editor=$(user_input "è¯·è¾“å…¥ç¼–è¾‘å™¨å‘½ä»¤: " "vim")
            echo "[ui]" >> .hg/hgrc
            echo "editor = $editor" >> .hg/hgrc
            $USE_GUM && gum style --foreground 46 "ç¼–è¾‘å™¨å·²è®¾ç½®!" || echo -e "\033[32mç¼–è¾‘å™¨å·²è®¾ç½®!\033[0m"
            sleep 1
            ;;
        *è®¾ç½®å¿½ç•¥æ–‡ä»¶*)
            local ignore_file=$(user_input "è¯·è¾“å…¥å¿½ç•¥æ–‡ä»¶è·¯å¾„: " ".hgignore")
            echo "[ui]" >> .hg/hgrc
            echo "ignore = $ignore_file" >> .hg/hgrc
            $USE_GUM && gum style --foreground 46 "å¿½ç•¥æ–‡ä»¶å·²è®¾ç½®!" || echo -e "\033[32må¿½ç•¥æ–‡ä»¶å·²è®¾ç½®!\033[0m"
            sleep 1
            ;;
        *è®¾ç½®æ‰©å±•*)
            local extension=$(user_input "è¯·è¾“å…¥æ‰©å±•å: " "color")
            echo "[extensions]" >> .hg/hgrc
            echo "$extension = " >> .hg/hgrc
            $USE_GUM && gum style --foreground 46 "æ‰©å±•å·²å¯ç”¨!" || echo -e "\033[32mæ‰©å±•å·²å¯ç”¨!\033[0m"
            sleep 1
            ;;
        *ç¼–è¾‘é…ç½®æ–‡ä»¶*)
            hg config --edit
            ;;
        "â†©ï¸ è¿”å›"|*)
            break
            ;;
        esac
    done
}
