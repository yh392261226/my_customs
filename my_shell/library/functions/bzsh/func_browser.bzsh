### Package Desc: æµè§ˆå™¨ç›¸å…³å‘½ä»¤


SEARCH_BROWSER="/Applications/Safari.app"
#[[ -d "/Applications/Google Chrome.app" ]] && SEARCH_BROWSER="/Applications/Google Chrome.app"
function search_by_github() {                                                       # Desc: function: search_by_github:Githubæœç´¢
    if [ "" != "$1" ]; then
        echo "open -a $SEARCH_BROWSER https://github.com/search?q=${1}&type=repositories";
        open -a "$SEARCH_BROWSER" "https://github.com/search?q=${1}&type=repositories";
    else
        hascommand=$(ifHasCommand gum)
        if [ $hascommand = 1 ]; then
            text=$(gum input --placeholder "Type search text")
        else
            read text
        fi
        open -a "$SEARCH_BROWSER" "https://github.com/search?q=${text}&type=repositories"
    fi
}
alias github="search_by_github"                                                     # Desc: alias: github:search_by_github,Githubæœç´¢

function search_by_google() {                                                       # Desc: function: search_by_google:GOOGLEæœç´¢å¼•æ“æœç´¢
    if [ "" != "$1" ]; then
        echo "open -a $SEARCH_BROWSER https://www.google.com/search?q=${1}";
        open -a "$SEARCH_BROWSER" "https://www.google.com/search?q=${1}";
    else
        hascommand=$(ifHasCommand gum)
        if [ $hascommand = 1 ]; then
            text=$(gum input --placeholder "Type search text")
        else
            read text
        fi
        open -a "$SEARCH_BROWSER" "https://www.google.com/search?q=${text}"
    fi
}
alias google="search_by_google"                                                     # Desc: alias: google:search_by_googleå‘½ä»¤çš„åˆ«å,GOOGLEæœç´¢å¼•æ“æœç´¢

function search_by_baidu() {                                                        # Desc: function: search_by_baidu:ç™¾åº¦æœç´¢å¼•æ“æœç´¢
    if [ "" != "$1" ]; then
        echo "open -a $SEARCH_BROWSER https://www.baidu.com/s?wd=${1}";
        open -a "$SEARCH_BROWSER" "https://www.baidu.com/s?wd=${1}";
    else
        hascommand=$(ifHasCommand gum)
        if [ $hascommand = 1 ]; then
            text=$(gum input --placeholder "Type search text")
        else
            read text
        fi
        open -a "$SEARCH_BROWSER" "https://www.baidu.com/s?wd=${text}"
    fi
}
alias baidu="search_by_baidu"                                                       # Desc: alias: baidu:search_by_baiduå‘½ä»¤çš„åˆ«å,ç™¾åº¦æœç´¢å¼•æ“æœç´¢

function search_by_bing() {                                                         # Desc: function: search_by_bing:Bingæœç´¢å¼•æ“æœç´¢
    if [ "" != "$1" ]; then
        echo "open -a $SEARCH_BROWSER http://www.bing.com/search?q=${1}";
        open -a "$SEARCH_BROWSER" "http://www.bing.com/search?q=${1}";
    else
        hascommand=$(ifHasCommand gum)
        if [ $hascommand = 1 ]; then
            text=$(gum input --placeholder "Type search text")
        else
            read text
        fi
        open -a "$SEARCH_BROWSER" "http://www.bing.com/search?q=${text}"
    fi
}
alias bing="search_by_bing"                                                         # Desc: alias: bing:search_by_bingå‘½ä»¤çš„åˆ«å,Bingæœç´¢å¼•æ“æœç´¢

function search_by_yahoo() {                                                        # Desc: function: search_by_yahoo:Yahooæœç´¢å¼•æ“æœç´¢
    if [ "" != "$1" ]; then
        echo "open -a $SEARCH_BROWSER http://www.yahoo.com/search?q=${1}";
        open -a "$SEARCH_BROWSER" "http://www.yahoo.com/search?q=${1}";
    else
        hascommand=$(ifHasCommand gum)
        if [ $hascommand = 1 ]; then
            text=$(gum input --placeholder "Type search text")
        else
            read text
        fi
        open -a "$SEARCH_BROWSER" "http://www.yahoo.com/search?q=${text}"
    fi
}
alias yahoo="search_by_yahoo"                                                       # Desc: alias: yahoo:search_by_yahooå‘½ä»¤çš„åˆ«å,Yahooæœç´¢å¼•æ“æœç´¢

function search_by_wikipedia() {                                                    # Desc: function: search_by_wikipedia:wikipediaæœç´¢å¼•æ“æœç´¢
    if [ "" != "$1" ]; then
        echo "open -a $SEARCH_BROWSER http://en.wikipedia.org/wiki/Special:Search?search=${1}";
        open -a "$SEARCH_BROWSER"  "http://en.wikipedia.org/wiki/Special:Search?search=${1}";
    else
        hascommand=$(ifHasCommand gum)
        if [ $hascommand = 1 ]; then
            text=$(gum input --placeholder "Type search text")
        else
            read text
        fi
        open -a "$SEARCH_BROWSER" "http://en.wikipedia.org/wiki/Special:Search?search=${text}"
    fi
}
alias wikipedia="search_by_wikipedia"                                               # Desc: alias: wikipedia:search_by_wikipediaå‘½ä»¤çš„åˆ«å,wikipediaæœç´¢å¼•æ“æœç´¢

function open_in_browser() {                                                        # Desc: function: open_in_browser:æµè§ˆå™¨ä¸­æ‰“å¼€ç½‘å€
    local BROWSERPATH=$1
    local DEFAULTURL="https://www.google.com/"
    [[ ! -d "$BROWSERPATH/" ]] && echo "Does not found Firefox " && exit 1

    [ "" = "$2" ] && url=$DEFAULTURL || url=$2

    if [ ! -f $url ]; then
        if [ "${url:0:6}" != "http://" ] && [ "${url:0:7}" != "https://" ]; then
            url="http://$url"
        fi
    fi
    /usr/bin/open -a "$BROWSERPATH" "$url"
}
alias browse="open_in_browser"                                                      # Desc: alias: browse:open_in_browserå‘½ä»¤çš„åˆ«å,æµè§ˆå™¨ä¸­æ‰“å¼€ç½‘å€

function firefox() {                                                                # Desc: function: firefox:ç«ç‹æµè§ˆå™¨æ‰“å¼€ç½‘å€
    local BROWSERPATH="/Applications/Firefox.app"
    open_in_browser $BROWSERPATH $1
}

function safari() {                                                                 # Desc: function: safari:Safariæµè§ˆå™¨ä¸­æ‰“å¼€ç½‘å€
    local BROWSERPATH="/Applications/Safari.app"
    open_in_browser $BROWSERPATH $1
}

function chrome() {                                                                 # Desc: function: chrome:Chromeæµè§ˆå™¨ä¸­æ‰“å¼€ç½‘å€
    local BROWSERPATH="/Applications/Google Chrome.app"
    open_in_browser $BROWSERPATH $1
}

function brave() {                                                                  # Desc: function: brave:braveæµè§ˆå™¨ä¸­æ‰“å¼€ç½‘å€
    local BROWSERPATH="/Applications/Brave Browser.app"
    open_in_browser $BROWSERPATH $1
}

function stealth-browser() {                                                        # Desc: function: stealth-browser:éšèº«Chromeæµè§ˆå™¨æ‰“å¼€ç½‘å€
    local MYRUNTIME=$(cat $HOME/.myruntime)
    local DEFAULTBROWSER="/Applications/Google Chrome.app"
    [[ -f $MYRUNTIME/tools/m_proxy ]] && source $MYRUNTIME/tools/m_proxy
    [[ -d "$DEFAULTBROWSER" ]] && open  "/Applications/Google Chrome.app" --args -proxy-server=socks5://${ip}:${port} --incognito
}
alias sb="stealth-browser"                                                          # Desc: alias: sb:stealth-browserå‘½ä»¤çš„åˆ«å,éšèº«Chromeæµè§ˆå™¨æ‰“å¼€ç½‘å€

function fzf_safari_history() {                                                     # Desc: function: fzf_safari_history: è¯»å–å½“å‰ç”¨æˆ·çš„safariæµè§ˆå™¨å†å²
    sqlite3 $HOME/Library/Safari/History.db "SELECT datetime(h.visit_time + 978307200, 'unixepoch', 'localtime') as date, i.url FROM history_visits h INNER JOIN history_items i ON h.history_item = i.id" | fzf --ansi --multi --no-hscroll --tiebreak=index $FZF_CUSTOM_PARAMS \
        --preview ' echo -n {} | awk -F"|" "{print \$2}"' \
        --bind 'focus:transform-preview-label:echo -n {} | awk -F "|" "{print \"[\" \$1 \"]\"}"' \
        --bind 'ctrl-y:execute-silent(echo {} | grep -Eo "https?://[^[:space:]]+" | pbcopy)+abort' \
        --bind 'enter:become(open $(echo {} | grep -Eo "https?://[^[:space:]]+"))' \
        --header="$(_buildFzfHeader '' 'fzf_safari_history')"
}
alias fsh="fzf_safari_history"                                                      # Desc: alias: fsh: fzf_safari_historyå‘½ä»¤çš„åˆ«å,è¯»å–å½“å‰ç”¨æˆ·çš„safariæµè§ˆå™¨å†å²

function fzf_safari_bookmarks() {                                                   # Desc: function: fzf_safari_bookmarks: è¯»å–å½“å‰ç”¨æˆ·çš„safariæµè§ˆå™¨ä¹¦ç­¾
    plutil -convert xml1 -o - $HOME/Library/Safari/Bookmarks.plist | grep -E "<string>http[s]?://|<string>.*<\/string>" | sed -E 's/<string>(http[s]?:\/\/[^<]*)<\/string>/\1/g' | grep -B 1 "http[s]\?:" | sed -E 's/<string>([^<]*)<\/string>/\1/g' | sed 's/^--$/|seprator|/g' | sed 's/^[[:space:]]*//g' | sed 's/^$/No title .../g' | tr '\n' ' ' | sed 's/|seprator|/\n/g' | fzf --ansi --multi --no-hscroll --tiebreak=index $FZF_CUSTOM_PARAMS \
        --preview ' echo -n {}' \
        --bind 'focus:transform-preview-label:echo -n {} ' \
        --bind 'ctrl-y:execute-silent(echo {} | grep -E "http[s]?://.*" | pbcopy)+abort' \
        --bind 'enter:become(open $(echo {} | grep -Eo "https?://[^[:space:]]+"))' \
        --header="$(_buildFzfHeader '' 'fzf_safari_bookmarks')"
}
alias fsb="fzf_safari_bookmarks"                                                    # Desc: alias: fsb: fzf_safari_bookmarkså‘½ä»¤çš„åˆ«å,è¯»å–å½“å‰ç”¨æˆ·çš„safariæµè§ˆå™¨ä¹¦ç­¾

function chromium_history() {                                                       # Desc: function: chromium_history:åˆ—å‡ºChromiumæ ¸å¿ƒçš„æµè§ˆå™¨çš„å†å²
    if [ "" = "$1" ]; then
        echo "Does not send param!"
        return 1
    fi
    local cols sep
    export cols=$(( COLUMNS / 3 ))
    export sep='{::}'
    rm -f ${TMPDIR:-/tmp}/h
    cp -r -f "$1" ${TMPDIR:-/tmp}/h
    sqlite3 -separator $sep ${TMPDIR:-/tmp}/h \
        "select title, url from urls order by last_visit_time desc" |
    ruby -ne '
    cols = ENV["cols"].to_i
    title, url = $_.split(ENV["sep"])
    len = 0
    puts "\x1b[36m" + title.each_char.take_while { |e|
    if len < cols
        len += e =~ /\p{Han}|\p{Katakana}|\p{Hiragana}|\p{Hangul}/ ? 2 : 1
    end
    }.join + " " * (2 + cols - len) + "\x1b[m" + url' |
    fzf --ansi --multi --no-hscroll --tiebreak=index $FZF_CUSTOM_PARAMS \
        --preview ' echo -n {} ' \
        --bind 'focus:transform-preview-label:echo -n "[ {1} ]";' \
        --bind 'ctrl-y:execute-silent(echo {} | grep -Eo "https?://[^[:space:]]+" | pbcopy)+abort' \
        --header="$(_buildFzfHeader '' 'chromium_history')" \
        | sed 's#.*\(https*://\)#\1#' | xargs open -a "$2"
}
alias ch="chromium_history"                                                         # Desc: alias: ch:chromium_historyå‘½ä»¤çš„åˆ«å,åˆ—å‡ºChromiumæ ¸å¿ƒçš„æµè§ˆå™¨çš„å†å²

function chrome_default_history() {                                                 # Desc: function: chrome_default_history:åˆ—å‡ºChromeé»˜è®¤è´¦æˆ·çš„æµè§ˆå™¨çš„å†å²
    chromium_history $HOME/Library/Application\ Support/Google/Chrome/Default/History "/Applications/Google Chrome.app"
}
alias cdh="chrome_default_history"                                                  # Desc: alias: cdh:chrome_default_historyå‘½ä»¤çš„åˆ«å,åˆ—å‡ºChromeé»˜è®¤è´¦æˆ·çš„æµè§ˆå™¨çš„å†å²

function chrome_profile1_history() {                                                # Desc: function: chrome_profile1_history:åˆ—å‡ºChrome Profile 1è´¦æˆ·çš„æµè§ˆå™¨çš„å†å²
    chromium_history $HOME/Library/Application\ Support/Google/Chrome/Profile\ 1/History "/Applications/Google Chrome.app"
}
alias cph="chrome_profile1_history"                                                 # Desc: alias: cph:chrome_profile1_historyå‘½ä»¤çš„åˆ«å,åˆ—å‡ºChrome Profile 1è´¦æˆ·çš„æµè§ˆå™¨çš„å†å²

function brave_default_history() {                                                  # Desc: function: brave_default_history:åˆ—å‡ºBraveé»˜è®¤è´¦æˆ·çš„æµè§ˆå™¨çš„å†å²
    chromium_history $HOME/Library/Application\ Support/BraveSoftware/Brave-Browser/Default/History "/Applications/Brave Browser.app"
}
alias bdh="brave_default_history"                                                   # Desc: alias: bdh:brave_default_historyå‘½ä»¤çš„åˆ«å,åˆ—å‡ºBraveé»˜è®¤è´¦æˆ·çš„æµè§ˆå™¨çš„å†å²

function browser_history_manage() {                                                 # Desc: function: browser_history_manage:åˆ©ç”¨fzfç®¡ç†Safariã€Chromeã€Braveæµè§ˆå™¨çš„å†å²
    while true; do
        local action=$(printf "%s\n" \
            "ğŸ” Safari" \
            "ğŸ” Chrome_Default" \
            "ğŸ” Chrome_Profile1" \
            "ğŸ” Brave_Default" \
            "ğŸšª é€€å‡ºç³»ç»Ÿ" | \
            fzf --header " æµè§ˆå™¨å†å²è®°å½•ç®¡ç†ç³»ç»Ÿ " \
                --prompt "ä¸»èœå• â¯ " \
                --preview-window=up:30% \
                --preview "echo 'é€‰æ‹©æ“ä½œç±»å‹'" \
                --height=15% \
                --header="$(_buildFzfHeader '' 'browser_history_manage')" \
                --reverse)

        case $action in
            *Safari*) fzf_safari_history ;;
            *Chrome_Default*) chrome_default_history ;;
            *Chrome_Profile1*) chrome_profile1_history ;;
            *Brave_Default*) brave_default_history ;;
            *é€€å‡ºç³»ç»Ÿ*) break 1 && return ;;
        esac
    done
}
alias bh="browser_history_manage"                                                   # Desc: alias: bh:browser_history_manageå‘½ä»¤çš„åˆ«å,åˆ©ç”¨fzfç®¡ç†Safariã€Chromeã€Braveæµè§ˆå™¨çš„å†å²
if [ "$ZSH_VERSION" != "" ]; then
    zle -N browser_history_manage
    bindkey 'âˆ«' browser_history_manage   #//Alt B æ‰§è¡Œbrowser_history_manageå‡½æ•°
elif [ "$BASH_VERSION" != "" ]; then
    export -f browser_history_manage
    bind '"âˆ«":"browser_history_manage;\n"'   #//Alt B æ‰§è¡Œbrowser_history_manageå‡½æ•°
fi

function chromium_bookmarks() {                                                     # Desc: function: chroomium_bookmarks:åˆ—å‡ºåˆ—å‡ºChromiumæ ¸å¿ƒçš„æµè§ˆå™¨çš„ä¹¦ç­¾
    if [ "" = "$1" ]; then
        echo "Does not send param!"
        return 1
    else
        rm -f ${TMPDIR:-/tmp}/bookmarks
        cp -r -f "$1" ${TMPDIR:-/tmp}/bookmarks
    fi

     jq_script='
        def ancestors: while(. | length >= 2; del(.[-1,-2]));
        . as $in | paths(.url?) as $key | $in | getpath($key) | {name,url, path: [$key[0:-2] | ancestors as $a | $in | getpath($a) | .name?] | reverse | join("/") } | .path + "/" + .name + "\t" + .url'

    jq -r "$jq_script" < ${TMPDIR:-/tmp}/bookmarks \
        | sed -E $'s/(.*)\t(.*)/\\1\t\x1b[36m\\2\x1b[m/g' \
        | fzf --ansi $FZF_CUSTOM_PARAMS \
              --bind 'focus:transform-preview-label:echo -n "[ {1} ]";' \
              --bind 'ctrl-y:execute-silent(echo {} | grep -Eo "https?://[^[:space:]]+" | pbcopy)+abort' \
              --header="$(_buildFzfHeader '' 'chromium_bookmarks')" \
        | cut -d$'\t' -f2 \
        | xargs open -a "$2"
}
alias cb="chromium_bookmarks"                                                       # Desc: alias: cb:chromium_bookmarkså‘½ä»¤çš„åˆ«å,åˆ—å‡ºåˆ—å‡ºChromiumæ ¸å¿ƒçš„æµè§ˆå™¨çš„ä¹¦ç­¾

function chrome_default_bookmarks() {                                               # Desc: function: chrome_default_bookmarks:åˆ—å‡ºChromeé»˜è®¤è´¦æˆ·çš„ä¹¦ç­¾
    chromium_bookmarks $HOME/Library/Application\ Support/Google/Chrome/Default/Bookmarks "/Applications/Google Chrome.app"
}
alias cdb="chrome_default_bookmarks"                                                # Desc: alias: cdb:chrome_default_bookmarkså‘½ä»¤çš„åˆ«å,åˆ—å‡ºChromeé»˜è®¤è´¦æˆ·çš„ä¹¦ç­¾

function chrome_profile1_bookmarks() {                                              # Desc: function: chrome_default_bookmarks:åˆ—å‡ºChrome Profile 1è´¦æˆ·çš„ä¹¦ç­¾
    chromium_bookmarks $HOME/Library/Application\ Support/Google/Chrome/Profile\ 1/Bookmarks "/Applications/Google Chrome.app"
}
alias cpb="chrome_profile1_bookmarks"                                               # Desc: alias: cpb:chrome_profile1_bookmarkså‘½ä»¤çš„åˆ«å,åˆ—å‡ºChrome Profile 1è´¦æˆ·çš„ä¹¦ç­¾

function brave_default_bookmarks() {                                                # Desc: function: brave_default_bookmarks:åˆ—å‡ºBraveé»˜è®¤è´¦æˆ·çš„ä¹¦ç­¾
    chromium_bookmarks $HOME/Library/Application\ Support/BraveSoftware/Brave-Browser/Default/Bookmarks "/Applications/Brave Browser.app"
}
alias bdb="brave_default_bookmarks"                                                 # Desc: alias: bdb:brave_default_bookmarkså‘½ä»¤çš„åˆ«å,åˆ—å‡ºBraveé»˜è®¤è´¦æˆ·çš„ä¹¦ç­¾

function fzf_mark_by_buku() {                                                       # Desc: function: fzf_mark_by_buku:bukuæ•°æ®åº“é…åˆfzfåˆ—å‡ºç½‘å€æ”¶è—
    website=( $(buku --suggest -p -f 5 | column -ts$'\t' | fzf $FZF_CUSTOM_PARAMS \
    --bind 'focus:transform-preview-label:echo -n "[ {1} ]";' \
    --bind 'ctrl-y:execute-silent(buku --nostdin -p {1} | grep -Eo "https?://[^[:space:]]+" | pbcopy)+abort' \
    --preview='buku --nostdin -p {1}' \
    --header="$(_buildFzfHeader '' 'fzf_mark_by_buku')" \
    --multi ) )
    # open each website
    for i in "${website[@]}"; do
        index="$(echo -n "$i" | awk '{print $1}')"
        buku -p "$index"
        buku -o "$index"
    done
}
alias fmb="fzf_mark_by_buku"                                                        # Desc: alias: fmb:fzf_mark_by_bukuå‘½ä»¤çš„åˆ«å,bukuæ•°æ®åº“é…åˆfzfåˆ—å‡ºç½‘å€æ”¶è—

function browser_bookmarks_manage() {                                               # Desc: function: browser_bookmarks_manage:åˆ©ç”¨fzfç®¡ç†Safariã€Chromeã€Braveæµè§ˆå™¨çš„æ”¶è—
    while true; do
        local action=$(printf "%s\n" \
            "ğŸ” Safari" \
            "ğŸ” Chrome_Default" \
            "ğŸ” Chrome_Profile1" \
            "ğŸ” Brave_Default" \
            "ğŸ” Bubu" \
            "ğŸšª é€€å‡ºç³»ç»Ÿ" | \
            fzf --header " æµè§ˆå™¨æ”¶è—è®°å½•ç®¡ç†ç³»ç»Ÿ " \
                --prompt "ä¸»èœå• â¯ " \
                --preview-window=up:30% \
                --preview "echo 'é€‰æ‹©æ“ä½œç±»å‹'" \
                --height=15% \
                --header="$(_buildFzfHeader '' 'browser_bookmarks_manage')" \
                --reverse)

        case $action in
            *Safari*) fzf_safari_bookmarks ;;
            *Chrome_Default*) chrome_default_bookmarks ;;
            *Chrome_Profile1*) chrome_profile1_bookmarks ;;
            *Brave_Default*) brave_default_bookmarks ;;
            *Bubu*) fzf_mark_by_buku ;;
            *é€€å‡ºç³»ç»Ÿ*) break 1 && return ;;
        esac
    done
}
alias bm="browser_bookmarks_manage"                                                 # Desc: alias: bm:browser_bookmarks_manageå‘½ä»¤çš„åˆ«å,åˆ©ç”¨fzfç®¡ç†Safariã€Chromeã€Braveæµè§ˆå™¨çš„æ”¶è—
if [ "zsh" = "$nowshell" ]; then
    zle -N browser_bookmarks_manage
    bindkey 'Âµ' browser_bookmarks_manage   #//Alt M æ‰§è¡Œbrowser_bookmarks_manageå‡½æ•°
else
    export -f browser_bookmarks_manage
    bind '"Âµ":"browser_bookmarks_manage;\n"'   #//Alt M æ‰§è¡Œbrowser_bookmarks_manageå‡½æ•°
fi

function goodfon() {                                                                # Desc: function: goodfon:æ‰“å¼€goodfon.ru
    local DEFAULTBROWSER="/Applications/Firefox.app"      #default browser for open goodfon
    local SECONDBROWSER="/Applications/Google Chrome.app" #second browser for open goodfon
    local URL="https://www.goodfon.ru/"

    if [ "$1" = "" ]; then
        [[ -d "$DEFAULTBROWSER" ]] && /usr/bin/open -a "$DEFAULTBROWSER" "$URL"
    fi

    if [ "$1" = "chrome" ] || [ "$1" = "google" ]; then
        [[ -d "$SECONDBROWSER" ]] && /usr/bin/open -a "$SECONDBROWSER" "$URL"
    fi
}
alias gfon="goodfon"                                                                # Desc: alias: gf:goodfonå‘½ä»¤çš„åˆ«å,æ‰“å¼€goodfon.ru

function _checkDirFull() {                                                          # Desc: function: _checkDirFull:éªŒè¯æ–‡ä»¶å¤¹å†…æ–‡ä»¶æ•°é‡æ˜¯å¦åˆ°è¾¾æŒ‡å®šæ•°å€¼
    if [ "" != "$1" ]; then
        local maxsize=2000
        local picpath=$(dirname $1)
        local cursize=$(ls $picpath | wc -l)

        if [ "$cursize" -ge "$maxsize" ]; then
            curcount=$(echo $picpath | tr -cd "[0-9]")
            tmpmiddlecount=$curcount
            curcount=$(($curcount+1))
            [[ $curcount -le 9 ]] && curcount=0$curcount
            prefixpath=$(echo $picpath | sed "s,${tmpmiddlecount},,g")
            newpath="${prefixpath}$curcount"
            [[ ! -d $newpath ]] && mkdir $newpath
            mv $1 $newpath/$(basename $1)
            echo "$1 $newpath/$(basename $1)"
        fi
    fi
}

function autoDiffDownloadPicureByName() {                                           # Desc: function: åˆ©ç”¨fswatchç›‘æ§ç›®å½•ï¼Œé€šè¿‡æ¯”å¯¹æ–‡æœ¬ä¸­æ–‡ä»¶åï¼Œå®ç°è‡ªåŠ¨å»é‡ä¸‹è½½çš„å›¾ç‰‡
    ##å›¾ç‰‡æ–‡ä»¶å¤¹è·¯å¾„
    local PICPATH=$(cat $HOME/.picpath)
    local MYRUNTIME=$(cat $HOME/.myruntime)
    ##æ•°æ®åº“æ–‡ä»¶è·¯å¾„
    local DBFILE=$MYRUNTIME/tools/pictures_db.log
    ##å»é‡æ–‡ä»¶æ•°æ®åº“æ–‡ä»¶è·¯å¾„ï¼ˆä»…æœ‰æ–‡ä»¶åï¼‰
    local FULLFILENAMESDB=$MYRUNTIME/tools/pictures_fullfilenames_db.log
    local COMMANDBIN=sqlite3
    local FULLFILENAMESDB2=$MYRUNTIME/tools/fullfilenames_db.log.sqlitedb
    IFSHOWTHUMB=0
    RECORDTYPE=0
    local msg=""

    [[ "" != "$1" ]] && IFSHOWTHUMB=$1
    [[ "" != "$2" ]] && RECORDTYPE=$2

    curprocessid=$$
    #è°ƒèµ·åå°è„šæœ¬ï¼Œç›‘æ§ç«ç‹æµè§ˆå™¨çŠ¶æ€ï¼Œå¦‚æœæµè§ˆå™¨è¿›ç¨‹æ¶ˆå¤±ï¼Œåˆ™æ€æ­»ä¸‹é¢çš„è¿›ç¨‹
    tmpshell=$(mktemp)
    # echo $tmpshell
    if [ -f $tmpshell ]; then
        echo "#!/usr/bin/env bash\n" > $tmpshell
        echo "curfierfoxcounts=1\n" >> $tmpshell
        echo "while [ \"\$curfierfoxcounts\" -gt \"0\" ]; do\n" >> $tmpshell
        echo "    curfierfoxcounts=\$(ps -ef | grep 'Firefox.app/Contents/MacOS/firefox' | grep -v grep | wc -l)\n" >> $tmpshell
        echo "    sleep 1\n" >> $tmpshell
        echo "done\n" >> $tmpshell
        echo "if [ \"\$curfierfoxcounts\" -lt \"1\" ]; then\n" >> $tmpshell
        echo "    ps -ef | grep \"fswatch -0 \$PICPATH\" | grep -v grep | awk '{print \$2}' | xargs kill\n" >> $tmpshell
        echo "fi\n" >> $tmpshell
    fi
    bash $tmpshell > /dev/null 2>&1 &

    if [[ ! -f $FULLFILENAMESDB2 ]]; then
        local SQL="CREATE TABLE pictures ('id' INTEGER PRIMARY KEY AUTOINCREMENT NOT NULL, 'pic_name' TEXT DEFAULT NULL, 'created_at' DATETIME NOT NULL DEFAULT CURRENT_TIME, 'pic_path' TEXT DEFAULT NULL);"
        $COMMANDBIN $FULLFILENAMESDB2 <<EOF
$SQL
EOF
    fi

    fswatch -0 $PICPATH | while read -d "" event; do
        if [ "$(ps -ef | grep 'Firefox.app/Contents/MacOS/firefox' | grep -v grep | wc -l)" -gt "0" ]; then
            fullfilename=${event}
            filename=$(basename $fullfilename)
            showtype=0
            if [ "0" = "$RECORDTYPE" ]; then
                if [ "$(grep -w $filename $FULLFILENAMESDB)" != "" ]; then
                    tmpresult=$(find $PICPATH/ -type f -name "$filename"  | grep -v "$fullfilename" | wc -l)
                    if [ "$tmpresult" -gt "1" ]; then
                        msg="Already deleted ..."
                        trash $fullfilename
                    fi
                else
                    echo $filename >> $FULLFILENAMESDB
                    msg="Already recorded ..."
                    showtype=1
                    echo $fullfilename >> $DBFILE
                fi
            elif [ "1" = "$RECORDTYPE" ]; then
                [[ ! -f $FULLFILENAMESDB2 ]] && echo "The sqlite db file does not exists !" && return 1
                local SQL="select * from pictures where pic_name = '"${filename}"';"
                local tmpresult=$($COMMANDBIN $FULLFILENAMESDB2 <<EOF
$SQL
EOF
)
                if [ "$tmpresult" != "" ]; then
                    tmpresult=$(find $PICPATH/ -type f -name "$filename"  | grep -v "$fullfilename" | wc -l)
                    if [ "$tmpresult" -gt "1" ]; then
                        msg="Already deleted ..."
                        trash $fullfilename
                    fi
                else
                    local tmp_path=$(dirname $fullfilename)
                    # SQL='insert into pictures (pic_name, pic_path) values ("'"$filename"'", "'"$tmp_path"'");'
                    SQL="insert into pictures (pic_name, pic_path) values ('"$filename"', '"$tmp_path"');"
                    $COMMANDBIN $FULLFILENAMESDB2 <<EOF
$SQL
EOF
                    msg="Already recorded ..."
                    showtype=1
                    echo $fullfilename >> $DBFILE
                fi
            fi
            echo $msg
            _checkDirFull $fullfilename #å­˜æ”¾ç›®å½•æ»¡çš„æƒ…å†µä¸‹è‡ªåŠ¨ç”Ÿæˆç›®å½•å¹¶è¿ç§»æ–°æ–‡ä»¶
            if [ "$IFSHOWTHUMB" -eq "1" ] && [ "$showtype" -eq "1" ]; then
                #å±•ç¤ºå›¾ç‰‡
                printf '\033]1337;File=inline=1;width=20%%;preserveAspectRatio=0'
                printf ":"
                base64 < "$fullfilename"
                printf '\a\n'
            fi
        fi
    done
    rm -f $tmpshell
    ps -ef | grep "fswatch -0 $PICPATH" | grep -v grep | awk '{print $2}' | xargs kill > /dev/null
}

function goodfonWithAutoDiff() {                                                    # Desc: function: æ‰“å¼€goodfon.ruå é€šè¿‡ç›®å½•ç›‘æ§è‡ªåŠ¨è¿‡æ»¤é‡åæ–‡ä»¶
    goodfon
    autoDiffDownloadPicureByName $@
}
alias gfa="goodfonWithAutoDiff"                                                     # Desc: alias: gfa:goodfonWithAutoDiffå‘½ä»¤çš„åˆ«å,æ‰“å¼€goodfon.ruå é€šè¿‡ç›®å½•ç›‘æ§è‡ªåŠ¨è¿‡æ»¤é‡åæ–‡ä»¶

function goodfonWithAutoDiff2() {                                                   # Desc: function: æ‰“å¼€goodfon.ruå é€šè¿‡ç›®å½•ç›‘æ§è‡ªåŠ¨è¿‡æ»¤é‡åæ–‡ä»¶
    goodfon
    autoDiffDownloadPicureByName 0 1
}
alias gfa2="goodfonWithAutoDiff2"                                                   # Desc: alias: gfa2:goodfonWithAutoDiff2å‘½ä»¤çš„åˆ«å,æ‰“å¼€goodfon.ruåé€šè¿‡ç›®å½•ç›‘æ§è‡ªåŠ¨è¿‡æ»¤é‡åæ–‡ä»¶
