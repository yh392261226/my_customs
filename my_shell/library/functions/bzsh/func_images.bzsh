### Package Desc: å›¾ç‰‡ç›¸å…³å‘½ä»¤


function gifify_from_video() {                                                       # Desc: function: gifify_from_video:Animated gifs from any video from Alex Sexton gist.github.com/SlexAxton/4989674
    if [[ -n "$1" ]]; then
        if [[ $2 == '--good' ]]; then
        ffmpeg -i "$1" -r 10 -vcodec png out-static-%05d.png
        time convert -verbose +dither -layers Optimize -resize 900x900\> out-static*.png  GIF:- | gifsicle --colors 128 --delay=5 --loop --optimize=3 - -multifile - > "$1.gif"
        rm out-static*.png
        else
        ffmpeg -i "$1" -s 600x400 -pix_fmt rgb24 -r 10 -f gif - | gifsicle --optimize=3 --delay=3 > "$1.gif"
        fi
    else
        echo "proper usage: gifify <input_movie.mov>. You Do need to include extension."
    fi
}
alias giffv="gifify_from_video"                                                      # Desc: alias: giffv:gifify_from_videoå‘½ä»¤çš„åˆ«å,Animated gifs from any video from Alex Sexton gist.github.com/SlexAxton/4989674

function image_url_cat() {                                                           # Desc: function: image_url_cat:Cat img from url in iterm2
    if [ "$(env | grep 'TERM_PROGRAM=' | sed 's/TERM_PROGRAM=//')" != "iTerm.app" ]; then
        echo "This command can only be used in iterm2 !!!";
        return 0;
    fi

    if [ $# -ne 1 ]; then
        echo "Type $0 image_url"
        return 1;
    fi
    imgurl="$1"
    axel -U 'Mozilla/5.0 (Macintosh; Intel Mac OS X 10_13_4) AppleWebKit/605.1.15 (KHTML, like Gecko) Version/11.1 Safari/605.1.15' -q -o ${TMPDIR:-/tmp}/$(basename  $imgurl) $imgurl

    printf '\033]1337;File=inline=1;width=30%%;preserveAspectRatio=0'
    printf ":"
    base64 < "${TMPDIR:-/tmp}/$(basename $imgurl)"
    printf '\a\n'

    if [ -f ${TMPDIR:-/tmp}/$(basename $imgurl) ]; then
        rm -f ${TMPDIR:-/tmp}/$(basename $imgurl);
    fi
}
alias iuc="image_url_cat"                                                            # Desc: alias: iuc:image_url_catå‘½ä»¤çš„åˆ«å,Cat img from url in iterm2

function images_rename_from_download() {                                             # Desc: function: images_rename_from_download:é‡å‘½åä¸‹è½½çš„å›¾ç‰‡
    echo "è°¨æ…ä½¿ç”¨ï¼Œ ä½¿ç”¨å‰å…ˆå¤‡ä»½ï¼Œå¤šæ¬¡ä½¿ç”¨ç›¸åŒå‰ç¼€ä¼šä½¿ä½ çš„å›¾ç‰‡æ–‡ä»¶äº’ç›¸è¦†ç›–å¯¼è‡´å‡å°‘y|Yï¼ˆä½¿ç”¨ï¼‰n|N(ä¸ä½¿ç”¨)"
    read line;
    if [ "$line" = "y" ] || [ "$line" = "Y" ]; then
        echo "è¯·è¾“å…¥å‰ç¼€"
        read prefix
    m=0
    for i in $(ls $MYRUNTIME/pictures/*.[jpg][png][JPG][JPEG][Jpg][PNG][Png][bmp][Bmp][BMP][gif][GIF][Gif]);
    do
        m=`expr $m + 1`
        #echo æ–‡ä»¶åä¸ºï¼š${i%.*}
        mv $i $MYRUNTIME/pictures/$prefix-$m.${i##*.}
    done
    echo $m
    fi
}
alias irfd="images_rename_from_download"                                             # Desc: alias: irfd:images_rename_from_downloadå‘½ä»¤çš„åˆ«å,é‡å‘½åä¸‹è½½çš„å›¾ç‰‡

function image_resizes() {                                                           # Desc: function: image_resizes:å›¾ç‰‡å‹ç¼©
    mkdir -p out &&
    for jpg in *.JPG; do
        echo $jpg
        [ -e out/$jpg ] || sips -Z 2048 --setProperty formatOptions 80 $jpg --out out/$jpg
    done
}
alias ir="image_resizes"                                                             # Desc: alias: ir:image_resizeså‘½ä»¤çš„åˆ«å,å›¾ç‰‡å‹ç¼©

function fzf_iterm2_background_image_selector() {                                    # Desc: function: fzf_iterm2_background_image_selector: åˆ©ç”¨fzfé€‰æ‹©iterm2çš„èƒŒæ™¯å›¾ç‰‡
    IMGPATH=$MYRUNTIME/pictures
    [[ "" != "$1" ]] && IMGPATH=$1
    customcd $IMGPATH
    selected=$(ls . | fzf $FZF_CUSTOM_PARAMS --preview-window right:70%:rounded:hidden:wrap --preview ' chafa -f iterm -s ${FZF_PREVIEW_COLUMNS}x${FZF_PREVIEW_LINES} {} ' --header="$(_buildFzfHeader '' 'fzf_iterm2_background_image_selector')")
    bg_change ${IMGPATH}/${selected}
    customcd -
    #echo "bg_change ${IMGPATH}/${selected}" | pbcopy
    #echo "Ctrl - V to paste the command, then press enter to execute."
}
alias fbg="fzf_iterm2_background_image_selector"                                     # Desc: alias: fbg: fzf_iterm2_background_image_selectorå‘½ä»¤çš„åˆ«å,åˆ©ç”¨fzfé€‰æ‹©iterm2çš„èƒŒæ™¯å›¾ç‰‡


function get_iterm2_current_background_image() {                                     # Desc: function: get_iterm2_current_background_image: è·å–å½“å‰itermçš„sessionä¸­èƒŒæ™¯å›¾åœ°å€
    bg_path=$(osascript -e '
tell application "iTerm"
    if current window is missing value then
        return ""
    end if
    
    tell current window
        if current session is missing value then
            return ""
        end if
        
        tell current session
            if background image is not missing value then
                return background image
            else
                return ""
            end if
        end tell
    end tell
end tell')

    # æ£€æŸ¥ç»“æœ
    if [[ -n "$bg_path" && "$bg_path" != "missing value" ]]; then
        echo "$bg_path"
    fi
    return
}
alias gicbg="get_iterm2_current_background_image"                                    # Desc: alias: gicbg: get_iterm2_current_background_imageå‘½ä»¤çš„åˆ«åï¼Œè·å–å½“å‰itermçš„sessionä¸­èƒŒæ™¯å›¾åœ°å€

check_favo_exists() {
    MYRUNTIME=$(cat ${HOME}/.myruntime)
    RUNTIME_DIR="${MYRUNTIME}/tools"
    curmark=$(basename $(readlink $MYRUNTIME/pictures))
    FAVO_MARK="${RUNTIME_DIR}/m_favorate_${curmark}"

    if grep -qF "$(get_iterm2_current_background_image)" "${FAVO_MARK}"; then
        echo "1"
        return 1
    fi
    echo "0"
    return 0
}

function fzf_favo_manager() {                                                       # Desc: function: fzf_favo_manager: åˆ©ç”¨fzfç®¡ç†è‡ªå®šä¹‰çš„favoå‘½ä»¤
    custom_gum_show2hide_header "èƒŒæ™¯å›¾æ”¶è—ç®¡ç†" || echo -e "èƒŒæ™¯å›¾æ”¶è—ç®¡ç†"
    local action=$(printf "%s\n" \
        $(if [ "$TERM_PROGRAM" = "iTerm.app" ] && [ "" != "$(get_iterm2_current_background_image)" ] && [ "1" != "$(check_favo_exists)" ]; then echo "ğŸ—‚ï¸æ”¶è—èƒŒæ™¯å›¾ï¼ˆcollectionï¼‰"; fi) \
        "ğŸŒ æ‰€æœ‰æ”¶è—(All)" \
        "ğŸ”ï¸ æ¨¡ç³Šæœç´¢(Search)" \
        "ğŸ“ƒ ç”ŸæˆHTMLç›¸å†Œ(HTML)" \
        "ğŸ–¼ï¸ è®¾ç½®æŒ‡å®šå›¾ç‰‡ä¸ºèƒŒæ™¯(Set)" \
        "ğŸ”€ éšæœºåˆ‡æ¢èƒŒæ™¯(Random)" \
        "ğŸ“ åœ¨Finderä¸­å®šä½æ–‡ä»¶(Locate)" \
        "ğŸ—ºï¸ æ˜¾ç¤ºç¼©ç•¥å›¾(Thumb)" \
        "ğŸ› ï¸ é‡å»ºæ”¶è—åˆ—è¡¨(Rebuild)" \
        "ğŸ—“ï¸ è¡¨æ ¼å½¢å¼å±•ç¤ºæ”¶è—(Table)" \
        "ğŸ—‘ï¸ åˆ é™¤(Remove)" \
        "ğŸ’¡ å¸®åŠ©(Help)" \
        "ğŸ”™ è¿”å›" | \
        fzf +m \
            --header " èƒŒæ™¯å›¾æ”¶è—ç®¡ç†ç³»ç»Ÿ " \
            --prompt "ä¸»èœå• â¯ " \
            --preview-window=up:30% \
            --preview "echo 'è¯·é€‰æ‹©æ“ä½œç±»å‹'" \
            --height=15% \
            --bind='space:jump,jump:accept' \
            --reverse)

    case $action in
        *æ”¶è—èƒŒæ™¯å›¾*) 
            $MYRUNTIME/customs/bin/favo add
            return 
            ;;
        *æ‰€æœ‰æ”¶è—*) $MYRUNTIME/customs/bin/favo list
            return 
            ;;
        *æ¨¡ç³Šæœç´¢*) 
            local text
            if command -v gum >/dev/null; then
                text=$(gum input --placeholder "Type search text")
            else
                read text
            fi
            
            [[ "" != "$text" ]] && $MYRUNTIME/customs/bin/favo search "$text"
            return 
            ;;
        *ç”ŸæˆHTMLç›¸å†Œ*) $MYRUNTIME/customs/bin/favo html
            return 
            ;;
        *è®¾ç½®æŒ‡å®šå›¾ç‰‡ä¸ºèƒŒæ™¯*) 
            local img
            if command -v gum >/dev/null; then
                img=$(gum input --placeholder "Type image location")
            else
                read img
            fi
            $MYRUNTIME/customs/bin/favo set "$img"
            return 
            ;;
        *éšæœºåˆ‡æ¢èƒŒæ™¯*) $MYRUNTIME/customs/bin/favo random
            return 
            ;;
        *åœ¨Finderä¸­å®šä½æ–‡ä»¶*) $MYRUNTIME/customs/bin/favo locate
            return 
            ;;
        *æ˜¾ç¤ºç¼©ç•¥å›¾*) $MYRUNTIME/customs/bin/favo thumb
            return 
            ;;
        *é‡å»ºæ”¶è—åˆ—è¡¨*) $MYRUNTIME/customs/bin/favo rebuild
            return 
            ;;
        *è¡¨æ ¼å½¢å¼å±•ç¤ºæ”¶è—*) $MYRUNTIME/customs/bin/favo table
            return 
            ;;
        *åˆ é™¤*) $MYRUNTIME/customs/bin/favo remove
            return 
            ;;
        *å¸®åŠ©*) $MYRUNTIME/customs/bin/favo help
            return 
            ;;
        *è¿”å›*) return ;;
    esac
}
alias ffm2="fzf_favo_manager"                                                       # Desc: alias: ffm2: fzf_favo_managerå‘½ä»¤çš„åˆ«åï¼Œåˆ©ç”¨fzfç®¡ç†è‡ªå®šä¹‰çš„favoå‘½ä»¤

function fzf_img_manager() {                                                        # Desc: function: fzf_img_manager: åˆ©ç”¨fzfç®¡ç†è‡ªå®šä¹‰çš„imgå‘½ä»¤
    custom_gum_show2hide_header "å›¾ç‰‡ä¸‹è½½ç®¡ç†" || echo -e "å›¾ç‰‡ä¸‹è½½ç®¡ç†"
    local options=(
        "å…¨ç›®å½•è®°å½•(record)"
        "å»é‡å¹¶è®°å½•(uniq)"
        "é‡å¤æ–‡ä»¶åˆ†ç¦»(move)"
        "æ‰“å¼€ç›®å½•(open)"
        "æœªæ»¡çŠ¶æ€æŸ¥çœ‹(unfull)"
        "å±•ç¤ºé‡å¤(after)"
        "è®°å½•å»é‡åé‡å¤çš„(duprecord)"
        "å»é‡åå†å»é‡(dupuniq)"
        "å»é‡åå±•ç¤ºé‡å¤(dupafter)"
        "æŸ¥æ‰¾ç©ºæ–‡ä»¶(empty)"
        "ç›‘æ§(watch)"
        "å¸®åŠ©(help)"
        "ğŸ”™ è¿”å›"
    )
    while true; do        
        local selection=$(printf '%s\n' "${options[@]}" | fzf \
            --height=30% \
            --reverse \
            --prompt="â¤ å›¾ç‰‡ > " 
        )
        
        case $selection in
            *record*) $MYRUNTIME/customs/bin/img record ;;
            *uniq*) $MYRUNTIME/customs/bin/img uniq ;;
            *move*) $MYRUNTIME/customs/bin/img move ;;
            *open*) $MYRUNTIME/customs/bin/img open ;;
            *unfull*) $MYRUNTIME/customs/bin/img unfull ;;
            *after*) $MYRUNTIME/customs/bin/img after ;;
            *duprecord*) $MYRUNTIME/customs/bin/img duprecord ;;
            *dupuniq*) $MYRUNTIME/customs/bin/img dupuniq ;;
            *dupafter*) $MYRUNTIME/customs/bin/img dupafter ;;
            *empty*) $MYRUNTIME/customs/bin/img empty ;;
            *watch*) 
                while true; do
                    echo "===== $(date) ====="    
                    $MYRUNTIME/customs/bin/img unfull
                    sleep 5
                done
            ;;
            *help*) $MYRUNTIME/customs/bin/img help ;;
            "ğŸ”™ è¿”å›"|*)
                break
                ;;
        esac
    done
}
alias fim="fzf_img_manager"                                                         # Desc: alias: fim: fzf_img_managerå‘½ä»¤çš„åˆ«åï¼Œåˆ©ç”¨fzfç®¡ç†è‡ªå®šä¹‰çš„imgå‘½ä»¤

function fzf_image_manager() {                                                      # Desc: function: fzf_image_manager: åˆ©ç”¨fzfç®¡ç†è‡ªå®šä¹‰çš„å›¾ç‰‡å‘½ä»¤
    local options=(
        "å›¾ç‰‡æ”¶è—(favo)"
        "ä¸‹è½½å›¾ç‰‡(img)"
        "ğŸ”™ è¿”å›"
    )
    custom_gum_show2hide_header "å›¾ç‰‡ç®¡ç†" || echo -e "å›¾ç‰‡ç®¡ç†"
    while true; do
        
        local selection=$(printf '%s\n' "${options[@]}" | fzf \
            --height=30% \
            --reverse \
            --prompt="â¤ å›¾ç‰‡ > " 
        )
        
        case $selection in
            *favo*)
                fzf_favo_manager
                ;;
            *img*)
                fzf_img_manager
                ;;
            "ğŸ”™ è¿”å›"|*)
                break
                ;;
        esac
    done
}
alias fimg="fzf_image_manager"                                                      # Desc: alias: fimg: fzf_image_managerå‘½ä»¤çš„åˆ«åï¼Œåˆ©ç”¨fzfç®¡ç†è‡ªå®šä¹‰çš„å›¾ç‰‡å‘½ä»¤

function fzf_favorate_image_manager() {                                             # Desc: function: fzf_favorate_image_manageråˆ©ç”¨fzf é…åˆè‡ªå®šä¹‰çš„ favo å‘½ä»¤ç®¡ç† iterm2 çš„èƒŒæ™¯å›¾
    local action=$(printf "%s\n" \
        $(if [ "$TERM_PROGRAM" = "iTerm.app" ] && [ "" != "$(get_iterm2_current_background_image)" ] && [ "1" != "$(check_favo_exists)" ]; then echo "ğŸ—‚ï¸æ”¶è—èƒŒæ™¯å›¾ï¼ˆcollectionï¼‰"; fi) \
        "ğŸŒ æ‰€æœ‰æ”¶è—(All)" \
        "ğŸ”ï¸ æ¨¡ç³Šæœç´¢(Search)" \
        "ğŸ“ƒ ç”ŸæˆHTMLç›¸å†Œ(HTML)" \
        "ğŸ–¼ï¸ è®¾ç½®æŒ‡å®šå›¾ç‰‡ä¸ºèƒŒæ™¯(Set)" \
        "ğŸ”€ éšæœºåˆ‡æ¢èƒŒæ™¯(Random)" \
        "ğŸ“ åœ¨Finderä¸­å®šä½æ–‡ä»¶(Locate)" \
        "ğŸ—ºï¸ æ˜¾ç¤ºç¼©ç•¥å›¾(Thumb)" \
        "ğŸ› ï¸ é‡å»ºæ”¶è—åˆ—è¡¨(Rebuild)" \
        "ğŸ—“ï¸ è¡¨æ ¼å½¢å¼å±•ç¤ºæ”¶è—(Table)" \
        "ğŸ—‘ï¸ åˆ é™¤(Remove)" \
        "ğŸ’¡ å¸®åŠ©(Help)" \
        "ğŸ”š é€€å‡ºç³»ç»Ÿ(Exit)" | \
        fzf +m \
            --header " èƒŒæ™¯å›¾æ”¶è—ç®¡ç†ç³»ç»Ÿ " \
            --prompt "ä¸»èœå• â¯ " \
            --preview-window=up:30% \
            --preview "echo 'è¯·é€‰æ‹©æ“ä½œç±»å‹'" \
            --height=15% \
            --bind='space:jump,jump:accept' \
            --reverse)

    case $action in
        *æ”¶è—èƒŒæ™¯å›¾*) 
            $MYRUNTIME/customs/bin/favo add
            return 
            ;;
        *æ‰€æœ‰æ”¶è—*) $MYRUNTIME/customs/bin/favo list
            return 
            ;;
        *æ¨¡ç³Šæœç´¢*) 
            hascommand=$(ifHasCommand gum)
            local text
            if [ $hascommand = 1 ]; then
                text=$(gum input --placeholder "Type search text")
            else
                read text
            fi
            
            [[ "" != "$text" ]] && $MYRUNTIME/customs/bin/favo search "$text"
            return 
            ;;
        *ç”ŸæˆHTMLç›¸å†Œ*) $MYRUNTIME/customs/bin/favo html
            return 
            ;;
        *è®¾ç½®æŒ‡å®šå›¾ç‰‡ä¸ºèƒŒæ™¯*) 
            hascommand=$(ifHasCommand gum)
            local img
            if [ $hascommand = 1 ]; then
                img=$(gum input --placeholder "Type image location")
            else
                read img
            fi
            $MYRUNTIME/customs/bin/favo set "$img"
            return 
            ;;
        *éšæœºåˆ‡æ¢èƒŒæ™¯*) $MYRUNTIME/customs/bin/favo random
            return 
            ;;
        *åœ¨Finderä¸­å®šä½æ–‡ä»¶*) $MYRUNTIME/customs/bin/favo locate
            return 
            ;;
        *æ˜¾ç¤ºç¼©ç•¥å›¾*) $MYRUNTIME/customs/bin/favo thumb
            return 
            ;;
        *é‡å»ºæ”¶è—åˆ—è¡¨*) $MYRUNTIME/customs/bin/favo rebuild
            return 
            ;;
        *è¡¨æ ¼å½¢å¼å±•ç¤ºæ”¶è—*) $MYRUNTIME/customs/bin/favo table
            return 
            ;;
        *åˆ é™¤*) $MYRUNTIME/customs/bin/favo remove
            return 
            ;;
        *å¸®åŠ©*) $MYRUNTIME/customs/bin/favo help
            return 
            ;;
        *é€€å‡ºç³»ç»Ÿ*) return ;;
    esac
}
alias ffi="fzf_favorate_image_manager"                                              # Desc: alias: ffi: fzf_favorate_image_managerå‘½ä»¤çš„åˆ«åï¼Œåˆ©ç”¨fzf é…åˆè‡ªå®šä¹‰çš„ favo å‘½ä»¤ç®¡ç† iterm2 çš„èƒŒæ™¯å›¾

if [ "zsh" = "$nowshell" ]; then
    zle -N fzf_favorate_image_manager
    bindkey '^P' fzf_favorate_image_manager   #//Ctrl P æ‰§è¡Œfzf_favorate_image_managerå‡½æ•°
else
    export -f fzf_favorate_image_manager
    bind '"\C-P":"fzf_favorate_image_manager;\n"'   #//Ctrl P æ‰§è¡Œfzf_favorate_image_managerå‡½æ•°
fi