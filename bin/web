#!/usr/bin/env bash
### Desc: äº¤äº’å¼ç½‘å€ç®¡ç†å™¨ï¼šé€šè¿‡fzfè¿›è¡Œä¸¤çº§é€‰æ‹©

WEBSITELOGS="$MYRUNTIME/tools/websites"
OPENBROWSER="/Applications/Safari.app"
FZF_DEFAULT_OPTS="--height 40% --reverse --border rounded --margin 2,5% --info=hidden"
VALID_EXT=_websites.log

[ -f "$MYRUNTIME/customs/my_shell/library/core/bzsh/core_common.bzsh" ] && \
  source "$MYRUNTIME/customs/my_shell/library/core/bzsh/core_common.bzsh"
[ -f "$MYRUNTIME/customs/my_shell/library/others/bzsh/others_fzf.bzsh" ] && \
  source "$MYRUNTIME/customs/my_shell/library/others/bzsh/others_fzf.bzsh"

# åˆå§‹åŒ–ç›®å½•
[[ ! -d $WEBSITELOGS ]] && mkdir -p "$WEBSITELOGS"

# é¢œè‰²å®šä¹‰
COLOR_HEADER=$'\033[38;5;228m'
COLOR_RESET=$'\033[0m'

# å¸®åŠ©ä¿¡æ¯
function __help() {
  echo "${COLOR_HEADER}"
  cat << EOF
â•­â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
â”‚
â”‚ ${COLOR_HEADER}ğŸ“š ç½‘å€ç®¡ç†å™¨ v2.0${COLOR_RESET}
â”‚ 
â”‚ ä½¿ç”¨æ–¹å¼ï¼š
â”‚   web [å‘½ä»¤]
â”‚ 
â”‚ å¯ç”¨å‘½ä»¤ï¼š
â”‚   ${COLOR_HEADER}create <åç§°>${COLOR_RESET}  - åˆ›å»ºæ–°åˆ†ç±»
â”‚   ${COLOR_HEADER}edit   <åç§°>${COLOR_RESET}  - ç¼–è¾‘åˆ†ç±»
â”‚   ${COLOR_HEADER}dir${COLOR_RESET}           - æ‰“å¼€åˆ†ç±»ç›®å½•
â”‚   ${COLOR_HEADER}help${COLOR_RESET}          - æ˜¾ç¤ºå¸®åŠ©ä¿¡æ¯
â”‚ 
â”‚ äº¤äº’æ¨¡å¼ï¼š
â”‚   ç›´æ¥è¿è¡Œ web è¿›å…¥äº¤äº’é€‰æ‹©ï¼š
â”‚   1. é€‰æ‹©åˆ†ç±» â†’ 2. é€‰æ‹©ç½‘å€ï¼ˆæ”¯æŒå¤šé€‰ï¼‰
â”‚ 
â”‚ å¿«æ·é”®è¯´æ˜ï¼š
â”‚   ${COLOR_HEADER}åˆ†ç±»é€‰æ‹©ç•Œé¢${COLOR_RESET}
â”‚   - Ctrl+H æ˜¾ç¤ºå¸®åŠ©
â”‚   - Ctrl+O æ‰“å¼€åˆ†ç±»ç›®å½•
â”‚   - Ctrl+N åˆ›å»ºæ–°åˆ†ç±»
â”‚ 
â”‚   ${COLOR_HEADER}ç½‘å€é€‰æ‹©ç•Œé¢${COLOR_RESET}
â”‚   - Tab     å¤šé€‰
â”‚   - Ctrl+Y  å¤åˆ¶é€‰ä¸­ç½‘å€
â”‚   - Ctrl+E  ç¼–è¾‘å½“å‰åˆ†ç±»
â”‚   - Ctrl+O  åœ¨Finderä¸­æ˜¾ç¤ºæ–‡ä»¶
â•°â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
EOF
  echo "${COLOR_RESET}"
}

# è·å–åˆ†ç±»åˆ—è¡¨
function __get_categories() {
  local categories=()
  for f in $(ls $WEBSITELOGS/*${VALID_EXT}); do
    if [[ -f $f ]]; then
		local title=$(head -n1 "$f" | cut -d'#' -f1 | sed 's/#/ /g')
		categories+=("$(basename "$f" | sed "s/${VALID_EXT}//")#$title")
	fi
  done
  printf "%s\n" "${categories[@]}"
}

# åˆ†ç±»é€‰æ‹©ç•Œé¢
function __select_category() {
  local categories=($(__get_categories))
  [[ ${#categories[@]} -eq 0 ]] && {
    echo "æ²¡æœ‰æ‰¾åˆ°ä»»ä½•åˆ†ç±»ï¼Œä½¿ç”¨ web create <åç§°> åˆ›å»ºæ–°åˆ†ç±»"
    return 1
  }

  IFS=$'\n' sorted=($(sort <<< "${categories[*]}"))
  unset IFS

  printf "%s\n" "${sorted[@]}" | fzf $FZF_CUSTOM_PARAMS \
	--height=95% \
    --delimiter='#' \
    --with-nth=2 \
    --header="${COLOR_HEADER}ğŸ“‚ é€‰æ‹©åˆ†ç±» (Ctrl-H å¸®åŠ©)${COLOR_RESET}" \
    --preview="bat --style=numbers --color=always ${WEBSITELOGS}/{1}${VALID_EXT}" \
    --preview-window="right:70%:wrap" \
    --bind="ctrl-o:execute(open \"$WEBSITELOGS\")+abort" \
	  --bind="ctrl-h:change-preview-label( â•¢ Help Infomation â•Ÿ )+preview($MYRUNTIME/customs/bin/web help)+show-preview" \
    --bind="ctrl-n:execute($MYRUNTIME/customs/bin/web create)+abort" \
    --expect=ctrl-e
}

# ç½‘å€é€‰æ‹©ç•Œé¢
function __select_urls() {
  local file="$1"
  [[ -s "$file" ]] || {
    echo "ç©ºåˆ†ç±»æ–‡ä»¶ï¼š$file"
    return 1
  }

  local header=$(head -n1 "$file")
  local format="%-20s %s"
  
  cat "$file" | tail -n +2 | fzf \
    --multi \
    --delimiter='#' \
    --with-nth=1 \
    --header="${COLOR_HEADER}ğŸŒ é€‰æ‹©ç½‘å€ (Tabå¤šé€‰) [${header%%#*}]${COLOR_RESET}" \
    --preview='echo "{1}\n{2}"' \
    --preview-window="right:70%:wrap" \
	--height=95% \
    --bind="ctrl-y:execute-silent(printf '%s' {2} | pbcopy)+abort" \
    --bind="ctrl-e:execute(nvim \"$file\" < /dev/tty > /dev/tty)+reload(cat \"$file\")" \
    --bind="ctrl-o:execute(open -R \"$file\")+abort" \
    --bind="ctrl-h:change-preview-label( â•¢ Help Infomation â•Ÿ )+preview($MYRUNTIME/customs/bin/web help)+show-preview" \
    --header-first \
    --prompt="â¤ " | \
    awk -F'#' '{print $2}'
}

# ä¸»é€»è¾‘
function main() {
  case $1 in
    help|--help|-h)
      __help
      ;;
    create)
      local name="${2:-$(date +%s)}"
      local target="$WEBSITELOGS/${name}${VALID_EXT}"
      [[ ! -f "$target" ]] && echo "# æ–°åˆ†ç±»æè¿°ï¼ˆé¦–è¡Œä½œä¸ºæ ‡é¢˜ï¼‰" > "$target"
      nvim "$target"
      ;;
    edit)
      local target="$WEBSITELOGS/${2}${VALID_EXT}"
      [[ -f "$target" ]] && nvim "$target" || echo "åˆ†ç±»ä¸å­˜åœ¨"
      ;;
    dir)
      open "$WEBSITELOGS"
      ;;
    *)
      local result=${1:-$(__select_category)}
      [[ -z "$result" ]] && return

      local key=$(head -1 <<< "$result")
      local category=$(tail -1 <<< "$result" | cut -d'#' -f1)
      local target="$WEBSITELOGS/${category}${VALID_EXT}"

      # å¤„ç†ç‰¹æ®ŠæŒ‰é”®
      case $key in
        ctrl-e)
          nvim "$target"
          return
          ;;
      esac

      # é€‰æ‹©ç½‘å€
      local urls=$(__select_urls "$target")
      [[ -z "$urls" ]] && return

      while read -r url; do
        [[ -n "$url" ]] && open -a "$OPENBROWSER" "$url"
      done <<< "$urls"
      ;;
  esac
}

main "$@"