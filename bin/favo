#!/usr/bin/env bash
########################################
## Desc: å›¾ç‰‡æ”¶è—ç®¡ç†è„šæœ¬ (ä¼˜åŒ–ç‰ˆ)
## Author: æ¨æµ©
########################################

# --------------------------
# ç¯å¢ƒé…ç½®
# --------------------------
MYRUNTIME=$(cat ${HOME}/.myruntime)
RUNTIME_DIR="${MYRUNTIME}/tools"
curmark=$(basename $(readlink $MYRUNTIME/pictures))
FAVO_MARK="${RUNTIME_DIR}/m_favorate_${curmark}"
FAVO_HTML="${RUNTIME_DIR}/m_favorate_${curmark}.html"
CURRENT_PIC="${RUNTIME_DIR}/current_picturename"
TMPFILE=/tmp/favo_tmp
DEFAULT_BROWSER="/Applications/Safari.app"
BACKUP_BROWSER="/Applications/Google Chrome.app"
THUMB_SIZE="40"  # é»˜è®¤ç¼©ç•¥å›¾å°ºå¯¸

# --------------------------
# åˆå§‹åŒ–æ£€æŸ¥
# --------------------------
init_check() {
  [[ ! -d "${RUNTIME_DIR}" ]] && mkdir -p "${RUNTIME_DIR}"
  
  local required_commands=("trash" "fzf" "viu")
  for cmd in "${required_commands[@]}"; do
    if ! command -v "${cmd}" &> /dev/null; then
      echo "é”™è¯¯: ç¼ºå°‘ä¾èµ–å‘½ä»¤ ${cmd}"
      exit 1
    fi
  done

  [[ ! -f "${CURRENT_PIC}" ]] && touch "${CURRENT_PIC}"
  [[ ! -f "${FAVO_MARK}" ]] && touch "${FAVO_MARK}"
}

# --------------------------
# æ ¸å¿ƒåŠŸèƒ½
# --------------------------

# è·å–å½“å‰å›¾ç‰‡è·¯å¾„
get_current_pic() {
  [[ -f "${CURRENT_PIC}" ]] && cat "${CURRENT_PIC}" || echo ""
}

# æ˜¾ç¤ºç¼©ç•¥å›¾
show_thumbnail() {
  local img_path="${1:-$(get_current_pic)}"
  [[ -z "${img_path}" ]] && return 1
  
  viu --width "${THUMB_SIZE}" "${img_path}"
}

# æ·»åŠ æ”¶è—
add_favorite() {
  local target_pic="${1:-$(get_current_pic)}"
  [[ -z "${target_pic}" ]] && return 1

  if grep -qF "${target_pic}" "${FAVO_MARK}"; then
    echo "å›¾ç‰‡å·²å­˜åœ¨æ”¶è—!"
    return 1
  fi

  echo "${target_pic}" >> "${FAVO_MARK}" && sort -u "${FAVO_MARK}" -o "${FAVO_MARK}"
  echo "æˆåŠŸæ·»åŠ æ”¶è—!"
}

# åˆ é™¤æ”¶è—
remove_favorite() {
  local target_id="${1}"
  if [[ -z "${target_id}" ]]; then
    interactive_remove
  else
    remove_by_id "${target_id}"
  fi
}

interactive_remove() {
  local header="ğŸ–¼ï¸ å›¾ç‰‡æ”¶è— (å…± $(wc -l < "${FAVO_MARK}") å¼ )"
  local preview_cmd='viu --width 100 $(echo {} | awk -F"â”‚" "{print \$2}")'
  local selected=$(nl -w2 -s' â”‚ ' "${FAVO_MARK}" | fzf $FZF_CUSTOM_PARAMS --header="é€‰æ‹©è¦åˆ é™¤çš„å›¾ç‰‡ (æŒ‰ESCé€€å‡º)" +m \
       --delimiter='â”‚' \
       --border-label="â•¢ Favorate Images â•Ÿ" \
       --ghost="Type your search words â”ˆâ”‰ " \
       --preview-window="right,50%,border-left,<50(up,30%,border-bottom),nohidden,~3"  \
       --bind "ctrl-d:execute(echo {} | awk -F'â”‚' '{print \$2}' | xargs trash)+abort" \
       --bind "ctrl-o:execute(echo {} | awk -F'â”‚' '{print \$2}' | xargs open -R)+abort" \
       --header "${header}" \
       --preview "${preview_cmd} ")
  [[ -z "${selected}" ]] && return
  selected=$(basename $(echo "$selected" | awk -F'â”‚' '{print $2}'))
  cat ${FAVO_MARK} | grep -v "$selected" > $TMPFILE
  [[ -f $TMPFILE ]] && rm -f ${FAVO_MARK} && mv $TMPFILE ${FAVO_MARK}
}

# --------------------------
# äº¤äº’å¼åˆ—è¡¨ (å¸¦é¢„è§ˆ)
# --------------------------
list_favorites() {
  [[ ! -s "${FAVO_MARK}" ]] && echo "æ”¶è—åˆ—è¡¨ä¸ºç©º" && return 1

  local header="ğŸ–¼ï¸ å›¾ç‰‡æ”¶è— (å…± $(wc -l < "${FAVO_MARK}") å¼ )"
  local preview_cmd='viu --width 100 $(echo {} | awk -F"â”‚" "{print \$2}")'
  
  # æ„å»ºå¸¦åºå·çš„åˆ—è¡¨
  local selected=$(nl -w2 -s' â”‚ ' "${FAVO_MARK}" | \
    fzf $FZF_CUSTOM_PARAMS +m\
       --delimiter='â”‚' \
       --border-label="â•¢ Favorate Images â•Ÿ" \
       --ghost="Type your search words â”ˆâ”‰ " \
       --preview-window="right,50%,border-left,<50(up,30%,border-bottom),nohidden,~3"  \
       --preview "${preview_cmd} " \
       --header "${header}" \
       --reverse \
       --bind "ctrl-d:execute(echo {} | awk -F'â”‚' '{print \$2}' | xargs trash)+abort" \
       --bind "ctrl-o:execute(echo {} | awk -F'â”‚' '{print \$2}' | xargs open -R)+abort" \
       --bind="ctrl-u:become(${MYRUNTIME}/customs/bin/_actioner {2})" \
       --prompt="â¯ é€‰æ‹©å›¾ç‰‡ (CTRL+Dåˆ é™¤ CTRL+Oå®šä½) > " \
       --ansi)
  [[ -z "${selected}" ]] && return
  selected=$(echo "$selected" | awk -F'â”‚' '{print $2}')
  set_background $selected
}

generate_html() {
  [[ ! -s "${FAVO_MARK}" ]] && return 1

  cat <<HTML_HEAD > "${FAVO_HTML}"
<!DOCTYPE html>
<html>
<head>
  <meta http-equiv="Content-Type" content="text/html; charset=utf-8">
  <title>å›¾ç‰‡æ”¶è—</title>
  <style>
    .gallery {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
      gap: 15px;
      padding: 20px;
    }
    .img-container {
      overflow: hidden;
      border-radius: 8px;
      transition: transform 0.3s ease;
    }
    img {
      width: 100%;
      height: 200px;
      object-fit: cover;
      transition: all 0.3s ease;
      cursor: zoom-in;
      box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    }
    img:hover {
      transform: scale(1.1);
      box-shadow: 0 4px 8px rgba(0,0,0,0.2);
      z-index: 2;
    }
    body {
      background-color: #f5f5f5;
      margin: 0;
      font-family: Arial, sans-serif;
    }
    h1 {
      text-align: center;
      color: #333;
      padding: 20px;
    }
    .modal {
      display: none;
      position: fixed;
      z-index: 999;
      left: 0;
      top: 0;
      width: 100%;
      height: 100%;
      background: rgba(0,0,0,0.9);
      cursor: zoom-out;
    }
    .modal-content {
      position: absolute;
      top: 10%;
      left: 20%;
      right: 20%;
      bottom: 10%;
      max-width: 1200px;
      max-height: 675px;
      object-fit: contain;
      box-shadow: 0 0 30px rgba(255,255,255,0.2);
      border-radius: 4px;
      width: 900px;
      height: 506px;
    }
  </style>
  <script>
    function openModal(imgSrc) {
      const modal = document.createElement('div');
      modal.className = 'modal';
      modal.innerHTML = \`<img class="modal-content" src="\${imgSrc}" onclick="closeModal()">\`;
      document.body.appendChild(modal);
      modal.style.display = "block";
    }
    
    function closeModal() {
      const modal = document.querySelector('.modal');
      if(modal) modal.remove();
    }
  </script>
</head>
<body>
  <h1>æˆ‘çš„å›¾ç‰‡æ”¶è— ($(wc -l < "${FAVO_MARK}"))</h1>
  <div class="gallery">
HTML_HEAD

  while IFS= read -r img; do
    # ä¿®æ”¹å›¾ç‰‡é“¾æ¥ä¸ºè°ƒç”¨JavaScriptå‡½æ•°
    echo "<div class=\"img-container\"><img src=\"file://${img}\" alt=\"${img##*/}\" onclick=\"openModal('file://${img}')\"></div>" >> "${FAVO_HTML}"
  done < "${FAVO_MARK}"

  echo "</div></body></html>" >> "${FAVO_HTML}"
  open "${FAVO_HTML}" -a "${DEFAULT_BROWSER:-${BACKUP_BROWSER}}" --args --allow-file-access-from-files
}

# è®¾ç½®èƒŒæ™¯
set_background() {
  local img_path="${1}"
  [[ ! -f "${img_path}" ]] && return 1

  echo "${img_path}" > "${CURRENT_PIC}"
  osascript <<APPLESCRIPT
  tell application "iTerm"
    tell current window
      tell current session
        set background image to "${img_path}"
      end tell
    end tell
  end tell
APPLESCRIPT
}

# --------------------------
# è¾…åŠ©åŠŸèƒ½
# --------------------------

# éšæœºåˆ‡æ¢
random_pic() {
  local total=$(wc -l < "${FAVO_MARK}")
  [[ "${total}" -eq 0 ]] && return 1
  local rand_num=$((RANDOM % total))
  echo "Random Change Background Done ."
  set_background "$(sed -n "${rand_num}p" "${FAVO_MARK}")"
}

# æ–‡ä»¶å®šä½
locate_file() {
  open -R "$(get_current_pic)"
}

# æ¨¡ç³Šæœç´¢
fuzzy_search() {
  local keyword="${1}"
  [[ -z "${keyword}" ]] && read -p "è¾“å…¥æœç´¢å…³é”®è¯: " keyword
  [[ -z "${keyword}" ]] && return
  local header="ğŸ–¼ï¸ å›¾ç‰‡æ”¶è— (å…± $(wc -l < "${FAVO_MARK}") å¼ )"
  local preview_cmd='viu --width 100 $(echo {} | awk -F"â”‚" "{print \$2}")'
  local selected=$(nl -w2 -s' â”‚ ' "${FAVO_MARK}" | grep "${keyword}" | fzf $FZF_CUSTOM_PARAMS +m\
       --delimiter='â”‚' \
       --border-label="â•¢ Favorate Images â•Ÿ" \
       --ghost="Type your search words â”ˆâ”‰ " \
       --preview-window="right,50%,border-left,<50(up,30%,border-bottom),nohidden,~3"  \
       --preview "${preview_cmd} " \
       --header "${header}" \
       --reverse \
       --bind "ctrl-d:execute(echo {} | awk -F'â”‚' '{print \$2}' | xargs trash)+abort" \
       --bind "ctrl-o:execute(echo {} | awk -F'â”‚' '{print \$2}' | xargs open -R)+abort" \
       --prompt="â¯ é€‰æ‹©å›¾ç‰‡ (CTRL+Dåˆ é™¤ CTRL+Oå®šä½) > " \
       --ansi)
  [[ -z "${selected}" ]] && return
  selected=$(echo "$selected" | awk -F'â”‚' '{print $2}')
  # echo $selected; return
  set_background $selected
}

# --------------------------
# ä¸»ç¨‹åº
# --------------------------
main() {
  init_check

  case "${1}" in
    add|a)     add_favorite "${2}"   ;;
    remove|rm) remove_favorite "${2}";;
    list|l)    list_favorites        ;;
    html|h)    generate_html         ;;
    set)       set_background "${2}" ;;
    random|r)  random_pic            ;;
    locate|lo) locate_file           ;;
    search|s)  fuzzy_search "${2}"   ;;
    thumb|t)   show_thumbnail "${2}" ;;
    *)
      echo "â•­â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
â”‚ ä½¿ç”¨æ–¹æ³•: ${0##*/} [command]
â”‚ å¯ç”¨å‘½ä»¤:
â”‚  add    / a   æ·»åŠ å½“å‰èƒŒæ™¯åˆ°æ”¶è—
â”‚  remove / rm  åˆ é™¤æ”¶è—
â”‚  list   / l   æ˜¾ç¤ºæ”¶è—åˆ—è¡¨
â”‚  html   / h   ç”ŸæˆHTMLç›¸å†Œ
â”‚  set          è®¾ç½®æŒ‡å®šå›¾ç‰‡ä¸ºèƒŒæ™¯
â”‚  random / r   éšæœºåˆ‡æ¢èƒŒæ™¯
â”‚  locate / lo  åœ¨Finderä¸­å®šä½æ–‡ä»¶
â”‚  search / s   æ¨¡ç³Šæœç´¢å›¾ç‰‡
â”‚  thumb  / t   æ˜¾ç¤ºç¼©ç•¥å›¾
â•°â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€" | lolcat -f -F 0.05
      ;;
  esac
}

main "$@"