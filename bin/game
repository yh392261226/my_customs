#!/usr/bin/env bash
###############################
# Desc: 游戏脚本
# Author: 杨浩
# Date: 2021-08-22
###############################
#颜色值
RED='\033[31m'
BLUE='\033[34m'
END='\033[0m'

[[ -f $MYRUNTIME/customs/my_shell/library/core/bzsh/core_common.bzsh ]] && source $MYRUNTIME/customs/my_shell/library/core/bzsh/core_common.bzsh
custom_gum_show2hide_header "游戏脚本"

function lottery() {
    if [ "$1" = "" ]; then
        echo "╭──────────────────────────────────────────────────────────────────────────────────────── -- - ･
│ 使用方法: ${0##*/} lottery / l [command(可用命令)]
╰──────────────────────────────────────────────────────────────────────────────────────── -- - ･" | lolcat -f -F 0.05
echo "╭──────────────────────────────────────────────────────────────────────────────────────── -- - ･
│ command(可用命令):
│  ssq   双色球 [生成数量 | history]    查看历史记录使用 history
│  dlt   大乐透 [生成数量 | history]    查看历史记录使用 history
╰──────────────────────────────────────────────────────────────────────────────────────── -- - ･" | lolcat -f -F 0.05
        return
    fi
    
    # 设置默认注数
    local count=1
    if [ "$2" != "" ] && [ "$2" != "history" ]; then
        count="$2"
    fi
    
    case "$1" in
        'ssq'|'doubleball')
            if [ "$2" = "history" ]; then
                python3 -c "
import requests
import json
import random

EXPECT_KEYS = {'expect', 'code', 'issue'}
NUMBER_KEYS = {'opencode', 'number', 'openCode'}

def fetch_history(lottery_type, limit=10):
    url = f'https://api.huiniao.top/interface/home/lotteryHistory?type={lottery_type}&limit={limit}'
    resp = requests.get(url, timeout=10)
    resp.raise_for_status()
    raw = resp.json()

    data_outer = raw.get('data') or {}
    nested = data_outer.get('data') or {}
    items = nested.get('list') or []

    if not isinstance(items, list) or not items:
        raise RuntimeError('未获取到 list 格式的历史开奖数据，请检查 API 接口返回')

    history = []
    for item in items:
        if not isinstance(item, dict):
            continue

        code = item.get('code') or item.get('issue') or item.get('expect')

        numbers = []
        for key in sorted(item.keys()):
            if key.isalpha() and len(key) <= 5:
                val = item.get(key)
                if isinstance(val, (int, str)) and str(val).isdigit():
                    numbers.append(int(val))

        if len(numbers) >= 6:
            history.append({'code': code, 'results': numbers})

        if len(history) >= limit:
            break

    if not history:
        raise RuntimeError('解析后历史开奖数据为空，请检查 API 返回格式')

    return history

def show_ssq_history(history):
    print('双色球近10期开奖记录：')
    print('=' * 40)
    for idx, h in enumerate(history):
        reds = h['results'][:6]
        blue = h['results'][6] if len(h['results']) > 6 else '?'
        reds_str = ' '.join(f'{x:02d}' for x in reds)
        print(f'第{idx+1:2d}期 {h[\"code\"]}: {reds_str} + {blue:02d}')

hist = fetch_history('ssq', limit=10)
show_ssq_history(hist)
"
            else
                python3 -c "
import requests
import json
import random

EXPECT_KEYS = {'expect', 'code', 'issue'}
NUMBER_KEYS = {'opencode', 'number', 'openCode'}

def fetch_history(lottery_type, limit=50):
    url = f'https://api.huiniao.top/interface/home/lotteryHistory?type={lottery_type}&limit={limit}'
    resp = requests.get(url, timeout=10)
    resp.raise_for_status()
    raw = resp.json()

    data_outer = raw.get('data') or {}
    nested = data_outer.get('data') or {}
    items = nested.get('list') or []

    if not isinstance(items, list) or not items:
        raise RuntimeError('未获取到 list 格式的历史开奖数据，请检查 API 接口返回')

    history = []
    for item in items:
        if not isinstance(item, dict):
            continue

        code = item.get('code') or item.get('issue') or item.get('expect')

        numbers = []
        for key in sorted(item.keys()):
            if key.isalpha() and len(key) <= 5:
                val = item.get(key)
                if isinstance(val, (int, str)) and str(val).isdigit():
                    numbers.append(int(val))

        if len(numbers) >= 5:
            history.append({'code': code, 'results': numbers})

        if len(history) >= limit:
            break

    if not history:
        raise RuntimeError('解析后历史开奖数据为空，请检查 API 返回格式')

    return history

def build_weights(numbers, history, avoid_recent=2):
    weight = {n: 10 for n in numbers}
    last_seen = {n: None for n in numbers}

    for idx, h in enumerate(history):
        for n in h['results']:
            if n in last_seen and last_seen[n] is None:
                last_seen[n] = idx + 1

    for n, gap in last_seen.items():
        if gap is None:
            weight[n] += 5
        else:
            if gap <= avoid_recent:
                weight[n] *= 0.2
            elif gap <= 5:
                weight[n] *= 0.6
            if gap >= 12:
                weight[n] += 4
            elif gap >= 8:
                weight[n] += 2

    return {k: max(1, int(v)) for k, v in weight.items()}

def weighted_choice(numbers, weights, k):
    pool = []
    for n in numbers:
        pool.extend([n] * weights[n])
    return sorted(random.sample(pool, k))

def generate_ssq(history, count):
    reds = list(range(1, 34))
    blues = list(range(1, 17))

    red_history = [{'code': h['code'], 'results': h['results'][:6]} for h in history]

    for _ in range(count):
        w_red = build_weights(reds, red_history)
        chosen_red = weighted_choice(reds, w_red, 6)
        chosen_blue = random.choice(blues)
        print(f'双色球: {' '.join(f'{x:02d}' for x in chosen_red)} + {chosen_blue:02d}')

hist = fetch_history('ssq', limit=50)
generate_ssq(hist, $count)
"
            fi
        ;;
        'dlt'|'lotto')
            if [ "$2" = "history" ]; then
                python3 -c "
import requests
import json
import random

EXPECT_KEYS = {'expect', 'code', 'issue'}
NUMBER_KEYS = {'opencode', 'number', 'openCode'}

def fetch_history(lottery_type, limit=10):
    url = f'https://api.huiniao.top/interface/home/lotteryHistory?type={lottery_type}&limit={limit}'
    resp = requests.get(url, timeout=10)
    resp.raise_for_status()
    raw = resp.json()

    data_outer = raw.get('data') or {}
    nested = data_outer.get('data') or {}
    items = nested.get('list') or []

    if not isinstance(items, list) or not items:
        raise RuntimeError('未获取到 list 格式的历史开奖数据，请检查 API 接口返回')

    history = []
    for item in items:
        if not isinstance(item, dict):
            continue

        code = item.get('code') or item.get('issue') or item.get('expect')

        numbers = []
        for key in sorted(item.keys()):
            if key.isalpha() and len(key) <= 5:
                val = item.get(key)
                if isinstance(val, (int, str)) and str(val).isdigit():
                    numbers.append(int(val))

        if len(numbers) >= 7:
            history.append({'code': code, 'results': numbers})

        if len(history) >= limit:
            break

    if not history:
        raise RuntimeError('解析后历史开奖数据为空，请检查 API 返回格式')

    return history

def show_dlt_history(history):
    print('大乐透近10期开奖记录：')
    print('=' * 40)
    for idx, h in enumerate(history):
        front = h['results'][:5]
        back = h['results'][5:7]
        front_str = ' '.join(f'{x:02d}' for x in front)
        back_str = ' '.join(f'{x:02d}' for x in back)
        print(f'第{idx+1:2d}期 {h[\"code\"]}: {front_str} + {back_str}')

hist = fetch_history('dlt', limit=10)
show_dlt_history(hist)
"
            else
                python3 -c "
import requests
import json
import random

EXPECT_KEYS = {'expect', 'code', 'issue'}
NUMBER_KEYS = {'opencode', 'number', 'openCode'}

def fetch_history(lottery_type, limit=50):
    url = f'https://api.huiniao.top/interface/home/lotteryHistory?type={lottery_type}&limit={limit}'
    resp = requests.get(url, timeout=10)
    resp.raise_for_status()
    raw = resp.json()

    data_outer = raw.get('data') or {}
    nested = data_outer.get('data') or {}
    items = nested.get('list') or []

    if not isinstance(items, list) or not items:
        raise RuntimeError('未获取到 list 格式的历史开奖数据，请检查 API 接口返回')

    history = []
    for item in items:
        if not isinstance(item, dict):
            continue

        code = item.get('code') or item.get('issue') or item.get('expect')

        numbers = []
        for key in sorted(item.keys()):
            if key.isalpha() and len(key) <= 5:
                val = item.get(key)
                if isinstance(val, (int, str)) and str(val).isdigit():
                    numbers.append(int(val))

        if len(numbers) >= 5:
            history.append({'code': code, 'results': numbers})

        if len(history) >= limit:
            break

    if not history:
        raise RuntimeError('解析后历史开奖数据为空，请检查 API 返回格式')

    return history

def build_weights(numbers, history, avoid_recent=2):
    weight = {n: 10 for n in numbers}
    last_seen = {n: None for n in numbers}

    for idx, h in enumerate(history):
        for n in h['results']:
            if n in last_seen and last_seen[n] is None:
                last_seen[n] = idx + 1

    for n, gap in last_seen.items():
        if gap is None:
            weight[n] += 5
        else:
            if gap <= avoid_recent:
                weight[n] *= 0.2
            elif gap <= 5:
                weight[n] *= 0.6
            if gap >= 12:
                weight[n] += 4
            elif gap >= 8:
                weight[n] += 2

    return {k: max(1, int(v)) for k, v in weight.items()}

def weighted_choice(numbers, weights, k):
    pool = []
    for n in numbers:
        pool.extend([n] * weights[n])
    return sorted(random.sample(pool, k))

def generate_dlt(history, count):
    front = list(range(1, 36))
    back = list(range(1, 13))

    front_history = [{'code': h['code'], 'results': h['results'][:5]} for h in history]
    back_history = [{'code': h['code'], 'results': h['results'][5:]} for h in history]

    for _ in range(count):
        w_front = build_weights(front, front_history)
        chosen_front = weighted_choice(front, w_front, 5)

        w_back = build_weights(back, back_history)
        chosen_back = weighted_choice(back, w_back, 2)

        print(
            f'大乐透: {' '.join(f'{x:02d}' for x in chosen_front)} + {' '.join(f'{x:02d}' for x in chosen_back)}'
        )

hist = fetch_history('dlt', limit=50)
generate_dlt(hist, $count)
"
            fi
        ;;
        *)
            echo "错误: 不支持的命令 '$1'"
            echo "支持的命令: ssq (双色球), dlt (大乐透)"
            echo "使用 history 参数查看历史开奖记录"
            return 1
        ;;
    esac
}

function websites() {
    BROWSER="/Applications/Brave Browser.app"
    [[ ! -d $BROWSER ]] && BROWSER="/Applications/Google Chrome.app"
    [[ ! -d $BROWSER ]] && BROWSER="/Applications/Safari.app"
    TMPCAOFILE=$MYRUNTIME/tools/m_cao
    [[ ! -f $TMPCAOFILE ]] && touch $TMPCAOFILE
    
    function open() {
        if [ ""  = "$(cat $TMPCAOFILE)" ]; then
            echo "It's empty in websites records !!!"
            exit 0
        fi
        
        choose=$(cat $TMPCAOFILE | fzf $FZF_CUSTOM_PARAMS)
        if [[ $choose ]]; then
          for url in $(echo $choose); do
            /usr/bin/open -a "$BROWSER" "$url"
          done
        fi
    }
    
    function record() {
        vim $TMPCAOFILE
    }
    
    function list() {
        bat $TMPCAOFILE
    }
    
    if [ "$1" = "" ]; then
        echo "╭──────────────────────────────────────────────────────────────────────────────────────── -- - ･
│ 使用方法: ${0##*/} web / w [command(可用命令)]
╰──────────────────────────────────────────────────────────────────────────────────────── -- - ･" | lolcat -f -F 0.05
echo "╭──────────────────────────────────────────────────────────────────────────────────────── -- - ･
│ command(可用命令):
│  open   / o   选择
│  record / r   记录
│  list   / l   列表
╰──────────────────────────────────────────────────────────────────────────────────────── -- - ･" | lolcat -f -F 0.05
        return
    fi
    
    case "$1" in
        'o'|'open')
            open
        ;;
        'r'|'record')
            record
        ;;
        'l'|'list')
            list
        ;;
    esac
}

function sehuatang() {
    if [ "$1" = "" ]; then
        echo "Please Type The Url ..."
        return
    fi
    local TMPHTMLPATH=/tmp/first_html.log
    local HOSTURL='https://www.sehuatang.net/'
    local RECORDPATH=$HOME/Documents/novels/
    
    echo "Spider Working ..."
    rm -f $TMPHTMLPATH
    curl -s $1 > $TMPHTMLPATH
    if [ -f $TMPHTMLPATH ] && [ "" != "$(cat $TMPHTMLPATH)" ]; then
        local bookname=$(cat $TMPHTMLPATH |grep 'xs3 xw1'|sed 's,<a href="" class="xs3 xw1">,,g' |sed 's,</a>,,g')
        local menus=$(cat $TMPHTMLPATH|grep -E "='book-(.*).html"|sed "s,<a\ class=\"pure-menu-link\"\ href=\',,g" |sed "s,</a>,,g")
        if [ "" != "$menus" ]; then
            local tmp_links=$(echo $menus|sed 's, ,\n,g'|awk -F"'" '{print $1}')
            local tmp_titles=$(echo $menus|sed 's, ,\n,g'|awk -F'>' '{print $2}')
            if [ "" != "$tmp_links" ]; then
                local count=1
                for link in $tmp_links; do
                    links[$count]=$link
                    ((count++))
                done
                local count=1
                for title in $tmp_titles; do
                    titles[$count]=$title
                    ((count++))
                done
                
                local count=1
                echo ${bookname} > "${RECORDPATH}${bookname}.txt"
                for page in ${links[@]}; do
                    echo "" >> "${RECORDPATH}${bookname}.txt"
                    content=$(curl -s $HOSTURL$page |grep 'messagecontent">' |sed 's,<div class="messagecontent">,,g'| sed 's,<br>,,g' |sed 's,&nbsp;,,g' |sed 's, ,,g' |sed 's,<div>,,g'|sed 's,</div>,,g'|sed 's,<p>,,g'|sed 's,</p>,,g')
                    echo "${titles[$count]}" >> "${RECORDPATH}${bookname}.txt"
                    echo "  $content" >> "${RECORDPATH}${bookname}.txt"
                    ((count++))
                done
                echo "Done ..."
                return 0
            fi
        fi
    fi
    return
}


if [ "$#" -lt "1" ]; then
    echo "╭──────────────────────────────────────────────────────────────────────────────────────── -- - ･
│ 使用方法: ${0##*/} [command(可用命令)]
╰──────────────────────────────────────────────────────────────────────────────────────── -- - ･" | lolcat -f -F 0.05
echo "╭──────────────────────────────────────────────────────────────────────────────────────── -- - ･
│ command(可用命令):
│  lottery / l   彩票
│  web     / w   网站
╰──────────────────────────────────────────────────────────────────────────────────────── -- - ･" | lolcat -f -F 0.05
fi

case "$1" in
    'l'|'lottery')
        lottery $2 $3 $4
    ;;
    'w'|'web')
        websites $2 $3
    ;;
    
    'novel'|'n')
        if [ -f $2 ]; then
            for content in $(cat $2); do
                sehuatang "$content"
            done
        else
            sehuatang $2
        fi
    ;;
esac
