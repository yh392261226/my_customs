#!/usr/bin/env bash
### Desc:ä¸‹è½½å°è¯´åŠç®¡ç†å°è¯´
### Date:2025-08-19


[[ -f $MYRUNTIME/customs/my_shell/library/core/bzsh/core_common.bzsh ]] && source $MYRUNTIME/customs/my_shell/library/core/bzsh/core_common.bzsh

NOVELSPATH=$(cat $HOME/.novelspath)
NOVELSDATAPATH=${NOVELSPATH}/datas
OPENBROWSER='Brave Browser'

[[ "" = "$NOVELSPATH" ]] && echo "Novels path does not set ..." && exit 1
[[ ! -d "$NOVELSPATH" ]] && mkdir -p $NOVELSPATH

function novels_read() {
    custom_gum_show2hide_header "å°è¯´é˜…è¯»åˆ—è¡¨"
    local choose=$(ls $NOVELSDATAPATH/ | awk -v dir="$current_dir" '
                { print }
                END { print "â†©ï¸ è¿”å›" }
            ' | fzf +m $FZF_CUSTOM_PARAMS --preview="$MYRUNTIME/customs/bin/_previewer $NOVELSDATAPATH/{}")
    if [[ "$choose" == "â†©ï¸ è¿”å›" ]]; then
        return
    elif [ "" != "$choose" ]; then
        local options=(
            "ç»ˆç«¯é˜…è¯»"
            "æµè§ˆå™¨é˜…è¯»"
            "â†©ï¸ è¿”å›"
        )
        local choose_reader=$(printf '%s\n' "${options[@]}" | fzf \
            --ansi \
            --height=40% \
            --reverse \
            --prompt="â¤ ä¸»èœå• > " \
            --header="è¯·é€‰æ‹©é˜…è¯»å™¨" \
            --color="header:" \
            --preview="echo -e '\næŒ‰ Enter é€‰æ‹©é˜…è¯»å™¨'"
        )
        case "$choose_reader" in
            *ç»ˆç«¯é˜…è¯»*)
                # å¦‚æœæ˜¯å…¶ä»–å‘½ä»¤æˆ–è„šæœ¬å¼•å…¥çš„å°±ä½¿ç”¨greaderæ¥é˜…è¯»
                if [ ! -z $1 ] && [ "$1" = "source" ]; then
                    $MYRUNTIME/customs/bin/ureader --mode tui $NOVELSDATAPATH/$choose
                else # å¦åˆ™ä½¿ç”¨å…¨åŠŸèƒ½çš„readeræ¥é˜…è¯»
                    $MYRUNTIME/customs/bin/ureader $NOVELSDATAPATH/$choose
                fi
                ;;
            *æµè§ˆå™¨é˜…è¯»*)
                open -a "$OPENBROWSER" "$NOVELSDATAPATH/$choose"
                ;;
            *)
                return
                ;;
        esac
    fi
}

function __clean_url() {
    local url="$1"
    [ -z "$url" ] && echo "" && return
    
    # å»é™¤å¼€å¤´çš„åè®®å’Œå†’å·
    url=${url#http://}
    url=${url#https://}
    url=${url#http:}
    url=${url#https:}
    url=${url#:}
    
    # å»é™¤ç»“å°¾çš„æ–œæ ï¼ˆé€’å½’ç§»é™¤ç›´åˆ°æ²¡æœ‰ç»“å°¾æ–œæ ï¼‰
    while [ -n "$url" ] && [ "${url%"${url#?}"}" = '/' ]; do
        url=${url%/}
    done
    
    echo "$url"
}

function novels_web_manager() {
    custom_gum_show2hide_header "å°è¯´ç½‘ç«™ç®¡ç†"
    local novelsmark=$MYRUNTIME/tools/m_novels_mark
    [[ ! -f $novelsmark ]] && touch $novelsmark

    builtin cd $NOVELSPATH

    local url=$(cat "$novelsmark" | awk -v dir="$current_dir" '
                { print }
                END { print "â†©ï¸ è¿”å›" }
            ' | fzf \
    +m \
    --delimiter='#' \
    --with-nth=1 \
    --header="ğŸŒ é€‰æ‹©ç½‘å€ (å•é€‰) [${header%%#*}]" \
    --preview='echo "{1}\n{2}"' \
    --preview-window="right:70%:wrap" \
	--height=95% \
    --bind="ctrl-y:execute-silent(printf '%s' {2} | pbcopy)+abort" \
    --bind="ctrl-e:execute(nvim \"$novelsmark\" < /dev/tty > /dev/tty)+reload(cat \"$novelsmark\")" \
    --bind="ctrl-o:execute(open -a \"$OPENBROWSER\" {2})+abort" \
    --bind="ctrl-h:change-preview-label( â•¢ Help Infomation â•Ÿ )+preview($MYRUNTIME/customs/bin/web help)+show-preview" \
    --header-first \
    --footer="Ctrl-Y å¤åˆ¶ | Ctrl-E ç¼–è¾‘ | Ctrl-O æµè§ˆå™¨æ‰“å¼€ç½‘å€ | Ctrl-h å¸®åŠ©" \
    --prompt="â¤ " | \
    awk -F'#' '{print $2}')
    
    [[ -z "$url" ]] && return
    local cleanname=$(__clean_url $url)
    local options=(
        "ç¼–è¾‘å°è¯´Ids"
        "æ‰“å¼€ç½‘å€"
        "æ‰§è¡Œä¸‹è½½"
        "ç¼–è¾‘ä¸‹è½½è„šæœ¬"
        "â†©ï¸ è¿”å›"
    )
    while true; do
        selected=${1-$(printf '%s\n' "${options[@]}" | fzf \
            --ansi \
            --height=40% \
            --reverse \
            --prompt="â¤ ä¸»èœå• > " \
            --header="è¯·é€‰æ‹©åŠŸèƒ½æ¨¡å—" \
            --color="header:" \
            --preview="echo -e '\næŒ‰ Enter é€‰æ‹©åŠŸèƒ½æ¨¡å—'"
        )}
        case "$selected" in
            *ç¼–è¾‘å°è¯´Ids*)
                custom_gum_show2hide_header "ç¼–è¾‘å°è¯´Ids"
                # ç”¨codeæˆ–nvim
                nvim ${cleanname}/${cleanname}ids.log
                ;;
            *æ‰“å¼€ç½‘å€*)
                custom_gum_show2hide_header "æ‰“å¼€ç½‘å€"
                open -a "$OPENBROWSER" $url
                ;;
            *æ‰§è¡Œä¸‹è½½*)
                custom_gum_show2hide_header "æ‰§è¡Œä¸‹è½½"
                cd ${cleanname} && bash ${cleanname}.multype.sh
                ;;
            *ç¼–è¾‘ä¸‹è½½è„šæœ¬*)
                custom_gum_show2hide_header "ç¼–è¾‘ä¸‹è½½è„šæœ¬"
                code ${cleanname}/
                ;;
            *)
                return
                ;;
        esac
    done
    builtin cd -
}

function novels_help() {
    custom_gum_show2hide_header "å¸®åŠ©"
    echo "â•­â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ -- - ï½¥
â”‚ ä½¿ç”¨æ–¹æ³•: ${0##*/} [command(å¯ç”¨å‘½ä»¤)]
â•°â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ -- - ï½¥" | lolcat -f -F 0.05
    echo "â•­â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ -- - ï½¥
â”‚ ä½¿ç”¨æ–¹æ³•: ${0##*/} [command]
â”‚ command(å¯ç”¨å‘½ä»¤):
â”‚  statistics      / s   ç»Ÿè®¡æ•°é‡åŠç£ç›˜å ç”¨é‡
â”‚  choose          / c   å°è¯´é˜…è¯»åˆ—è¡¨
â”‚  directory       / d   æ‰“å¼€å°è¯´æ–‡ä»¶å¤¹
â”‚  web             / w   å°è¯´ç½‘ç«™ç®¡ç†
â”‚  help            / h   å¸®åŠ©
â•°â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ -- - ï½¥" | lolcat -f -F 0.05
}

options=(
    "ç»Ÿè®¡æ•°é‡åŠç£ç›˜å ç”¨é‡"
    "æ‰“å¼€å°è¯´æ–‡ä»¶å¤¹"
    "å°è¯´é˜…è¯»åˆ—è¡¨"
    "å°è¯´ç½‘ç«™ç®¡ç†"
    "å¸®åŠ©"
    "â†©ï¸ è¿”å›"
)

selected=${1-$(printf '%s\n' "${options[@]}" | fzf \
        --ansi \
        --height=40% \
        --reverse \
        --prompt="â¤ ä¸»èœå• > " \
        --header="è¯·é€‰æ‹©åŠŸèƒ½æ¨¡å—" \
        --color="header:" \
        --preview="echo -e '\næŒ‰ Enter é€‰æ‹©åŠŸèƒ½æ¨¡å—'"
    )}
if [ ! -z "$2" ] && [ "$2" = "source" ]; then
	[[ -z "$selected" ]] && break
	[[ $selected =~ è¿”å› ]] && break
fi
case "$selected" in
    "statistics" | "s" | *ç»Ÿè®¡æ•°é‡åŠç£ç›˜å ç”¨é‡*)
        custom_gum_show2hide_header "ç»Ÿè®¡æ•°é‡åŠç£ç›˜å ç”¨é‡"
        echo "Novels Num:"
        ls $NOVELSPATH/ | wc -l
        echo "Novels Size:"
        /usr/bin/du -sh $NOVELSPATH | awk '{print $1}'
        ;;
    "directory" | "d" | *æ‰“å¼€å°è¯´æ–‡ä»¶å¤¹*)
        custom_gum_show2hide_header "æ‰“å¼€å°è¯´æ–‡ä»¶å¤¹"
        open $NOVELSPATH
        ;;
    "choose" | "c" | *å°è¯´é˜…è¯»åˆ—è¡¨*)
        novels_read "$2"
        ;;
    "web" | "w" | *å°è¯´ç½‘ç«™ç®¡ç†*)
        novels_web_manager
        ;;
    "help" | "h" | *å¸®åŠ©*)
        novels_help
        ;;
    *è¿”å›* | *)
        if [ ! -z "$2" ] && [ "$2" = "source" ]; then
            break
            return
        fi
        ;;
esac
