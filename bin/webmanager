#!/usr/bin/env bash
### Desc: 网址管理器: 通过向网址目录增加以_websites.log结尾的文件名自动形成网址管理

WEBSITELOGS="$MYRUNTIME/tools/websites"
OPENBROWSER="/Applications/Safari.app"
tmp_iterm=""
tmp_action="list"
LOGARR=()
[[ ! -d $WEBSITELOGS ]] && mkdir -p $WEBSITELOGS
TMPLOGS=$(ls $WEBSITELOGS | grep '.*_websites.log' | sed 's/_websites.log//g')

[[ -f $MYRUNTIME/customs/my_shell/library/functions/bzsh/func_browser.bzsh ]] && source $MYRUNTIME/customs/my_shell/library/functions/bzsh/func_browser.bzsh
[[ -n "$1" ]] && tmp_iterm=$1
[[ -n "$2" ]] && tmp_action=$2

function list() {
    [[ -z "$1" ]] && return
    local WEBSITES=$1
    if [ ! -s "$WEBSITES" ]; then
        echo "It's empty in websites records !!!"
        exit 0
    fi
    choose=$(cat $WEBSITES | fzf $FZF_CUSTOM_PARAMS \
    --preview 'echo {}' \
    --bind 'focus:transform-preview-label:echo -n "[ {} ]";' \
    --header $'CTRL-Y 复制内容 | CTRL-/ 切换预览窗口 | CTRL-S 切换排序 \n| CTRL-N 下翻页 | CTRL-P 上翻页' \
    --header-first --header-lines=1)
    if [[ -n $choose ]]; then
        for url in $choose; do
            /usr/bin/open -a "$OPENBROWSER" "$url"
        done
    fi
}

for iterm in $TMPLOGS; do
    LOGARR+=("$iterm")
done

function help() {
    echo "''''''''''''''''''''''''''''''''''''''''"
    echo "Command: webmanager"
    echo "  Iterm:(\$1)"
    for ((i=0; i<${#LOGARR[@]}; i++)); do
        echo "      $(/usr/bin/head -n 1 $WEBSITELOGS/${LOGARR[i]}_websites.log)"
    done
    echo "      create 创建新记录"
    echo "      dir    打开目录"
    echo ""
    echo "  Action:(\$2)"
    echo "      edit|e|add|a 编辑记录"
    echo "      help|e       帮助信息"
    echo "      list         列出记录"
    echo "      cat          显示记录"
    echo "      filename     配合create创建文件"
    echo "Eg.:"
    echo "  webmanager soft list"
    echo ""
    echo "''''''''''''''''''''''''''''''''''''''''"
}

if [[ "${LOGARR[*]}" =~ "$tmp_iterm" ]]; then
    if [[ -f $WEBSITELOGS/${tmp_iterm}_websites.log ]]; then
        WEBSITES="$WEBSITELOGS/${tmp_iterm}_websites.log"
    else
        help
        exit 0
    fi
elif [[ "create" = "$tmp_iterm" ]]; then
    touch $WEBSITELOGS/${tmp_action}_websites.log
    nvim $WEBSITELOGS/${tmp_action}_websites.log
elif [[ "dir" = "$tmp_iterm" ]]; then
    echo "$WEBSITELOGS"
    builtin cd $WEBSITELOGS && exa .
else
    help
    exit 0
fi

case "$tmp_action" in
    "e"|"edit"|"a"|"add")
        nvim $WEBSITES
    ;;
    "c"|"cat")
        if [ "command -v ccat" = "" ]; then
            cat $WEBSITES
        else
            ccat $WEBSITES
        fi
    ;;
    "h"|"help")
        help
        exit 0
    ;;
    *)
        list $WEBSITES
    ;;
esac