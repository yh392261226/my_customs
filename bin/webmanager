#!/usr/bin/env bash
### Desc: 网址管理器

LEARNWEBSITES=$MYRUNTIME/tools/learnning_websites.log
SOFTWEBSITES=$MYRUNTIME/tools/software_websites.log
BROWSER="/Applications/Safari.app"
tmp_iterm="soft"
tmp_action="list"
[[ -f $MYRUNTIME/customs/my_shell/library/functions/bzsh/func_browser.bzsh ]] && source $MYRUNTIME/customs/my_shell/library/functions/bzsh/func_browser.bzsh
[[ "" != "$1" ]] && tmp_iterm=$1
[[ "" != "$2" ]] && tmp_action=$2

function list() {
    if [ ""  = "$(cat $WEBSITES)" ]; then
        echo "It's empty in websites records !!!"
        exit 0
    fi
    choose=$(cat $WEBSITES | fzf --reverse \
--margin=1 \
--padding=1 \
--toggle-sort=ctrl-s \
--preview-window bottom:6:border-rounded:hidden:wrap \
--scrollbar '▌▐' \
--preview ' echo {} ' \
--preview-label-pos top,4 \
--preview-label='[ 查找 ]' \
--prompt='查找 > ' \
--bind 'ctrl-/:toggle-preview' \
--bind 'focus:transform-preview-label:echo -n "[ {} ]";' \
--bind 'ctrl-y:execute-silent(echo -n {}| pbcopy)+abort' \
--bind 'ctrl-n:page-down,ctrl-p:page-up' \
--header $'CTRL-Y 复制内容 | CTRL-/ 切换预览窗口 | CTRL-S 切换排序 \n| CTRL-N 下翻页 | CTRL-P 上翻页' \
--header-first ) 
    if [[ $choose ]]; then
        for url in $(echo $choose); do
          /usr/bin/open -a "$BROWSER" "$url"
        done
        #/usr/bin/open -a "$BROWSER" "$choose"
        #chrome "$choose"
    fi
}

function help() {
    echo "''''''''''''''''''''''''''''''''''''''''"
    echo "Command: webmanager"
    echo "  Iterm:(1)"
    echo "      soft 软件网址管理"
    echo "      learn 学习网址管理"
    echo "  Action:(2)"
    echo "      edit|e|add|a 编辑记录"
    echo "      help|e       帮助信息"
    echo "Eg.:"
    echo "  webmanager soft list"
    echo "  webmanager learn list"
    echo ""
    echo "''''''''''''''''''''''''''''''''''''''''"
}

case $tmp_iterm in
    "soft")
        WEBSITES=$SOFTWEBSITES
    ;;
    "learn")
        WEBSITES=$LEARNWEBSITES
    ;;
    *)
        help
        exit 0
    ;;
esac

if [ ! -f $WEBSITES ]; then
    [[ ! -d $(dirname $WEBSITES) ]] && mkdir -p $(dirname $WEBSITES)
    touch $WEBSITES
fi

case $tmp_action in
    "e"|"edit"|"a"|"add")
        nvim $WEBSITES
    ;;
    "h"|"help")
        help
        exit 0
    ;;
    *)
        list
    ;;
esac