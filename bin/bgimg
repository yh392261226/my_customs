#!/bin/bash
## Desc: 在iterm背景图管理
## Author: 杨浩

clear
if [ $# -lt 1 ]; then
  echo "-------------------------------------------------"
  echo "----Features:"
  echo "-------------------------------------------------"
  echo "Manage the background image of iterm2."
  echo ""
  echo "-------------------------------------------------"
  echo "----Usage:"
  echo "-------------------------------------------------"
  echo "$(basename $0) [cat/c [name [image file path]]] [rm/remove/r [image file path]] [thumb/print/p [image file path [width*height]]] [open/locate/o/l [image file path]] "
  exit 1
else
  bgfile=$(sed s/[[:space:]]//g $MYRUNTIME/tools/current_picturename)
  if [ ! -f "$bgfile" ]; then
    echo "No background set or does not exists at the current time!";exit 1
  fi

  option=$1
  case "$option" in
    "cat"|"c")
      if [ "$2" != "" ]; then
        if [ "$2" = "name" ]; then
          echo $bgfile
        else
          $HOME/.iterm2/imgcat $2
        fi
      else
        $HOME/.iterm2/imgcat $bgfile
      fi
    ;;
    "rm"|"remove"|"r")
      if [ "$2" != "" ]; then
        trash $2
      else
        trash $bgfile
      fi
    ;;
    "thumb"|"print"|"p")
      if [ "$2" != "" ]; then
        if [ "$3" != "" ]; then
          width=$(echo $3 | awk -F'X|x|*' '{print $1}' | sed 's/%/%%/g')
          height=$(echo $3 | awk -F'X|x|*' '{print $2}' | sed 's/%/%%/g')
          printf '\033]1337;File=inline=1;width='$width';height='$height'preserveAspectRatio=0'
        else
          printf '\033]1337;File=inline=1;width=30%%;preserveAspectRatio=0'
        fi
        printf ":"
        base64 < "$2"
        printf '\a\n'
      else
        printf '\033]1337;File=inline=1;width=20%%;preserveAspectRatio=0'
        printf ":"
        base64 < "$bgfile"
        printf '\a\n'
      fi
    ;;
    "open"|"o"|"locate"|"l")
      if [ "$2" != "" ]; then
        /usr/bin/open -R $2
      else
        /usr/bin/open -R $bgfile
      fi
    ;;
  esac
fi
