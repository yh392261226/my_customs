#!/usr/bin/env bash

# æç®€ç‰ˆå‘½ä»¤æŸ¥æ‰¾å·¥å…·
# ç”¨æ³•: cmdinfo <command>
[[ -f $MYRUNTIME/customs/my_shell/library/core/bzsh/core_common.bzsh ]] && source $MYRUNTIME/customs/my_shell/library/core/bzsh/core_common.bzsh
custom_gum_show2hide_header "æç®€ç‰ˆå‘½ä»¤æŸ¥æ‰¾å·¥å…·"

if [[ -z "$1" ]]; then
    echo "Usage: ${0##*/} <command>" | lolcat -f -F 0.05
    
else

cmd="$1"

	# åˆ›å»ºä¸´æ—¶å‡½æ•°æ¥æ•è·ç¯å¢ƒ
	capture_environment() {
		{
			echo "#!/usr/bin/env bash"
			echo "echo '===== WHICH ====='"
			echo "which '$cmd' 2>/dev/null || echo 'No which found'"
			echo "echo"
			echo "echo '===== TYPE ====='"
			echo "type '$cmd' 2>/dev/null || echo 'No type found'"
			echo "echo"
			echo "echo '===== ALIASES ====='"
			echo "alias '$cmd' 2>/dev/null || echo 'No alias found'"
			echo "echo"
			echo "echo '===== FUNCTIONS ====='"
			echo "declare -f '$cmd' 2>/dev/null || echo 'No function found'"
			echo "echo"
			echo "echo '===== EXECUTABLES ====='"
			echo "command -v -a '$cmd' 2>/dev/null || echo 'No executable found'"
			echo "echo"
			echo "echo '===== MAN PAGES ====='"
			echo "man -w '$cmd' 2>/dev/null || echo 'No man page found'"
			echo "echo"
			echo "echo '===== BREW INFO ====='"
			echo "if command -v brew &>/dev/null; then"
			echo "  brew_path=\"\$(brew --prefix)/bin/$cmd\""
			echo "  if [[ -x \"\$brew_path\" ]]; then"
			echo "    echo \"Homebrew command: \$brew_path\""
			echo "  else"
			echo "    echo 'No Homebrew command found'"
			echo "  fi"
			echo "else"
			echo "  echo 'Homebrew not installed'"
			echo "fi"
		} > "/tmp/cmdinfo_$$.sh"
		chmod +x "/tmp/cmdinfo_$$.sh"
	}

	# ä¸»å‡½æ•°
	main() {
		# æ£€æµ‹æ˜¯å¦ä»¥sourceæ–¹å¼è¿è¡Œ
		if [[ ${BASH_SOURCE[0]} != "$0" ]]; then
			# ä»¥sourceæ–¹å¼è¿è¡Œ - ç›´æ¥è·å–ä¿¡æ¯
			echo "ğŸ” Analyzing command: $cmd (full environment access)" | lolcat -f -F 0.05
			echo "===== ALIASES =====" | lolcat -f -F 0.05
			alias "$cmd" 2>/dev/null || echo "â— No alias found"
			echo '===== FUNCTIONS =====' | lolcat -f -F 0.05
			declare -f "$cmd" 2>/dev/null || echo "â— No function found"
			echo '===== WHICH =====' | lolcat -f -F 0.05
			which "$cmd" 2>/dev/null || echo "â— No which found"
			echo '===== TYPE =====' | lolcat -f -F 0.05
			type "$cmd" 2>/dev/null || echo "â— No type found"
		else
			# ç›´æ¥è¿è¡Œ - ä½¿ç”¨ä¸´æ—¶è„šæœ¬
			echo "ğŸ” Analyzing command: $cmd" | lolcat -f -F 0.05
			capture_environment
			source "/tmp/cmdinfo_$$.sh"
			rm -f "/tmp/cmdinfo_$$.sh"
		fi

		# å…¶ä»–æ£€æµ‹ï¼ˆåœ¨æ‰€æœ‰æ¨¡å¼ä¸‹éƒ½æœ‰æ•ˆï¼‰
		echo "â— Executable paths:" | lolcat -f -F 0.05
		command -v -a "$cmd" 2>/dev/null || echo "  No executable found" | lolcat -f -F 0.05
		
		echo "â— Man page:" | lolcat -f -F 0.05
		man -w "$cmd" 2>/dev/null || echo "  No man page found" | lolcat -f -F 0.05
	}

	main
fi