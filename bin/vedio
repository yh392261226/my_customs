#!/usr/bin/env bash

### Desc:ä¸‹è½½è§†é¢‘åŠæ‰“å¼€è§†é¢‘æ–‡ä»¶å¤¹
### Author:yh392261226
### Date:2023-06-14
[[ -f $MYRUNTIME/customs/my_shell/library/core/bzsh/core_common.bzsh ]] && source $MYRUNTIME/customs/my_shell/library/core/bzsh/core_common.bzsh
VEDIOPATH=$(cat $HOME/.vediopath)
DOWNAPP="/Applications/Downie 4.app"

[[ "" = "$VEDIOPATH" ]] && echo "Vedio path does not set ..." && exit 1
[[ ! -d "$VEDIOPATH" ]] && mkdir -p $VEDIOPATH

if [ ! -d "$DOWNAPP" ]; then
    echo "Does not have App Downie !"
    exit 0
fi

function openVedio() {
    custom_gum_show2hide_header "è§†é¢‘åˆ—è¡¨"
    local choose=$(ls $VEDIOPATH | awk -v dir="$current_dir" '
                { print }
                END { print "â†©ï¸ è¿”å›" }
            ' | fzf +m $FZF_CUSTOM_PARAMS --preview="$MYRUNTIME/customs/bin/_previewer $VEDIOPATH/{}")
    if [[ "$choose" == "â†©ï¸ è¿”å›" ]]; then
        return
    elif [ "" != "$choose" ]; then
        /usr/bin/open $VEDIOPATH/$choose
    fi
}

function vedio_web_manager() {
    custom_gum_show2hide_header "è§†é¢‘ç½‘ç«™ç®¡ç†"
    local vediomark=$MYRUNTIME/tools/m_vedio_mark
    [[ ! -f $vediomark ]] && touch $vediomark
    urls=$(cat "$vediomark" | awk -v dir="$current_dir" '
                { print }
                END { print "â†©ï¸ è¿”å›" }
            ' | fzf \
    --multi \
    --delimiter='#' \
    --with-nth=1 \
    --header="ğŸŒ é€‰æ‹©ç½‘å€ (Tabå¤šé€‰) [${header%%#*}]" \
    --preview='echo "{1}\n{2}"' \
    --preview-window="right:70%:wrap" \
	--height=95% \
    --bind="ctrl-y:execute-silent(printf '%s' {2} | pbcopy)+abort" \
    --bind="ctrl-e:execute(nvim \"$vediomark\" < /dev/tty > /dev/tty)+reload(cat \"$vediomark\")" \
    --bind="ctrl-o:execute(open -R \"$vediomark\")+abort" \
    --bind="ctrl-h:change-preview-label( â•¢ Help Infomation â•Ÿ )+preview($MYRUNTIME/customs/bin/web help)+show-preview" \
    --header-first \
    --footer="Ctrl-Y å¤åˆ¶ | Ctrl-E ç¼–è¾‘ | Ctrl-O æ‰“å¼€æ‰€åœ¨ä½ç½® | Ctrl-h å¸®åŠ©" \
    --prompt="â¤ " | \
    awk -F'#' '{print $2}')
    
    [[ -z "$urls" ]] && return
    local OPENBROWSER='Brave Browser'
    while read -r url; do
        [[ -n "$url" ]] && open -a "$OPENBROWSER" "$url"
    done <<< "$urls"
}

function ofen_used_soft_manager() {
    local ofenmark=$MYRUNTIME/tools/m_ofen_used_soft
    [[ ! -f $ofenmark ]] && touch $ofenmark

    custom_gum_show2hide_header "å¸¸ç”¨è½¯ä»¶ç®¡ç†"
    
    local selection=$(cat $ofenmark | awk -v dir="$FZF_CURRENT_DIR" '
            { print }
            END { print "ğŸ”™ è¿”å›" }
        ' | fzf --reverse \
            --bind="ctrl-o:execute(open {})+abort" \
            --bind="ctrl-e:execute(nvim \"$ofenmark\" < /dev/tty > /dev/tty)+reload(cat \"$ofenmark\" | awk -v dir=\"$FZF_CURRENT_DIR\" '
            { print }
            END { print \"ğŸ”™ è¿”å›\" }
        ')" \
            --prompt="â¤ å¸¸ç”¨è½¯ä»¶ç®¡ç† > ")
    [[ -z "$selection" ]] && return
    [[ "$selection" = "ğŸ”™ è¿”å›" ]] && return
    while read -r selected; do
        [[ -n $selected ]] && open "$selected"
    done <<< $selection
}

function vedio_help() {
    custom_gum_show2hide_header "å¸®åŠ©"
    echo "â•­â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ -- - ï½¥
â”‚ ä½¿ç”¨æ–¹æ³•: ${0##*/} [command(å¯ç”¨å‘½ä»¤)]
â•°â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ -- - ï½¥" | lolcat -f -F 0.05
    echo "â•­â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ -- - ï½¥
â”‚ ä½¿ç”¨æ–¹æ³•: ${0##*/} [command]
â”‚ command(å¯ç”¨å‘½ä»¤):
â”‚  statistics      / s   ç»Ÿè®¡æ•°é‡åŠç£ç›˜å ç”¨é‡
â”‚  tools           / t   å¸¸ç”¨è½¯ä»¶
â”‚  choose          / c   è§†é¢‘åˆ—è¡¨
â”‚  directory       / d   æ‰“å¼€è§†é¢‘æ–‡ä»¶å¤¹
â”‚  web             / w   è§†é¢‘ç½‘å€
â”‚  help            / h   å¸®åŠ©
â•°â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ -- - ï½¥" | lolcat -f -F 0.05
}

options=(
    "ç»Ÿè®¡æ•°é‡åŠç£ç›˜å ç”¨é‡"
    "å¸¸ç”¨è½¯ä»¶"
    "è§†é¢‘åˆ—è¡¨"
    "æ‰“å¼€è§†é¢‘æ–‡ä»¶å¤¹"
    "è§†é¢‘ç½‘å€"
    "å¸®åŠ©"
    "â†©ï¸ è¿”å›"
)

while true; do
    selected=${1-$(printf '%s\n' "${options[@]}" | fzf \
            --ansi \
            --height=40% \
            --reverse \
            --prompt="â¤ ä¸»èœå• > " \
            --header="è¯·é€‰æ‹©åŠŸèƒ½æ¨¡å—" \
            --color="header:" \
            --preview="echo -e '\næŒ‰ Enter é€‰æ‹©åŠŸèƒ½æ¨¡å—'"
        )}

    [[ -z "$selected" ]] && break
    [[ $selected =~ è¿”å› ]] && break
    case "$selected" in
        "statistics" | "s" | *ç»Ÿè®¡æ•°é‡åŠç£ç›˜å ç”¨é‡*)
            custom_gum_show2hide_header "ç»Ÿè®¡æ•°é‡åŠç£ç›˜å ç”¨é‡"
            echo "Vedio Num:"
            ls $VEDIOPATH/ | wc -l
            echo "Vedio Size:"
            /usr/bin/du -sh $VEDIOPATH | awk '{print $1}'
            ;;
        "tools" | "t" | *å¸¸ç”¨è½¯ä»¶*)
            ofen_used_soft_manager
            ;;
        "directory" | "d" | *æ‰“å¼€è§†é¢‘æ–‡ä»¶å¤¹*)
            custom_gum_show2hide_header "æ‰“å¼€è§†é¢‘æ–‡ä»¶å¤¹"
            open $VEDIOPATH
            ;;
        "choose" | "c" | *è§†é¢‘åˆ—è¡¨*)
            openVedio
            ;;
        "web" | "w" | *è§†é¢‘ç½‘å€*)
            vedio_web_manager
            ;;
        "help" | "h" | *å¸®åŠ©*)
            vedio_help
            ;;
        *)
            break
            ;;
    esac
done